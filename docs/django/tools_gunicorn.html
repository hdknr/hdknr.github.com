

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Gunicorn &mdash; Django Cheat 1 documentation</title>
    
    <link rel="stylesheet" href="static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="static/jquery.js"></script>
    <script type="text/javascript" src="static/underscore.js"></script>
    <script type="text/javascript" src="static/doctools.js"></script>
    <script type="text/javascript" src="static/theme_extras.js"></script>
    <link rel="top" title="Django Cheat 1 documentation" href="index.html" />
    <link rel="up" title="Django Tools" href="tools.html" />
    <link rel="next" title="Django Advanced" href="advanced.html" />
    <link rel="prev" title="apache:mod_wsgi" href="tools_modwsgi.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="index.html">
          <span>Django Cheat 1 documentation</span></a></h1>
        <h2 class="heading"><span>Gunicorn</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a href="/">Home</a>:
        «&#160;&#160;<a href="tools_modwsgi.html">apache:mod_wsgi</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="advanced.html">Django Advanced</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="gunicorn">
<h1>Gunicorn<a class="headerlink" href="#gunicorn" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#id1" id="id10">概要</a></li>
<li><a class="reference internal" href="#upstart" id="id11">upstart</a></li>
<li><a class="reference internal" href="#supervisor" id="id12">supervisor</a><ul>
<li><a class="reference internal" href="#id4" id="id13">supervisorの設定ファイル</a></li>
<li><a class="reference internal" href="#supervisorupstart" id="id14">supervisorのupstart起動ファイル</a></li>
<li><a class="reference internal" href="#id5" id="id15">supervisorの起動</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id6" id="id16">Gunicorn</a><ul>
<li><a class="reference internal" href="#id7" id="id17">インストール</a></li>
<li><a class="reference internal" href="#id8" id="id18">サイトの設定ファイル</a></li>
<li><a class="reference internal" href="#id9" id="id19">supervisorでの起動ファイル</a></li>
</ul>
</li>
<li><a class="reference internal" href="#http" id="id20">HTTPサーバーの設定</a><ul>
<li><a class="reference internal" href="#apache-mod-proxy" id="id21">apache mod_proxy</a><ul>
<li><a class="reference internal" href="#httpd-conf" id="id22">仮想サーバーのhttpd.conf</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id1">
<h2><a class="toc-backref" href="#id10">概要</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://gunicorn.org/">http://gunicorn.org/</a></li>
<li>Gunicorn + WSGI で Djangoをホストします</li>
<li>Gunicornのプロセス起動を supervisord で行います</li>
<li>supervisord自体はupstartでデーモン管理します。</li>
</ul>
</div>
<div class="section" id="upstart">
<span id="id2"></span><h2><a class="toc-backref" href="#id11">upstart</a><a class="headerlink" href="#upstart" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://upstart.ubuntu.com/">http://upstart.ubuntu.com/</a></li>
<li><a class="reference external" href="https://ja.wikipedia.org/wiki/Upstart">https://ja.wikipedia.org/wiki/Upstart</a></li>
</ul>
<p>Debianパッケージでインストール</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># aptitude remove sysvinit</span>
<span class="c"># aptitude install upstart</span>
</pre></div>
</div>
<p>sysvinit の起動スクリプトは upstartが提供する/etc/init/rc.conf で起動されます。</p>
<p>sysvinit前提でインストールされた起動スクリプトも継続して使えます</p>
<div class="highlight-python"><pre># /etc/init.d/apache2 stop

Stopping web server: apache2 ... waiting .</pre>
</div>
</div>
<div class="section" id="supervisor">
<span id="id3"></span><h2><a class="toc-backref" href="#id12">supervisor</a><a class="headerlink" href="#supervisor" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://supervisord.org/index.html">http://supervisord.org/index.html</a></li>
<li>PYPIからインストールします。</li>
</ul>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo pip install supervisor
</pre></div>
</div>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id13">supervisorの設定ファイル</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference external" href="http://supervisord.org/configuration.html">http://supervisord.org/configuration.html</a></li>
</ul>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>echo_supervisord_conf  | sudo tee -a /etc/supervisord.conf
<span class="nv">$ </span>sudo vim /etc/supervisord.conf
</pre></div>
</div>
<p>設定ファイル例:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>grep -v <span class="s2">&quot;^;&quot;</span> /etc/supervisord.conf | grep -v <span class="s2">&quot;^$&quot;</span>
</pre></div>
</div>
<div class="highlight-python"><pre>[unix_http_server]
file=/var/run/supervisor.sock
[supervisord]
logfile=/var/log/supervisor/supervisord.log
logfile_maxbytes=50MB        ; (max main logfile bytes b4 rotation;default 50MB)
logfile_backups=10           ; (num of main logfile rotation backups;default 10)
loglevel=info                ; (log level;default info; others: debug,warn,trace)
pidfile=/var/run/supervisord.pid ; (supervisord pidfile;default supervisord.pid)
nodaemon=false               ; (start in foreground if true;default false)
minfds=1024                  ; (min. avail startup file descriptors;default 1024)
minprocs=200                 ; (min. avail process descriptors;default 200)
[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface
[supervisorctl]
serverurl=unix:///var/run/supervisor.sock               ; unix:// URL for a Unix socket
[include]
files = /etc/supervisord.conf.d/*.ini</pre>
</div>
</div>
<div class="section" id="supervisorupstart">
<h3><a class="toc-backref" href="#id14">supervisorのupstart起動ファイル</a><a class="headerlink" href="#supervisorupstart" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>vim /etc/init/supervisord.conf
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre>description <span class="s2">&quot;supervisord&quot;</span>

start on runlevel <span class="o">[</span>2345<span class="o">]</span>
stop on runlevel <span class="o">[</span>!2345<span class="o">]</span>

respawn
script
   <span class="nb">exec</span> /usr/local/bin/supervisord -n -c /etc/supervisord.conf
end script
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id15">supervisorの起動</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo initctl reload-configuration
<span class="nv">$ </span>sudo initctl list  | grep super

supervisord stop/waiting

<span class="nv">$ </span>sudo initctl start supervisord

supervisord start/running, process 2268
</pre></div>
</div>
<p>ログで確認( /etc/supervisord.confにログファイル設定されている)</p>
<div class="highlight-python"><pre>$ sudo more /var/log/supervisor/supervisord.log

2013-06-25 10:57:14,153 CRIT Supervisor running as root (no user in config file)
2013-06-25 10:57:14,205 INFO RPC interface 'supervisor' initialized
2013-06-25 10:57:14,205 CRIT Server 'unix_http_server' running without any HTTP authentication checking
2013-06-25 10:57:14,205 INFO supervisord started with pid 2268</pre>
</div>
<p>ソケット,PIDファイル</p>
<div class="highlight-python"><pre>$ ls -l /var/run/supervisor*

srwx------ 1 root root 0  6月 25 10:57 /var/run/supervisor.sock
-rw-r--r-- 1 root root 5  6月 25 10:57 /var/run/supervisord.pid</pre>
</div>
<p>プロセス</p>
<div class="highlight-python"><pre>$ ps ax | grep supervisor

 2268 ?        Ss     0:00 /usr/bin/python /usr/local/bin/supervisord -n -c /etc/supervisord.conf</pre>
</div>
</div>
</div>
<div class="section" id="id6">
<h2><a class="toc-backref" href="#id16">Gunicorn</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Djangoのサイトを同じvirtualenvにインストールする</li>
</ul>
<div class="section" id="id7">
<h3><a class="toc-backref" href="#id17">インストール</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>pip install gunicorn
<span class="nv">$ </span>pip install setproctitle
</pre></div>
</div>
</div>
<div class="section" id="id8">
<h3><a class="toc-backref" href="#id18">サイトの設定ファイル</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference external" href="http://docs.gunicorn.org/en/latest/configure.html">http://docs.gunicorn.org/en/latest/configure.html</a></li>
</ul>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ls app/settings.py
app/settings.py

<span class="nv">$ </span>vim gunicorn.conf.py
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c"># for Gunicorn to find app.wsgi:application</span>
<span class="c">#</span>
<span class="n">DIR</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span> <span class="n">__file__</span> <span class="p">)</span> <span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">DIR</span> <span class="p">)</span>

<span class="c"># logs directory</span>
<span class="c">#</span>
<span class="n">LOGS</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DIR</span><span class="p">,</span><span class="s">&#39;logs&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span> <span class="n">LOGS</span> <span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span> <span class="n">LOGS</span> <span class="p">)</span>

<span class="c"># Gunicorn Configuration</span>
<span class="c">#</span>
<span class="n">bind</span> <span class="o">=</span> <span class="s">&quot;127.0.0.1:8000&quot;</span>
<span class="n">accesslog</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">LOGS</span><span class="p">,</span><span class="s">&quot;gunicorn.access.log&quot;</span><span class="p">)</span>
<span class="n">errorlog</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">LOGS</span><span class="p">,</span><span class="s">&quot;gunicorn.error.log&quot;</span><span class="p">)</span>
<span class="n">proc_name</span><span class="o">=</span><span class="s">&quot;mysite&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h3><a class="toc-backref" href="#id19">supervisorでの起動ファイル</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>起動コマンドをsupervisordに登録します</p>
<div class="highlight-python"><pre>$ sudo vim /etc/supervisord.conf.d/mysite.ini</pre>
</div>
<div class="highlight-python"><pre>[program:mysite]
command=/home/system/ve/dev/bin/gunicorn -c /home/system/ve/dev/src/mysite/gunicorn.conf.py  app.wsgi:application
;directory=/opt/www/memo
user=system
autostart=true
autorestart=true
redirect_stderr=true
;environment=PYTHON_EGG_CACHE=/opt/www/memo/.python-eggs</pre>
</div>
<div class="highlight-python"><pre>$ sudo supervisorctl reread
mysite: available

$ sudo  supervisorctl add ikkiweb
mysite: added process group

$ lsof -i:8000

COMMAND    PID   USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
gunicorn: 2300 system    8u  IPv4   9961      0t0  TCP localhost:8000 (LISTEN)
gunicorn: 2305 system    8u  IPv4   9961      0t0  TCP localhost:8000 (LISTEN)


$ ps ax | grep mysite

2300 ?        S      0:00 gunicorn: master [mysite]
2305 ?        S      0:00 gunicorn: worker [mysite]</pre>
</div>
</div>
</div>
<div class="section" id="http">
<h2><a class="toc-backref" href="#id20">HTTPサーバーの設定</a><a class="headerlink" href="#http" title="Permalink to this headline">¶</a></h2>
<div class="section" id="apache-mod-proxy">
<h3><a class="toc-backref" href="#id21">apache mod_proxy</a><a class="headerlink" href="#apache-mod-proxy" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>$ sudo a2enmod proxy
$ sudo a2enmod proxy_http</pre>
</div>
<div class="highlight-python"><pre>$ sudo aptitude install libapache2-mod-macro
$ sudo a2enmod macro</pre>
</div>
<div class="section" id="httpd-conf">
<h4><a class="toc-backref" href="#id22">仮想サーバーのhttpd.conf</a><a class="headerlink" href="#httpd-conf" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>サイトまるごとGunicornのワーカーに食わせる例</li>
<li>スタティックファイルをapacheに処理させるためにProxyに例外を登録すること</li>
</ul>
<div class="highlight-xml"><pre>&lt;Macro Resource&gt;
    ServerAdmin webmaster@localhost
    ProxyPreserveHost On

    #: python manage.py collectstatic goes to assets
    Alias /assets /home/system/ve/dev/src/mysite/app/assets

    &lt;Location /assets &gt;
        #: Exclude Proxy
        ProxyPass !
    &lt;/Location&gt;

   &lt;Location / &gt;
        ProxyPass http://127.0.0.1:8000/
        ProxyPassReverse http://127.0.0.1:8000/
   &lt;/Location&gt;

    LogLevel warn
    ErrorLog  /home/system/server/apache2/mysite/logs/error.log
    CustomLog /home/system/server/apache2/mysite/logs/access.log combined
&lt;/Macro&gt;

&lt;Macro Certs&gt;
    SSLEngine on
    SSLCertificateChainFile /root/ssl/dvcacert.cer
    SSLCertificateFile /root/ssl/mysite.crt
    SSLCertificateKeyFile /root/ssl/mysite.key
&lt;/Macro&gt;

&lt;VirtualHost *:80&gt;
   Use Resource
&lt;/VirtualHost&gt;

&lt;VirtualHost *:443&gt;
   Use Resource
   Use Certs
&lt;/VirtualHost&gt;</pre>
</div>
</div>
</div>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        <a href="/">Home</a>:
        «&#160;&#160;<a href="tools_modwsgi.html">apache:mod_wsgi</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="advanced.html">Django Advanced</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2012, HDKNR.COM.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>