

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>django.contrib.gis.geos.libgeos &mdash; Django Cheat 1 documentation</title>
    
    <link rel="stylesheet" href="../../../../../static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../../static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../static/doctools.js"></script>
    <script type="text/javascript" src="../../../../../static/theme_extras.js"></script>
    <link rel="top" title="Django Cheat 1 documentation" href="../../../../../index.html" />
    <link rel="up" title="Module code" href="../../../../index.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../../../../../index.html">
          <span>Django Cheat 1 documentation</span></a></h1>
        <h2 class="heading"><span>django.contrib.gis.geos.libgeos</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a href="/">Home</a>:
        <a class="uplink" href="../../../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for django.contrib.gis.geos.libgeos</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd"> This module houses the ctypes initialization procedures, as well</span>
<span class="sd"> as the notice and error handler function callbacks (get called</span>
<span class="sd"> when an error occurs in GEOS).</span>

<span class="sd"> This module also houses GEOS Pointer utilities, including</span>
<span class="sd"> get_pointer_arr(), and GEOM_PTR.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">c_char_p</span><span class="p">,</span> <span class="n">Structure</span><span class="p">,</span> <span class="n">CDLL</span><span class="p">,</span> <span class="n">CFUNCTYPE</span><span class="p">,</span> <span class="n">POINTER</span>
<span class="kn">from</span> <span class="nn">ctypes.util</span> <span class="kn">import</span> <span class="n">find_library</span>
<span class="kn">from</span> <span class="nn">django.contrib.gis.geos.error</span> <span class="kn">import</span> <span class="n">GEOSException</span>

<span class="c"># Custom library path set?</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
    <span class="n">lib_path</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">GEOS_LIBRARY_PATH</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">EnvironmentError</span><span class="p">,</span> <span class="ne">ImportError</span><span class="p">):</span>
    <span class="n">lib_path</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c"># Setting the appropriate names for the GEOS-C library.</span>
<span class="k">if</span> <span class="n">lib_path</span><span class="p">:</span>
    <span class="n">lib_names</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;nt&#39;</span><span class="p">:</span>
    <span class="c"># Windows NT libraries</span>
    <span class="n">lib_names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;geos_c&#39;</span><span class="p">,</span> <span class="s">&#39;libgeos_c-1&#39;</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;posix&#39;</span><span class="p">:</span>
    <span class="c"># *NIX libraries</span>
    <span class="n">lib_names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;geos_c&#39;</span><span class="p">,</span> <span class="s">&#39;GEOS&#39;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s">&#39;Unsupported OS &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<span class="c"># Using the ctypes `find_library` utility to find the path to the GEOS</span>
<span class="c"># shared library.  This is better than manually specifiying each library name</span>
<span class="c"># and extension (e.g., libgeos_c.[so|so.1|dylib].).</span>
<span class="k">if</span> <span class="n">lib_names</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">lib_name</span> <span class="ow">in</span> <span class="n">lib_names</span><span class="p">:</span>
        <span class="n">lib_path</span> <span class="o">=</span> <span class="n">find_library</span><span class="p">(</span><span class="n">lib_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lib_path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">break</span>

<span class="c"># No GEOS library could be found.</span>
<span class="k">if</span> <span class="n">lib_path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s">&#39;Could not find the GEOS library (tried &quot;</span><span class="si">%s</span><span class="s">&quot;). &#39;</span>
                        <span class="s">&#39;Try setting GEOS_LIBRARY_PATH in your settings.&#39;</span> <span class="o">%</span>
                        <span class="s">&#39;&quot;, &quot;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lib_names</span><span class="p">))</span>

<span class="c"># Getting the GEOS C library.  The C interface (CDLL) is used for</span>
<span class="c"># both *NIX and Windows.</span>
<span class="c"># See the GEOS C API source code for more details on the library function calls:</span>
<span class="c">#  http://geos.refractions.net/ro/doxygen_docs/html/geos__c_8h-source.html</span>
<span class="n">lgeos</span> <span class="o">=</span> <span class="n">CDLL</span><span class="p">(</span><span class="n">lib_path</span><span class="p">)</span>

<span class="c"># The notice and error handler C function callback definitions.</span>
<span class="c"># Supposed to mimic the GEOS message handler (C below):</span>
<span class="c">#  typedef void (*GEOSMessageHandler)(const char *fmt, ...);</span>
<span class="n">NOTICEFUNC</span> <span class="o">=</span> <span class="n">CFUNCTYPE</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">c_char_p</span><span class="p">,</span> <span class="n">c_char_p</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">notice_h</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">lst</span><span class="p">,</span> <span class="n">output_h</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">warn_msg</span> <span class="o">=</span> <span class="n">fmt</span> <span class="o">%</span> <span class="n">lst</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">warn_msg</span> <span class="o">=</span> <span class="n">fmt</span>
    <span class="n">output_h</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;GEOS_NOTICE: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">warn_msg</span><span class="p">)</span>
<span class="n">notice_h</span> <span class="o">=</span> <span class="n">NOTICEFUNC</span><span class="p">(</span><span class="n">notice_h</span><span class="p">)</span>

<span class="n">ERRORFUNC</span> <span class="o">=</span> <span class="n">CFUNCTYPE</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">c_char_p</span><span class="p">,</span> <span class="n">c_char_p</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">error_h</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">lst</span><span class="p">,</span> <span class="n">output_h</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">err_msg</span> <span class="o">=</span> <span class="n">fmt</span> <span class="o">%</span> <span class="n">lst</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">err_msg</span> <span class="o">=</span> <span class="n">fmt</span>
    <span class="n">output_h</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;GEOS_ERROR: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">err_msg</span><span class="p">)</span>
<span class="n">error_h</span> <span class="o">=</span> <span class="n">ERRORFUNC</span><span class="p">(</span><span class="n">error_h</span><span class="p">)</span>

<span class="c">#### GEOS Geometry C data structures, and utility functions. ####</span>

<span class="c"># Opaque GEOS geometry structures, used for GEOM_PTR and CS_PTR</span>
<span class="k">class</span> <span class="nc">GEOSGeom_t</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">GEOSPrepGeom_t</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">GEOSCoordSeq_t</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">GEOSContextHandle_t</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span> <span class="k">pass</span>

<span class="c"># Pointers to opaque GEOS geometry structures.</span>
<span class="n">GEOM_PTR</span> <span class="o">=</span> <span class="n">POINTER</span><span class="p">(</span><span class="n">GEOSGeom_t</span><span class="p">)</span>
<span class="n">PREPGEOM_PTR</span> <span class="o">=</span> <span class="n">POINTER</span><span class="p">(</span><span class="n">GEOSPrepGeom_t</span><span class="p">)</span>
<span class="n">CS_PTR</span> <span class="o">=</span> <span class="n">POINTER</span><span class="p">(</span><span class="n">GEOSCoordSeq_t</span><span class="p">)</span>
<span class="n">CONTEXT_PTR</span>  <span class="o">=</span> <span class="n">POINTER</span><span class="p">(</span><span class="n">GEOSContextHandle_t</span><span class="p">)</span>

<span class="c"># Used specifically by the GEOSGeom_createPolygon and GEOSGeom_createCollection</span>
<span class="c">#  GEOS routines</span>
<div class="viewcode-block" id="get_pointer_arr"><a class="viewcode-back" href="../../../../../django.contrib.gis.geos.html#django.contrib.gis.geos.libgeos.get_pointer_arr">[docs]</a><span class="k">def</span> <span class="nf">get_pointer_arr</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="s">&quot;Gets a ctypes pointer array (of length `n`) for GEOSGeom_t opaque pointer.&quot;</span>
    <span class="n">GeomArr</span> <span class="o">=</span> <span class="n">GEOM_PTR</span> <span class="o">*</span> <span class="n">n</span>
    <span class="k">return</span> <span class="n">GeomArr</span><span class="p">()</span>

<span class="c"># Returns the string version of the GEOS library. Have to set the restype</span>
<span class="c"># explicitly to c_char_p to ensure compatibility accross 32 and 64-bit platforms.</span></div>
<span class="n">geos_version</span> <span class="o">=</span> <span class="n">lgeos</span><span class="o">.</span><span class="n">GEOSversion</span>
<span class="n">geos_version</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">geos_version</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">c_char_p</span>

<span class="c"># Regular expression should be able to parse version strings such as</span>
<span class="c"># &#39;3.0.0rc4-CAPI-1.3.3&#39;, or &#39;3.0.0-CAPI-1.4.1&#39;</span>
<span class="n">version_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^(?P&lt;version&gt;(?P&lt;major&gt;\d+)\.(?P&lt;minor&gt;\d+)\.(?P&lt;subminor&gt;\d+))(rc(?P&lt;release_candidate&gt;\d+))?-CAPI-(?P&lt;capi_version&gt;\d+\.\d+\.\d+)$&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="geos_version_info"><a class="viewcode-back" href="../../../../../django.contrib.gis.geos.html#django.contrib.gis.geos.libgeos.geos_version_info">[docs]</a><span class="k">def</span> <span class="nf">geos_version_info</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a dictionary containing the various version metadata parsed from</span>
<span class="sd">    the GEOS version string, including the version number, whether the version</span>
<span class="sd">    is a release candidate (and what number release candidate), and the C API</span>
<span class="sd">    version.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ver</span> <span class="o">=</span> <span class="n">geos_version</span><span class="p">()</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">version_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">ver</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span> <span class="k">raise</span> <span class="n">GEOSException</span><span class="p">(</span><span class="s">&#39;Could not parse version info string &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">ver</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">key</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;version&#39;</span><span class="p">,</span> <span class="s">&#39;release_candidate&#39;</span><span class="p">,</span> <span class="s">&#39;capi_version&#39;</span><span class="p">,</span> <span class="s">&#39;major&#39;</span><span class="p">,</span> <span class="s">&#39;minor&#39;</span><span class="p">,</span> <span class="s">&#39;subminor&#39;</span><span class="p">))</span>

<span class="c"># Version numbers and whether or not prepared geometry support is available.</span></div>
<span class="n">_verinfo</span> <span class="o">=</span> <span class="n">geos_version_info</span><span class="p">()</span>
<span class="n">GEOS_MAJOR_VERSION</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_verinfo</span><span class="p">[</span><span class="s">&#39;major&#39;</span><span class="p">])</span>
<span class="n">GEOS_MINOR_VERSION</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_verinfo</span><span class="p">[</span><span class="s">&#39;minor&#39;</span><span class="p">])</span>
<span class="n">GEOS_SUBMINOR_VERSION</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_verinfo</span><span class="p">[</span><span class="s">&#39;subminor&#39;</span><span class="p">])</span>
<span class="k">del</span> <span class="n">_verinfo</span>
<span class="n">GEOS_VERSION</span> <span class="o">=</span> <span class="p">(</span><span class="n">GEOS_MAJOR_VERSION</span><span class="p">,</span> <span class="n">GEOS_MINOR_VERSION</span><span class="p">,</span> <span class="n">GEOS_SUBMINOR_VERSION</span><span class="p">)</span>
<span class="n">GEOS_PREPARE</span> <span class="o">=</span> <span class="n">GEOS_VERSION</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">if</span> <span class="n">GEOS_PREPARE</span><span class="p">:</span>
    <span class="c"># Here we set up the prototypes for the initGEOS_r and finishGEOS_r</span>
    <span class="c"># routines.  These functions aren&#39;t actually called until they are</span>
    <span class="c"># attached to a GEOS context handle -- this actually occurs in</span>
    <span class="c"># geos/prototypes/threadsafe.py.</span>
    <span class="n">lgeos</span><span class="o">.</span><span class="n">initGEOS_r</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">CONTEXT_PTR</span>
    <span class="n">lgeos</span><span class="o">.</span><span class="n">finishGEOS_r</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">CONTEXT_PTR</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c"># When thread-safety isn&#39;t available, the initGEOS routine must be called</span>
    <span class="c"># first.  This function takes the notice and error functions, defined</span>
    <span class="c"># as Python callbacks above, as parameters. Here is the C code that is</span>
    <span class="c"># wrapped:</span>
    <span class="c">#  extern void GEOS_DLL initGEOS(GEOSMessageHandler notice_function, GEOSMessageHandler error_function);</span>
    <span class="n">lgeos</span><span class="o">.</span><span class="n">initGEOS</span><span class="p">(</span><span class="n">notice_h</span><span class="p">,</span> <span class="n">error_h</span><span class="p">)</span>
    <span class="c"># Calling finishGEOS() upon exit of the interpreter.</span>
    <span class="kn">import</span> <span class="nn">atexit</span>
    <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">lgeos</span><span class="o">.</span><span class="n">finishGEOS</span><span class="p">)</span>
</pre></div>

      </div>
      <div class="bottomnav">
      
        <p>
        <a href="/">Home</a>:
        <a class="uplink" href="../../../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2012, HDKNR.COM.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2pre/660be19d7963.
    </div>
  </body>
</html>