

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>django.contrib.gis.tests.geo3d.tests &mdash; Django Cheat 1 documentation</title>
    
    <link rel="stylesheet" href="../../../../../../static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../../static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../../static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../../../static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../../static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../../static/doctools.js"></script>
    <script type="text/javascript" src="../../../../../../static/theme_extras.js"></script>
    <link rel="top" title="Django Cheat 1 documentation" href="../../../../../../index.html" />
    <link rel="up" title="django.contrib.gis.tests" href="../../tests.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../../../../../../index.html">
          <span>Django Cheat 1 documentation</span></a></h1>
        <h2 class="heading"><span>django.contrib.gis.tests.geo3d.tests</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a href="/">Home</a>:
        <a class="uplink" href="../../../../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for django.contrib.gis.tests.geo3d.tests</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">django.utils.unittest</span> <span class="kn">import</span> <span class="n">TestCase</span>
<span class="kn">from</span> <span class="nn">django.contrib.gis.db.models</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Extent3D</span>
<span class="kn">from</span> <span class="nn">django.contrib.gis.geos</span> <span class="kn">import</span> <span class="n">GEOSGeometry</span><span class="p">,</span> <span class="n">Point</span><span class="p">,</span> <span class="n">Polygon</span>
<span class="kn">from</span> <span class="nn">django.contrib.gis.utils</span> <span class="kn">import</span> <span class="n">LayerMapping</span><span class="p">,</span> <span class="n">LayerMapError</span>

<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">City3D</span><span class="p">,</span> <span class="n">Interstate2D</span><span class="p">,</span> <span class="n">Interstate3D</span><span class="p">,</span> \
    <span class="n">InterstateProj2D</span><span class="p">,</span> <span class="n">InterstateProj3D</span><span class="p">,</span> \
    <span class="n">Point2D</span><span class="p">,</span> <span class="n">Point3D</span><span class="p">,</span> <span class="n">MultiPoint3D</span><span class="p">,</span> <span class="n">Polygon2D</span><span class="p">,</span> <span class="n">Polygon3D</span>

<span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s">&#39;..&#39;</span><span class="p">,</span> <span class="s">&#39;data&#39;</span><span class="p">))</span>
<span class="n">city_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s">&#39;cities&#39;</span><span class="p">,</span> <span class="s">&#39;cities.shp&#39;</span><span class="p">)</span>
<span class="n">vrt_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s">&#39;test_vrt&#39;</span><span class="p">,</span> <span class="s">&#39;test_vrt.vrt&#39;</span><span class="p">)</span>

<span class="c"># The coordinates of each city, with Z values corresponding to their</span>
<span class="c"># altitude in meters.</span>
<span class="n">city_data</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s">&#39;Houston&#39;</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mf">95.363151</span><span class="p">,</span> <span class="mf">29.763374</span><span class="p">,</span> <span class="mi">18</span><span class="p">)),</span>
    <span class="p">(</span><span class="s">&#39;Dallas&#39;</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mf">96.801611</span><span class="p">,</span> <span class="mf">32.782057</span><span class="p">,</span> <span class="mi">147</span><span class="p">)),</span>
    <span class="p">(</span><span class="s">&#39;Oklahoma City&#39;</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mf">97.521157</span><span class="p">,</span> <span class="mf">34.464642</span><span class="p">,</span> <span class="mi">380</span><span class="p">)),</span>
    <span class="p">(</span><span class="s">&#39;Wellington&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mf">174.783117</span><span class="p">,</span> <span class="o">-</span><span class="mf">41.315268</span><span class="p">,</span> <span class="mi">14</span><span class="p">)),</span>
    <span class="p">(</span><span class="s">&#39;Pueblo&#39;</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mf">104.609252</span><span class="p">,</span> <span class="mf">38.255001</span><span class="p">,</span> <span class="mi">1433</span><span class="p">)),</span>
    <span class="p">(</span><span class="s">&#39;Lawrence&#39;</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mf">95.235060</span><span class="p">,</span> <span class="mf">38.971823</span><span class="p">,</span> <span class="mi">251</span><span class="p">)),</span>
    <span class="p">(</span><span class="s">&#39;Chicago&#39;</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mf">87.650175</span><span class="p">,</span> <span class="mf">41.850385</span><span class="p">,</span> <span class="mi">181</span><span class="p">)),</span>
    <span class="p">(</span><span class="s">&#39;Victoria&#39;</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mf">123.305196</span><span class="p">,</span> <span class="mf">48.462611</span><span class="p">,</span> <span class="mi">15</span><span class="p">)),</span>
<span class="p">)</span>

<span class="c"># Reference mapping of city name to its altitude (Z value).</span>
<span class="n">city_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">coords</span> <span class="ow">in</span> <span class="n">city_data</span><span class="p">)</span>

<span class="c"># 3D freeway data derived from the National Elevation Dataset: </span>
<span class="c">#  http://seamless.usgs.gov/products/9arc.php</span>
<span class="n">interstate_data</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s">&#39;I-45&#39;</span><span class="p">,</span> 
     <span class="s">&#39;LINESTRING(-95.3708481 29.7765870 11.339,-95.3694580 29.7787980 4.536,-95.3690305 29.7797359 9.762,-95.3691886 29.7812450 12.448,-95.3696447 29.7850144 10.457,-95.3702511 29.7868518 9.418,-95.3706724 29.7881286 14.858,-95.3711632 29.7896157 15.386,-95.3714525 29.7936267 13.168,-95.3717848 29.7955007 15.104,-95.3717719 29.7969804 16.516,-95.3717305 29.7982117 13.923,-95.3717254 29.8000778 14.385,-95.3719875 29.8013539 15.160,-95.3720575 29.8026785 15.544,-95.3721321 29.8040912 14.975,-95.3722074 29.8050998 15.688,-95.3722779 29.8060430 16.099,-95.3733818 29.8076750 15.197,-95.3741563 29.8103686 17.268,-95.3749458 29.8129927 19.857,-95.3763564 29.8144557 15.435)&#39;</span><span class="p">,</span>
     <span class="p">(</span> <span class="mf">11.339</span><span class="p">,</span>   <span class="mf">4.536</span><span class="p">,</span>   <span class="mf">9.762</span><span class="p">,</span>  <span class="mf">12.448</span><span class="p">,</span>  <span class="mf">10.457</span><span class="p">,</span>   <span class="mf">9.418</span><span class="p">,</span>  <span class="mf">14.858</span><span class="p">,</span>
       <span class="mf">15.386</span><span class="p">,</span>  <span class="mf">13.168</span><span class="p">,</span>  <span class="mf">15.104</span><span class="p">,</span>  <span class="mf">16.516</span><span class="p">,</span>  <span class="mf">13.923</span><span class="p">,</span>  <span class="mf">14.385</span><span class="p">,</span>  <span class="mf">15.16</span> <span class="p">,</span>
       <span class="mf">15.544</span><span class="p">,</span>  <span class="mf">14.975</span><span class="p">,</span>  <span class="mf">15.688</span><span class="p">,</span>  <span class="mf">16.099</span><span class="p">,</span>  <span class="mf">15.197</span><span class="p">,</span>  <span class="mf">17.268</span><span class="p">,</span>  <span class="mf">19.857</span><span class="p">,</span>
       <span class="mf">15.435</span><span class="p">),</span>
     <span class="p">),</span>
    <span class="p">)</span>

<span class="c"># Bounding box polygon for inner-loop of Houston (in projected coordinate</span>
<span class="c"># system 32140), with elevation values from the National Elevation Dataset</span>
<span class="c"># (see above).</span>
<span class="n">bbox_wkt</span> <span class="o">=</span> <span class="s">&#39;POLYGON((941527.97 4225693.20,962596.48 4226349.75,963152.57 4209023.95,942051.75 4208366.38,941527.97 4225693.20))&#39;</span>
<span class="n">bbox_z</span> <span class="o">=</span> <span class="p">(</span><span class="mf">21.71</span><span class="p">,</span> <span class="mf">13.21</span><span class="p">,</span> <span class="mf">9.12</span><span class="p">,</span> <span class="mf">16.40</span><span class="p">,</span> <span class="mf">21.71</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">gen_bbox</span><span class="p">():</span>
    <span class="n">bbox_2d</span> <span class="o">=</span> <span class="n">GEOSGeometry</span><span class="p">(</span><span class="n">bbox_wkt</span><span class="p">,</span> <span class="n">srid</span><span class="o">=</span><span class="mi">32140</span><span class="p">)</span>
    <span class="n">bbox_3d</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="nb">tuple</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bbox_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">bbox_z</span><span class="p">)),</span> <span class="n">srid</span><span class="o">=</span><span class="mi">32140</span><span class="p">)</span>    
    <span class="k">return</span> <span class="n">bbox_2d</span><span class="p">,</span> <span class="n">bbox_3d</span>

<div class="viewcode-block" id="Geo3DTest"><a class="viewcode-back" href="../../../../../../django.contrib.gis.tests.geo3d.html#django.contrib.gis.tests.geo3d.tests.Geo3DTest">[docs]</a><span class="k">class</span> <span class="nc">Geo3DTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Only a subset of the PostGIS routines are 3D-enabled, and this TestCase</span>
<span class="sd">    tries to test the features that can handle 3D and that are also </span>
<span class="sd">    available within GeoDjango.  For more information, see the PostGIS docs</span>
<span class="sd">    on the routines that support 3D:</span>

<span class="sd">    http://postgis.refractions.net/documentation/manual-1.4/ch08.html#PostGIS_3D_Functions</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Geo3DTest.test01_3d"><a class="viewcode-back" href="../../../../../../django.contrib.gis.tests.geo3d.html#django.contrib.gis.tests.geo3d.tests.Geo3DTest.test01_3d">[docs]</a>    <span class="k">def</span> <span class="nf">test01_3d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Test the creation of 3D models.&quot;</span>
        <span class="c"># 3D models for the rest of the tests will be populated in here.</span>
        <span class="c"># For each 3D data set create model (and 2D version if necessary), </span>
        <span class="c"># retrieve, and assert geometry is in 3D and contains the expected</span>
        <span class="c"># 3D values.</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">pnt_data</span> <span class="ow">in</span> <span class="n">city_data</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">pnt_data</span>
            <span class="n">pnt</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">srid</span><span class="o">=</span><span class="mi">4326</span><span class="p">)</span>
            <span class="n">City3D</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="n">pnt</span><span class="p">)</span>
            <span class="n">city</span> <span class="o">=</span> <span class="n">City3D</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">city</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">hasz</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">city</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>

        <span class="c"># Interstate (2D / 3D and Geographic/Projected variants)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">exp_z</span> <span class="ow">in</span> <span class="n">interstate_data</span><span class="p">:</span>
            <span class="n">line_3d</span> <span class="o">=</span> <span class="n">GEOSGeometry</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">srid</span><span class="o">=</span><span class="mi">4269</span><span class="p">)</span>
            <span class="c"># Using `hex` attribute because it omits 3D.</span>
            <span class="n">line_2d</span> <span class="o">=</span> <span class="n">GEOSGeometry</span><span class="p">(</span><span class="n">line_3d</span><span class="o">.</span><span class="n">hex</span><span class="p">,</span> <span class="n">srid</span><span class="o">=</span><span class="mi">4269</span><span class="p">)</span>

            <span class="c"># Creating a geographic and projected version of the</span>
            <span class="c"># interstate in both 2D and 3D.</span>
            <span class="n">Interstate3D</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">line_3d</span><span class="p">)</span>
            <span class="n">InterstateProj3D</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">line_3d</span><span class="p">)</span>
            <span class="n">Interstate2D</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">line_2d</span><span class="p">)</span>
            <span class="n">InterstateProj2D</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">line_2d</span><span class="p">)</span>

            <span class="c"># Retrieving and making sure it&#39;s 3D and has expected</span>
            <span class="c"># Z values -- shouldn&#39;t change because of coordinate system.</span>
            <span class="n">interstate</span> <span class="o">=</span> <span class="n">Interstate3D</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="n">interstate_proj</span> <span class="o">=</span> <span class="n">InterstateProj3D</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">interstate</span><span class="p">,</span> <span class="n">interstate_proj</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">hasz</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exp_z</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">z</span><span class="p">))</span>

        <span class="c"># Creating 3D Polygon.</span>
        <span class="n">bbox2d</span><span class="p">,</span> <span class="n">bbox3d</span> <span class="o">=</span> <span class="n">gen_bbox</span><span class="p">()</span>
        <span class="n">Polygon2D</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;2D BBox&#39;</span><span class="p">,</span> <span class="n">poly</span><span class="o">=</span><span class="n">bbox2d</span><span class="p">)</span>
        <span class="n">Polygon3D</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;3D BBox&#39;</span><span class="p">,</span> <span class="n">poly</span><span class="o">=</span><span class="n">bbox3d</span><span class="p">)</span>
        <span class="n">p3d</span> <span class="o">=</span> <span class="n">Polygon3D</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;3D BBox&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">p3d</span><span class="o">.</span><span class="n">poly</span><span class="o">.</span><span class="n">hasz</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bbox3d</span><span class="p">,</span> <span class="n">p3d</span><span class="o">.</span><span class="n">poly</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Geo3DTest.test01a_3d_layermapping"><a class="viewcode-back" href="../../../../../../django.contrib.gis.tests.geo3d.html#django.contrib.gis.tests.geo3d.tests.Geo3DTest.test01a_3d_layermapping">[docs]</a>    <span class="k">def</span> <span class="nf">test01a_3d_layermapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Testing LayerMapping on 3D models.&quot;</span>
        <span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">Point2D</span><span class="p">,</span> <span class="n">Point3D</span>

        <span class="n">point_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;point&#39;</span> <span class="p">:</span> <span class="s">&#39;POINT&#39;</span><span class="p">}</span>
        <span class="n">mpoint_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;mpoint&#39;</span> <span class="p">:</span> <span class="s">&#39;MULTIPOINT&#39;</span><span class="p">}</span>

        <span class="c"># The VRT is 3D, but should still be able to map sans the Z.</span>
        <span class="n">lm</span> <span class="o">=</span> <span class="n">LayerMapping</span><span class="p">(</span><span class="n">Point2D</span><span class="p">,</span> <span class="n">vrt_file</span><span class="p">,</span> <span class="n">point_mapping</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">Point2D</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

        <span class="c"># The city shapefile is 2D, and won&#39;t be able to fill the coordinates</span>
        <span class="c"># in the 3D model -- thus, a LayerMapError is raised.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">LayerMapError</span><span class="p">,</span> <span class="n">LayerMapping</span><span class="p">,</span>
                          <span class="n">Point3D</span><span class="p">,</span> <span class="n">city_file</span><span class="p">,</span> <span class="n">point_mapping</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        
        <span class="c"># 3D model should take 3D data just fine.</span>
        <span class="n">lm</span> <span class="o">=</span> <span class="n">LayerMapping</span><span class="p">(</span><span class="n">Point3D</span><span class="p">,</span> <span class="n">vrt_file</span><span class="p">,</span> <span class="n">point_mapping</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">Point3D</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

        <span class="c"># Making sure LayerMapping.make_multi works right, by converting</span>
        <span class="c"># a Point25D into a MultiPoint25D.</span>
        <span class="n">lm</span> <span class="o">=</span> <span class="n">LayerMapping</span><span class="p">(</span><span class="n">MultiPoint3D</span><span class="p">,</span> <span class="n">vrt_file</span><span class="p">,</span> <span class="n">mpoint_mapping</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">MultiPoint3D</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="Geo3DTest.test02a_kml"><a class="viewcode-back" href="../../../../../../django.contrib.gis.tests.geo3d.html#django.contrib.gis.tests.geo3d.tests.Geo3DTest.test02a_kml">[docs]</a>    <span class="k">def</span> <span class="nf">test02a_kml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Test GeoQuerySet.kml() with Z values.&quot;</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">City3D</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">kml</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Houston&#39;</span><span class="p">)</span>
        <span class="c"># KML should be 3D.</span>
        <span class="c"># `SELECT ST_AsKML(point, 6) FROM geo3d_city3d WHERE name = &#39;Houston&#39;;`</span>
        <span class="n">ref_kml_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^&lt;Point&gt;&lt;coordinates&gt;-95.363\d+,29.763\d+,18&lt;/coordinates&gt;&lt;/Point&gt;$&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">ref_kml_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">kml</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Geo3DTest.test02b_geojson"><a class="viewcode-back" href="../../../../../../django.contrib.gis.tests.geo3d.html#django.contrib.gis.tests.geo3d.tests.Geo3DTest.test02b_geojson">[docs]</a>    <span class="k">def</span> <span class="nf">test02b_geojson</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Test GeoQuerySet.geojson() with Z values.&quot;</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">City3D</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">geojson</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Houston&#39;</span><span class="p">)</span>
        <span class="c"># GeoJSON should be 3D</span>
        <span class="c"># `SELECT ST_AsGeoJSON(point, 6) FROM geo3d_city3d WHERE name=&#39;Houston&#39;;`</span>
        <span class="n">ref_json_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^{&quot;type&quot;:&quot;Point&quot;,&quot;coordinates&quot;:\[-95.363151,29.763374,18(\.0+)?\]}$&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">ref_json_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">geojson</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Geo3DTest.test03a_union"><a class="viewcode-back" href="../../../../../../django.contrib.gis.tests.geo3d.html#django.contrib.gis.tests.geo3d.tests.Geo3DTest.test03a_union">[docs]</a>    <span class="k">def</span> <span class="nf">test03a_union</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Testing the Union aggregate of 3D models.&quot;</span>
        <span class="c"># PostGIS query that returned the reference EWKT for this test:</span>
        <span class="c">#  `SELECT ST_AsText(ST_Union(point)) FROM geo3d_city3d;`</span>
        <span class="n">ref_ewkt</span> <span class="o">=</span> <span class="s">&#39;SRID=4326;MULTIPOINT(-123.305196 48.462611 15,-104.609252 38.255001 1433,-97.521157 34.464642 380,-96.801611 32.782057 147,-95.363151 29.763374 18,-95.23506 38.971823 251,-87.650175 41.850385 181,174.783117 -41.315268 14)&#39;</span>
        <span class="n">ref_union</span> <span class="o">=</span> <span class="n">GEOSGeometry</span><span class="p">(</span><span class="n">ref_ewkt</span><span class="p">)</span>
        <span class="n">union</span> <span class="o">=</span> <span class="n">City3D</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Union</span><span class="p">(</span><span class="s">&#39;point&#39;</span><span class="p">))[</span><span class="s">&#39;point__union&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">union</span><span class="o">.</span><span class="n">hasz</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ref_union</span><span class="p">,</span> <span class="n">union</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Geo3DTest.test03b_extent"><a class="viewcode-back" href="../../../../../../django.contrib.gis.tests.geo3d.html#django.contrib.gis.tests.geo3d.tests.Geo3DTest.test03b_extent">[docs]</a>    <span class="k">def</span> <span class="nf">test03b_extent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Testing the Extent3D aggregate for 3D models.&quot;</span>
        <span class="c"># `SELECT ST_Extent3D(point) FROM geo3d_city3d;`</span>
        <span class="n">ref_extent3d</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">123.305196</span><span class="p">,</span> <span class="o">-</span><span class="mf">41.315268</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span><span class="mf">174.783117</span><span class="p">,</span> <span class="mf">48.462611</span><span class="p">,</span> <span class="mi">1433</span><span class="p">)</span>
        <span class="n">extent1</span> <span class="o">=</span> <span class="n">City3D</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Extent3D</span><span class="p">(</span><span class="s">&#39;point&#39;</span><span class="p">))[</span><span class="s">&#39;point__extent3d&#39;</span><span class="p">]</span>
        <span class="n">extent2</span> <span class="o">=</span> <span class="n">City3D</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extent3d</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">check_extent3d</span><span class="p">(</span><span class="n">extent3d</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ref_val</span><span class="p">,</span> <span class="n">ext_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ref_extent3d</span><span class="p">,</span> <span class="n">extent3d</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">ref_val</span><span class="p">,</span> <span class="n">ext_val</span><span class="p">,</span> <span class="n">tol</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">e3d</span> <span class="ow">in</span> <span class="p">[</span><span class="n">extent1</span><span class="p">,</span> <span class="n">extent2</span><span class="p">]:</span>
            <span class="n">check_extent3d</span><span class="p">(</span><span class="n">e3d</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Geo3DTest.test04_perimeter"><a class="viewcode-back" href="../../../../../../django.contrib.gis.tests.geo3d.html#django.contrib.gis.tests.geo3d.tests.Geo3DTest.test04_perimeter">[docs]</a>    <span class="k">def</span> <span class="nf">test04_perimeter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Testing GeoQuerySet.perimeter() on 3D fields.&quot;</span>
        <span class="c"># Reference query for values below:</span>
        <span class="c">#  `SELECT ST_Perimeter3D(poly), ST_Perimeter2D(poly) FROM geo3d_polygon3d;`</span>
        <span class="n">ref_perim_3d</span> <span class="o">=</span> <span class="mf">76859.2620451</span>
        <span class="n">ref_perim_2d</span> <span class="o">=</span> <span class="mf">76859.2577803</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">ref_perim_2d</span><span class="p">,</span>
                               <span class="n">Polygon2D</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">perimeter</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;2D BBox&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">perimeter</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
                               <span class="n">tol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">ref_perim_3d</span><span class="p">,</span>
                               <span class="n">Polygon3D</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">perimeter</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;3D BBox&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">perimeter</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
                               <span class="n">tol</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Geo3DTest.test05_length"><a class="viewcode-back" href="../../../../../../django.contrib.gis.tests.geo3d.html#django.contrib.gis.tests.geo3d.tests.Geo3DTest.test05_length">[docs]</a>    <span class="k">def</span> <span class="nf">test05_length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Testing GeoQuerySet.length() on 3D fields.&quot;</span>
        <span class="c"># ST_Length_Spheroid Z-aware, and thus does not need to use</span>
        <span class="c"># a separate function internally.</span>
        <span class="c"># `SELECT ST_Length_Spheroid(line, &#39;SPHEROID[&quot;GRS 1980&quot;,6378137,298.257222101]&#39;) </span>
        <span class="c">#    FROM geo3d_interstate[2d|3d];`</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">ref_length_2d</span> <span class="o">=</span> <span class="mf">4368.1721949481</span>
        <span class="n">ref_length_3d</span> <span class="o">=</span> <span class="mf">4368.62547052088</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">ref_length_2d</span><span class="p">,</span>
                               <span class="n">Interstate2D</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">length</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;I-45&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
                               <span class="n">tol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">ref_length_3d</span><span class="p">,</span>
                               <span class="n">Interstate3D</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">length</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;I-45&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
                               <span class="n">tol</span><span class="p">)</span>

        <span class="c"># Making sure `ST_Length3D` is used on for a projected</span>
        <span class="c"># and 3D model rather than `ST_Length`.</span>
        <span class="c"># `SELECT ST_Length(line) FROM geo3d_interstateproj2d;`</span>
        <span class="n">ref_length_2d</span> <span class="o">=</span> <span class="mf">4367.71564892392</span>
        <span class="c"># `SELECT ST_Length3D(line) FROM geo3d_interstateproj3d;`</span>
        <span class="n">ref_length_3d</span> <span class="o">=</span> <span class="mf">4368.16897234101</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">ref_length_2d</span><span class="p">,</span>
                               <span class="n">InterstateProj2D</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">length</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;I-45&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
                               <span class="n">tol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">ref_length_3d</span><span class="p">,</span>
                               <span class="n">InterstateProj3D</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">length</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;I-45&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
                               <span class="n">tol</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="Geo3DTest.test06_scale"><a class="viewcode-back" href="../../../../../../django.contrib.gis.tests.geo3d.html#django.contrib.gis.tests.geo3d.tests.Geo3DTest.test06_scale">[docs]</a>    <span class="k">def</span> <span class="nf">test06_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Testing GeoQuerySet.scale() on Z values.&quot;</span>
        <span class="c"># Mapping of City name to reference Z values.</span>
        <span class="n">zscales</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">23</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">zscale</span> <span class="ow">in</span> <span class="n">zscales</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">city</span> <span class="ow">in</span> <span class="n">City3D</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">zscale</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">city_dict</span><span class="p">[</span><span class="n">city</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">zscale</span><span class="p">,</span> <span class="n">city</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Geo3DTest.test07_translate"><a class="viewcode-back" href="../../../../../../django.contrib.gis.tests.geo3d.html#django.contrib.gis.tests.geo3d.tests.Geo3DTest.test07_translate">[docs]</a>    <span class="k">def</span> <span class="nf">test07_translate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Testing GeoQuerySet.translate() on Z values.&quot;</span>
        <span class="n">ztranslations</span> <span class="o">=</span> <span class="p">(</span><span class="mf">5.23</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="o">-</span><span class="mi">17</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ztrans</span> <span class="ow">in</span> <span class="n">ztranslations</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">city</span> <span class="ow">in</span> <span class="n">City3D</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ztrans</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">city_dict</span><span class="p">[</span><span class="n">city</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">ztrans</span><span class="p">,</span> <span class="n">city</span><span class="o">.</span><span class="n">translate</span><span class="o">.</span><span class="n">z</span><span class="p">)</span></div></div>
</pre></div>

      </div>
      <div class="bottomnav">
      
        <p>
        <a href="/">Home</a>:
        <a class="uplink" href="../../../../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2012, HDKNR.COM.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2pre/660be19d7963.
    </div>
  </body>
</html>