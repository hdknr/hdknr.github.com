

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>django.core.cache &mdash; Django Cheat 1 documentation</title>
    
    <link rel="stylesheet" href="../../../static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../../static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../static/jquery.js"></script>
    <script type="text/javascript" src="../../../static/underscore.js"></script>
    <script type="text/javascript" src="../../../static/doctools.js"></script>
    <script type="text/javascript" src="../../../static/theme_extras.js"></script>
    <link rel="top" title="Django Cheat 1 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../../../index.html">
          <span>Django Cheat 1 documentation</span></a></h1>
        <h2 class="heading"><span>django.core.cache</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a href="/">Home</a>:
        <a class="uplink" href="../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for django.core.cache</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Caching framework.</span>

<span class="sd">This package defines set of cache backends that all conform to a simple API.</span>
<span class="sd">In a nutshell, a cache is a set of values -- which can be any object that</span>
<span class="sd">may be pickled -- identified by string keys.  For the complete API, see</span>
<span class="sd">the abstract BaseCache class in django.core.cache.backends.base.</span>

<span class="sd">Client code should not access a cache backend directly; instead it should</span>
<span class="sd">either use the &quot;cache&quot; variable made available here, or it should use the</span>
<span class="sd">get_cache() function made available here. get_cache() takes a backend URI</span>
<span class="sd">(e.g. &quot;memcached://127.0.0.1:11211/&quot;) and returns an instance of a backend</span>
<span class="sd">cache class.</span>

<span class="sd">See docs/topics/cache.txt for information on the public API.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.core</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">django.core.cache.backends.base</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">InvalidCacheBackendError</span><span class="p">,</span> <span class="n">CacheKeyWarning</span><span class="p">,</span> <span class="n">BaseCache</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ImproperlyConfigured</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">importlib</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c"># The mod_python version is more efficient, so try importing it first.</span>
    <span class="kn">from</span> <span class="nn">mod_python.util</span> <span class="kn">import</span> <span class="n">parse_qsl</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># Python 2.6 and greater</span>
        <span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">parse_qsl</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="c"># Python 2.5, 2.4.  Works on Python 2.6 but raises</span>
        <span class="c"># PendingDeprecationWarning</span>
        <span class="kn">from</span> <span class="nn">cgi</span> <span class="kn">import</span> <span class="n">parse_qsl</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">&#39;get_cache&#39;</span><span class="p">,</span> <span class="s">&#39;cache&#39;</span><span class="p">,</span> <span class="s">&#39;DEFAULT_CACHE_ALIAS&#39;</span>
<span class="p">]</span>

<span class="c"># Name for use in settings file --&gt; name of module in &quot;backends&quot; directory.</span>
<span class="c"># Any backend scheme that is not in this dictionary is treated as a Python</span>
<span class="c"># import path to a custom backend.</span>
<span class="n">BACKENDS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;memcached&#39;</span><span class="p">:</span> <span class="s">&#39;memcached&#39;</span><span class="p">,</span>
    <span class="s">&#39;locmem&#39;</span><span class="p">:</span> <span class="s">&#39;locmem&#39;</span><span class="p">,</span>
    <span class="s">&#39;file&#39;</span><span class="p">:</span> <span class="s">&#39;filebased&#39;</span><span class="p">,</span>
    <span class="s">&#39;db&#39;</span><span class="p">:</span> <span class="s">&#39;db&#39;</span><span class="p">,</span>
    <span class="s">&#39;dummy&#39;</span><span class="p">:</span> <span class="s">&#39;dummy&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">DEFAULT_CACHE_ALIAS</span> <span class="o">=</span> <span class="s">&#39;default&#39;</span>

<span class="k">def</span> <span class="nf">parse_backend_uri</span><span class="p">(</span><span class="n">backend_uri</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts the &quot;backend_uri&quot; into a cache scheme (&#39;db&#39;, &#39;memcached&#39;, etc), a</span>
<span class="sd">    host and any extra params that are required for the backend. Returns a</span>
<span class="sd">    (scheme, host, params) tuple.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">backend_uri</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InvalidCacheBackendError</span><span class="p">(</span><span class="s">&quot;Backend URI must start with scheme://&quot;</span><span class="p">)</span>
    <span class="n">scheme</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">backend_uri</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">rest</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;//&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">InvalidCacheBackendError</span><span class="p">(</span><span class="s">&quot;Backend URI must start with scheme://&quot;</span><span class="p">)</span>

    <span class="n">host</span> <span class="o">=</span> <span class="n">rest</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">qpos</span> <span class="o">=</span> <span class="n">rest</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;?&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">qpos</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">parse_qsl</span><span class="p">(</span><span class="n">rest</span><span class="p">[</span><span class="n">qpos</span><span class="o">+</span><span class="mi">1</span><span class="p">:]))</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">rest</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">qpos</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">host</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">):</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">params</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">CACHES</span><span class="p">:</span>
    <span class="n">legacy_backend</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s">&#39;CACHE_BACKEND&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">legacy_backend</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">warnings</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s">&quot;settings.CACHE_* is deprecated; use settings.CACHES instead.&quot;</span><span class="p">,</span>
            <span class="ne">PendingDeprecationWarning</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># The default cache setting is put here so that we</span>
        <span class="c"># can differentiate between a user who has provided</span>
        <span class="c"># an explicit CACHE_BACKEND of locmem://, and the</span>
        <span class="c"># default value. When the deprecation cycle has completed,</span>
        <span class="c"># the default can be restored to global_settings.py</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">CACHE_BACKEND</span> <span class="o">=</span> <span class="s">&#39;locmem://&#39;</span>

    <span class="c"># Mapping for new-style cache backend api</span>
    <span class="n">backend_classes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;memcached&#39;</span><span class="p">:</span> <span class="s">&#39;memcached.CacheClass&#39;</span><span class="p">,</span>
        <span class="s">&#39;locmem&#39;</span><span class="p">:</span> <span class="s">&#39;locmem.LocMemCache&#39;</span><span class="p">,</span>
        <span class="s">&#39;file&#39;</span><span class="p">:</span> <span class="s">&#39;filebased.FileBasedCache&#39;</span><span class="p">,</span>
        <span class="s">&#39;db&#39;</span><span class="p">:</span> <span class="s">&#39;db.DatabaseCache&#39;</span><span class="p">,</span>
        <span class="s">&#39;dummy&#39;</span><span class="p">:</span> <span class="s">&#39;dummy.DummyCache&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">engine</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">parse_backend_uri</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">CACHE_BACKEND</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">engine</span> <span class="ow">in</span> <span class="n">backend_classes</span><span class="p">:</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="s">&#39;django.core.cache.backends.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">backend_classes</span><span class="p">[</span><span class="n">engine</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.CacheClass&#39;</span> <span class="o">%</span> <span class="n">engine</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;BACKEND&#39;</span><span class="p">:</span> <span class="n">engine</span><span class="p">,</span>
        <span class="s">&#39;LOCATION&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">CACHES</span><span class="p">[</span><span class="n">DEFAULT_CACHE_ALIAS</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaults</span>

<span class="k">if</span> <span class="n">DEFAULT_CACHE_ALIAS</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">CACHES</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s">&quot;You must define a &#39;</span><span class="si">%s</span><span class="s">&#39; cache&quot;</span> <span class="o">%</span> <span class="n">DEFAULT_CACHE_ALIAS</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_backend_conf</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function to parse the backend configuration</span>
<span class="sd">    that doesn&#39;t use the URI notation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Try to get the CACHES entry for the given backend name first</span>
    <span class="n">conf</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">CACHES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;BACKEND&#39;</span><span class="p">)</span>
        <span class="n">location</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;LOCATION&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">backend</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">args</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Trying to import the given backend, in case it&#39;s a dotted path</span>
        <span class="n">mod_path</span><span class="p">,</span> <span class="n">cls_name</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">mod_path</span><span class="p">)</span>
            <span class="n">backend_cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">cls_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ImportError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InvalidCacheBackendError</span><span class="p">(</span><span class="s">&quot;Could not find backend &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">backend</span><span class="p">)</span>
        <span class="n">location</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;LOCATION&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">backend</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">kwargs</span>
    <span class="k">raise</span> <span class="n">InvalidCacheBackendError</span><span class="p">(</span>
        <span class="s">&quot;Couldn&#39;t find a cache backend named &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">backend</span><span class="p">)</span>

<div class="viewcode-block" id="get_cache"><a class="viewcode-back" href="../../../django.core.cache.html#django.core.cache.get_cache">[docs]</a><span class="k">def</span> <span class="nf">get_cache</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to load a cache backend dynamically. This is flexible by design</span>
<span class="sd">    to allow different use cases:</span>

<span class="sd">    To load a backend with the old URI-based notation::</span>

<span class="sd">        cache = get_cache(&#39;locmem://&#39;)</span>

<span class="sd">    To load a backend that is pre-defined in the settings::</span>

<span class="sd">        cache = get_cache(&#39;default&#39;)</span>

<span class="sd">    To load a backend with its dotted import path,</span>
<span class="sd">    including arbitrary options::</span>

<span class="sd">        cache = get_cache(&#39;django.core.cache.backends.memcached.MemcachedCache&#39;, **{</span>
<span class="sd">            &#39;LOCATION&#39;: &#39;127.0.0.1:11211&#39;, &#39;TIMEOUT&#39;: 30,</span>
<span class="sd">        })</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;://&#39;</span> <span class="ow">in</span> <span class="n">backend</span><span class="p">:</span>
            <span class="c"># for backwards compatibility</span>
            <span class="n">backend</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">parse_backend_uri</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">backend</span> <span class="ow">in</span> <span class="n">BACKENDS</span><span class="p">:</span>
                <span class="n">backend</span> <span class="o">=</span> <span class="s">&#39;django.core.cache.backends.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">BACKENDS</span><span class="p">[</span><span class="n">backend</span><span class="p">]</span>
            <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span>
            <span class="n">backend_cls</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">CacheClass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">backend</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">parse_backend_conf</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">mod_path</span><span class="p">,</span> <span class="n">cls_name</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">mod_path</span><span class="p">)</span>
            <span class="n">backend_cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">cls_name</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ImportError</span><span class="p">),</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InvalidCacheBackendError</span><span class="p">(</span>
            <span class="s">&quot;Could not find backend &#39;</span><span class="si">%s</span><span class="s">&#39;: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">backend_cls</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</div>
<span class="n">cache</span> <span class="o">=</span> <span class="n">get_cache</span><span class="p">(</span><span class="n">DEFAULT_CACHE_ALIAS</span><span class="p">)</span>

<span class="c"># Some caches -- python-memcached in particular -- need to do a cleanup at the</span>
<span class="c"># end of a request cycle. If the cache provides a close() method, wire it up</span>
<span class="c"># here.</span>
<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="s">&#39;close&#39;</span><span class="p">):</span>
    <span class="n">signals</span><span class="o">.</span><span class="n">request_finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
</pre></div>

      </div>
      <div class="bottomnav">
      
        <p>
        <a href="/">Home</a>:
        <a class="uplink" href="../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2012, HDKNR.COM.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2pre/660be19d7963.
    </div>
  </body>
</html>