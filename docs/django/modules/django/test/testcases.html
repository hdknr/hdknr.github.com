

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>django.test.testcases &mdash; Django Cheat 1 documentation</title>
    
    <link rel="stylesheet" href="../../../static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../../static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../static/jquery.js"></script>
    <script type="text/javascript" src="../../../static/underscore.js"></script>
    <script type="text/javascript" src="../../../static/doctools.js"></script>
    <script type="text/javascript" src="../../../static/theme_extras.js"></script>
    <link rel="top" title="Django Cheat 1 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../../../index.html">
          <span>Django Cheat 1 documentation</span></a></h1>
        <h2 class="heading"><span>django.test.testcases</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a href="/">Home</a>:
        <a class="uplink" href="../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for django.test.testcases</h1><div class="highlight"><pre>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">difflib</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlsplit</span><span class="p">,</span> <span class="n">urlunsplit</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>     <span class="c"># Python 2</span>
    <span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">urlsplit</span><span class="p">,</span> <span class="n">urlunsplit</span>
<span class="kn">import</span> <span class="nn">select</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">errno</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.contrib.staticfiles.handlers</span> <span class="kn">import</span> <span class="n">StaticFilesHandler</span>
<span class="kn">from</span> <span class="nn">django.core</span> <span class="kn">import</span> <span class="n">mail</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="n">ImproperlyConfigured</span>
<span class="kn">from</span> <span class="nn">django.core.handlers.wsgi</span> <span class="kn">import</span> <span class="n">WSGIHandler</span>
<span class="kn">from</span> <span class="nn">django.core.management</span> <span class="kn">import</span> <span class="n">call_command</span>
<span class="kn">from</span> <span class="nn">django.core.management.color</span> <span class="kn">import</span> <span class="n">no_style</span>
<span class="kn">from</span> <span class="nn">django.core.signals</span> <span class="kn">import</span> <span class="n">request_started</span>
<span class="kn">from</span> <span class="nn">django.core.servers.basehttp</span> <span class="kn">import</span> <span class="p">(</span><span class="n">WSGIRequestHandler</span><span class="p">,</span> <span class="n">WSGIServer</span><span class="p">,</span>
    <span class="n">WSGIServerException</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="kn">import</span> <span class="n">clear_url_caches</span>
<span class="kn">from</span> <span class="nn">django.core.validators</span> <span class="kn">import</span> <span class="n">EMPTY_VALUES</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">connections</span><span class="p">,</span> <span class="n">DEFAULT_DB_ALIAS</span><span class="p">,</span>
    <span class="n">reset_queries</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">django.forms.fields</span> <span class="kn">import</span> <span class="n">CharField</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">QueryDict</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">_doctest</span> <span class="k">as</span> <span class="n">doctest</span>
<span class="kn">from</span> <span class="nn">django.test.client</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="kn">from</span> <span class="nn">django.test.html</span> <span class="kn">import</span> <span class="n">HTMLParseError</span><span class="p">,</span> <span class="n">parse_html</span>
<span class="kn">from</span> <span class="nn">django.test.signals</span> <span class="kn">import</span> <span class="n">template_rendered</span>
<span class="kn">from</span> <span class="nn">django.test.utils</span> <span class="kn">import</span> <span class="p">(</span><span class="n">get_warnings_state</span><span class="p">,</span> <span class="n">restore_warnings_state</span><span class="p">,</span>
    <span class="n">override_settings</span><span class="p">,</span> <span class="n">compare_xml</span><span class="p">,</span> <span class="n">strip_quotes</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">django.test.utils</span> <span class="kn">import</span> <span class="n">ContextList</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">unittest</span> <span class="k">as</span> <span class="n">ut2</span>
<span class="kn">from</span> <span class="nn">django.utils.encoding</span> <span class="kn">import</span> <span class="n">force_text</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">six</span>
<span class="kn">from</span> <span class="nn">django.utils.unittest.util</span> <span class="kn">import</span> <span class="n">safe_repr</span>
<span class="kn">from</span> <span class="nn">django.utils.unittest</span> <span class="kn">import</span> <span class="n">skipIf</span>
<span class="kn">from</span> <span class="nn">django.views.static</span> <span class="kn">import</span> <span class="n">serve</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;DocTestRunner&#39;</span><span class="p">,</span> <span class="s">&#39;OutputChecker&#39;</span><span class="p">,</span> <span class="s">&#39;TestCase&#39;</span><span class="p">,</span> <span class="s">&#39;TransactionTestCase&#39;</span><span class="p">,</span>
           <span class="s">&#39;SimpleTestCase&#39;</span><span class="p">,</span> <span class="s">&#39;skipIfDBFeature&#39;</span><span class="p">,</span> <span class="s">&#39;skipUnlessDBFeature&#39;</span><span class="p">)</span>

<span class="n">normalize_long_ints</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&#39;(?&lt;![\w])(\d+)L(?![\w])&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">1&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
<span class="n">normalize_decimals</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&quot;Decimal\(&#39;(\d+(\.\d*)?)&#39;\)&quot;</span><span class="p">,</span>
                                <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="s">&quot;Decimal(</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">to_list</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Puts value into a list if it&#39;s not already one.</span>
<span class="sd">    Returns an empty list if value is None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">value</span>

<span class="n">real_commit</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">commit</span>
<span class="n">real_rollback</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">rollback</span>
<span class="n">real_enter_transaction_management</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">enter_transaction_management</span>
<span class="n">real_leave_transaction_management</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">leave_transaction_management</span>
<span class="n">real_managed</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">managed</span>
<span class="n">real_abort</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">abort</span>

<span class="k">def</span> <span class="nf">nop</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">disable_transaction_methods</span><span class="p">():</span>
    <span class="n">transaction</span><span class="o">.</span><span class="n">commit</span> <span class="o">=</span> <span class="n">nop</span>
    <span class="n">transaction</span><span class="o">.</span><span class="n">rollback</span> <span class="o">=</span> <span class="n">nop</span>
    <span class="n">transaction</span><span class="o">.</span><span class="n">enter_transaction_management</span> <span class="o">=</span> <span class="n">nop</span>
    <span class="n">transaction</span><span class="o">.</span><span class="n">leave_transaction_management</span> <span class="o">=</span> <span class="n">nop</span>
    <span class="n">transaction</span><span class="o">.</span><span class="n">managed</span> <span class="o">=</span> <span class="n">nop</span>
    <span class="n">transaction</span><span class="o">.</span><span class="n">abort</span> <span class="o">=</span> <span class="n">nop</span>

<span class="k">def</span> <span class="nf">restore_transaction_methods</span><span class="p">():</span>
    <span class="n">transaction</span><span class="o">.</span><span class="n">commit</span> <span class="o">=</span> <span class="n">real_commit</span>
    <span class="n">transaction</span><span class="o">.</span><span class="n">rollback</span> <span class="o">=</span> <span class="n">real_rollback</span>
    <span class="n">transaction</span><span class="o">.</span><span class="n">enter_transaction_management</span> <span class="o">=</span> <span class="n">real_enter_transaction_management</span>
    <span class="n">transaction</span><span class="o">.</span><span class="n">leave_transaction_management</span> <span class="o">=</span> <span class="n">real_leave_transaction_management</span>
    <span class="n">transaction</span><span class="o">.</span><span class="n">managed</span> <span class="o">=</span> <span class="n">real_managed</span>
    <span class="n">transaction</span><span class="o">.</span><span class="n">abort</span> <span class="o">=</span> <span class="n">real_abort</span>


<span class="k">def</span> <span class="nf">assert_and_parse_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span><span class="p">,</span> <span class="n">user_msg</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dom</span> <span class="o">=</span> <span class="n">parse_html</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">HTMLParseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">standardMsg</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatMessage</span><span class="p">(</span><span class="n">user_msg</span><span class="p">,</span> <span class="n">standardMsg</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dom</span>


<span class="k">class</span> <span class="nc">OutputChecker</span><span class="p">(</span><span class="n">doctest</span><span class="o">.</span><span class="n">OutputChecker</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">check_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">want</span><span class="p">,</span> <span class="n">got</span><span class="p">,</span> <span class="n">optionflags</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The entry method for doctest output checking. Defers to a sequence of</span>
<span class="sd">        child checkers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">checks</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check_output_default</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">check_output_numeric</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">check_output_xml</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">check_output_json</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">check</span> <span class="ow">in</span> <span class="n">checks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">check</span><span class="p">(</span><span class="n">want</span><span class="p">,</span> <span class="n">got</span><span class="p">,</span> <span class="n">optionflags</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">check_output_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">want</span><span class="p">,</span> <span class="n">got</span><span class="p">,</span> <span class="n">optionflags</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The default comparator provided by doctest - not perfect, but good for</span>
<span class="sd">        most purposes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">doctest</span><span class="o">.</span><span class="n">OutputChecker</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">want</span><span class="p">,</span> <span class="n">got</span><span class="p">,</span> <span class="n">optionflags</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_output_numeric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">want</span><span class="p">,</span> <span class="n">got</span><span class="p">,</span> <span class="n">optionflags</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Doctest does an exact string comparison of output, which means that</span>
<span class="sd">        some numerically equivalent values aren&#39;t equal. This check normalizes</span>
<span class="sd">         * long integers (22L) so that they equal normal integers. (22)</span>
<span class="sd">         * Decimals so that they are comparable, regardless of the change</span>
<span class="sd">           made to __repr__ in Python 2.6.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">doctest</span><span class="o">.</span><span class="n">OutputChecker</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">normalize_decimals</span><span class="p">(</span><span class="n">normalize_long_ints</span><span class="p">(</span><span class="n">want</span><span class="p">)),</span>
            <span class="n">normalize_decimals</span><span class="p">(</span><span class="n">normalize_long_ints</span><span class="p">(</span><span class="n">got</span><span class="p">)),</span>
            <span class="n">optionflags</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_output_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">want</span><span class="p">,</span> <span class="n">got</span><span class="p">,</span> <span class="n">optionsflags</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">compare_xml</span><span class="p">(</span><span class="n">want</span><span class="p">,</span> <span class="n">got</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">check_output_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">want</span><span class="p">,</span> <span class="n">got</span><span class="p">,</span> <span class="n">optionsflags</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tries to compare want and got as if they were JSON-encoded data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">want</span><span class="p">,</span> <span class="n">got</span> <span class="o">=</span> <span class="n">strip_quotes</span><span class="p">(</span><span class="n">want</span><span class="p">,</span> <span class="n">got</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">want_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">want</span><span class="p">)</span>
            <span class="n">got_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">got</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">want_json</span> <span class="o">==</span> <span class="n">got_json</span>


<span class="k">class</span> <span class="nc">DocTestRunner</span><span class="p">(</span><span class="n">doctest</span><span class="o">.</span><span class="n">DocTestRunner</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">doctest</span><span class="o">.</span><span class="n">DocTestRunner</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optionflags</span> <span class="o">=</span> <span class="n">doctest</span><span class="o">.</span><span class="n">ELLIPSIS</span>

    <span class="k">def</span> <span class="nf">report_unexpected_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">):</span>
        <span class="n">doctest</span><span class="o">.</span><span class="n">DocTestRunner</span><span class="o">.</span><span class="n">report_unexpected_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span>
                                                          <span class="n">example</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">)</span>
        <span class="c"># Rollback, in case of database errors. Otherwise they&#39;d have</span>
        <span class="c"># side effects on other tests.</span>
        <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">connections</span><span class="p">:</span>
            <span class="n">transaction</span><span class="o">.</span><span class="n">rollback_unless_managed</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">conn</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_AssertNumQueriesContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_case</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_case</span> <span class="o">=</span> <span class="n">test_case</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_debug_cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">use_debug_cursor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">use_debug_cursor</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">starting_queries</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">queries</span><span class="p">)</span>
        <span class="n">request_started</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="n">reset_queries</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">use_debug_cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_debug_cursor</span>
        <span class="n">request_started</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reset_queries</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">final_queries</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">queries</span><span class="p">)</span>
        <span class="n">executed</span> <span class="o">=</span> <span class="n">final_queries</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">starting_queries</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">test_case</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">executed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s"> queries executed, </span><span class="si">%d</span><span class="s"> expected&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">executed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num</span>
            <span class="p">)</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">_AssertTemplateUsedContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_case</span><span class="p">,</span> <span class="n">template_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_case</span> <span class="o">=</span> <span class="n">test_case</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span> <span class="o">=</span> <span class="n">template_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendered_templates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendered_template_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">ContextList</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_template_render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendered_templates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendered_template_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rendered_template_names</span>

    <span class="k">def</span> <span class="nf">message</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> was not rendered.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">template_rendered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_template_render</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="n">template_rendered</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_template_render</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">():</span>
            <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rendered_templates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="s">&#39; No template was rendered.&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="s">&#39; Following templates were rendered: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rendered_template_names</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_case</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_AssertTemplateNotUsedContext</span><span class="p">(</span><span class="n">_AssertTemplateUsedContext</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rendered_template_names</span>

    <span class="k">def</span> <span class="nf">message</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> was rendered.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span>


<span class="k">class</span> <span class="nc">SimpleTestCase</span><span class="p">(</span><span class="n">ut2</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper around default __call__ method to perform common Django test</span>
<span class="sd">        set up. This means that user-defined Test Cases aren&#39;t required to</span>
<span class="sd">        include a call to super().setUp().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">testMethod</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">)</span>
        <span class="n">skipped</span> <span class="o">=</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="s">&quot;__unittest_skip__&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> <span class="ow">or</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">testMethod</span><span class="p">,</span> <span class="s">&quot;__unittest_skip__&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">skipped</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pre_setup</span><span class="p">()</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">addError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
                <span class="k">return</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SimpleTestCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__call__</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">skipped</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_post_teardown</span><span class="p">()</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">addError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
                <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_pre_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_post_teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">save_warnings_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves the state of the warnings module</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_warnings_state</span> <span class="o">=</span> <span class="n">get_warnings_state</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">restore_warnings_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Restores the state of the warnings module to the state</span>
<span class="sd">        saved by save_warnings_state()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">restore_warnings_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_warnings_state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A context manager that temporarily sets a setting and reverts</span>
<span class="sd">        back to the original value when exiting the context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">override_settings</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">assertRaisesMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected_exception</span><span class="p">,</span> <span class="n">expected_message</span><span class="p">,</span>
                           <span class="n">callable_obj</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asserts that the message in a raised exception matches the passed</span>
<span class="sd">        value.</span>

<span class="sd">        Args:</span>
<span class="sd">            expected_exception: Exception class expected to be raised.</span>
<span class="sd">            expected_message: expected error message string value.</span>
<span class="sd">            callable_obj: Function to be called.</span>
<span class="sd">            args: Extra args.</span>
<span class="sd">            kwargs: Extra kwargs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">six</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected_exception</span><span class="p">,</span>
                <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">expected_message</span><span class="p">),</span> <span class="n">callable_obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">assertFieldOutput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fieldclass</span><span class="p">,</span> <span class="n">valid</span><span class="p">,</span> <span class="n">invalid</span><span class="p">,</span> <span class="n">field_args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">field_kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">empty_value</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asserts that a form field behaves correctly with various inputs.</span>

<span class="sd">        Args:</span>
<span class="sd">            fieldclass: the class of the field to be tested.</span>
<span class="sd">            valid: a dictionary mapping valid inputs to their expected</span>
<span class="sd">                    cleaned values.</span>
<span class="sd">            invalid: a dictionary mapping invalid inputs to one or more</span>
<span class="sd">                    raised error messages.</span>
<span class="sd">            field_args: the args passed to instantiate the field</span>
<span class="sd">            field_kwargs: the kwargs passed to instantiate the field</span>
<span class="sd">            empty_value: the expected clean output for inputs in EMPTY_VALUES</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">field_args</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">field_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">field_kwargs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">field_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">required</span> <span class="o">=</span> <span class="n">fieldclass</span><span class="p">(</span><span class="o">*</span><span class="n">field_args</span><span class="p">,</span> <span class="o">**</span><span class="n">field_kwargs</span><span class="p">)</span>
        <span class="n">optional</span> <span class="o">=</span> <span class="n">fieldclass</span><span class="p">(</span><span class="o">*</span><span class="n">field_args</span><span class="p">,</span>
                              <span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">field_kwargs</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
        <span class="c"># test valid inputs</span>
        <span class="k">for</span> <span class="nb">input</span><span class="p">,</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">valid</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">required</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="nb">input</span><span class="p">),</span> <span class="n">output</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">optional</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="nb">input</span><span class="p">),</span> <span class="n">output</span><span class="p">)</span>
        <span class="c"># test invalid inputs</span>
        <span class="k">for</span> <span class="nb">input</span><span class="p">,</span> <span class="n">errors</span> <span class="ow">in</span> <span class="n">invalid</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">)</span> <span class="k">as</span> <span class="n">context_manager</span><span class="p">:</span>
                <span class="n">required</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">context_manager</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">messages</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">)</span> <span class="k">as</span> <span class="n">context_manager</span><span class="p">:</span>
                <span class="n">optional</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">context_manager</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">messages</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
        <span class="c"># test required inputs</span>
        <span class="n">error_required</span> <span class="o">=</span> <span class="p">[</span><span class="n">force_text</span><span class="p">(</span><span class="n">required</span><span class="o">.</span><span class="n">error_messages</span><span class="p">[</span><span class="s">&#39;required&#39;</span><span class="p">])]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">EMPTY_VALUES</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">)</span> <span class="k">as</span> <span class="n">context_manager</span><span class="p">:</span>
                <span class="n">required</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">context_manager</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">messages</span><span class="p">,</span>
                             <span class="n">error_required</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">optional</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">empty_value</span><span class="p">)</span>
        <span class="c"># test that max_length and min_length are always accepted</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">fieldclass</span><span class="p">,</span> <span class="n">CharField</span><span class="p">):</span>
            <span class="n">field_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;min_length&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#39;max_length&#39;</span><span class="p">:</span><span class="mi">20</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">fieldclass</span><span class="p">(</span><span class="o">*</span><span class="n">field_args</span><span class="p">,</span> <span class="o">**</span><span class="n">field_kwargs</span><span class="p">),</span>
                                       <span class="n">fieldclass</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">assertHTMLEqual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html1</span><span class="p">,</span> <span class="n">html2</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asserts that two HTML snippets are semantically the same.</span>
<span class="sd">        Whitespace in most cases is ignored, and attribute ordering is not</span>
<span class="sd">        significant. The passed-in arguments must be valid HTML.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dom1</span> <span class="o">=</span> <span class="n">assert_and_parse_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html1</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span>
            <span class="s">&#39;First argument is not valid HTML:&#39;</span><span class="p">)</span>
        <span class="n">dom2</span> <span class="o">=</span> <span class="n">assert_and_parse_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html2</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span>
            <span class="s">&#39;Second argument is not valid HTML:&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dom1</span> <span class="o">!=</span> <span class="n">dom2</span><span class="p">:</span>
            <span class="n">standardMsg</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">safe_repr</span><span class="p">(</span><span class="n">dom1</span><span class="p">,</span> <span class="bp">True</span><span class="p">),</span> <span class="n">safe_repr</span><span class="p">(</span><span class="n">dom2</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">difflib</span><span class="o">.</span><span class="n">ndiff</span><span class="p">(</span>
                           <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">dom1</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(),</span>
                           <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">dom2</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())))</span>
            <span class="n">standardMsg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_truncateMessage</span><span class="p">(</span><span class="n">standardMsg</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">standardMsg</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">assertHTMLNotEqual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html1</span><span class="p">,</span> <span class="n">html2</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Asserts that two HTML snippets are not semantically equivalent.&quot;&quot;&quot;</span>
        <span class="n">dom1</span> <span class="o">=</span> <span class="n">assert_and_parse_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html1</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span>
            <span class="s">&#39;First argument is not valid HTML:&#39;</span><span class="p">)</span>
        <span class="n">dom2</span> <span class="o">=</span> <span class="n">assert_and_parse_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html2</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span>
            <span class="s">&#39;Second argument is not valid HTML:&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dom1</span> <span class="o">==</span> <span class="n">dom2</span><span class="p">:</span>
            <span class="n">standardMsg</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> == </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">safe_repr</span><span class="p">(</span><span class="n">dom1</span><span class="p">,</span> <span class="bp">True</span><span class="p">),</span> <span class="n">safe_repr</span><span class="p">(</span><span class="n">dom2</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">standardMsg</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">assertInHTML</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">needle</span><span class="p">,</span> <span class="n">haystack</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="n">needle</span> <span class="o">=</span> <span class="n">assert_and_parse_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">needle</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
            <span class="s">&#39;First argument is not valid HTML:&#39;</span><span class="p">)</span>
        <span class="n">haystack</span> <span class="o">=</span> <span class="n">assert_and_parse_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">haystack</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
            <span class="s">&#39;Second argument is not valid HTML:&#39;</span><span class="p">)</span>
        <span class="n">real_count</span> <span class="o">=</span> <span class="n">haystack</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">needle</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">real_count</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
                <span class="n">msg_prefix</span> <span class="o">+</span> <span class="s">&quot;Found </span><span class="si">%d</span><span class="s"> instances of &#39;</span><span class="si">%s</span><span class="s">&#39; in response&quot;</span>
                <span class="s">&quot; (expected </span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">real_count</span><span class="p">,</span> <span class="n">needle</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">real_count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">msg_prefix</span> <span class="o">+</span> <span class="s">&quot;Couldn&#39;t find &#39;</span><span class="si">%s</span><span class="s">&#39; in response&quot;</span> <span class="o">%</span> <span class="n">needle</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">assertJSONEqual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw</span><span class="p">,</span> <span class="n">expected_data</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;First argument is not valid JSON: </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">raw</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expected_data</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">expected_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">expected_data</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Second argument is not valid JSON: </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">expected_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">expected_data</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">assertXMLEqual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml1</span><span class="p">,</span> <span class="n">xml2</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asserts that two XML snippets are semantically the same.</span>
<span class="sd">        Whitespace in most cases is ignored, and attribute ordering is not</span>
<span class="sd">        significant. The passed-in arguments must be valid XML.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">compare_xml</span><span class="p">(</span><span class="n">xml1</span><span class="p">,</span> <span class="n">xml2</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">standardMsg</span> <span class="o">=</span> <span class="s">&#39;First or second argument is not valid XML</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">standardMsg</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">standardMsg</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">safe_repr</span><span class="p">(</span><span class="n">xml1</span><span class="p">,</span> <span class="bp">True</span><span class="p">),</span> <span class="n">safe_repr</span><span class="p">(</span><span class="n">xml2</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">standardMsg</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">assertXMLNotEqual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml1</span><span class="p">,</span> <span class="n">xml2</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asserts that two XML snippets are not semantically equivalent.</span>
<span class="sd">        Whitespace in most cases is ignored, and attribute ordering is not</span>
<span class="sd">        significant. The passed-in arguments must be valid XML.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">compare_xml</span><span class="p">(</span><span class="n">xml1</span><span class="p">,</span> <span class="n">xml2</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">standardMsg</span> <span class="o">=</span> <span class="s">&#39;First or second argument is not valid XML</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">standardMsg</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">standardMsg</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> == </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">safe_repr</span><span class="p">(</span><span class="n">xml1</span><span class="p">,</span> <span class="bp">True</span><span class="p">),</span> <span class="n">safe_repr</span><span class="p">(</span><span class="n">xml2</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">standardMsg</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">TransactionTestCase</span><span class="p">(</span><span class="n">SimpleTestCase</span><span class="p">):</span>

    <span class="c"># The class we&#39;ll use for the test client self.client.</span>
    <span class="c"># Can be overridden in derived classes.</span>
    <span class="n">client_class</span> <span class="o">=</span> <span class="n">Client</span>

    <span class="c"># Subclasses can ask for resetting of auto increment sequence before each</span>
    <span class="c"># test case</span>
    <span class="n">reset_sequences</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_pre_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs any pre-test setup. This includes:</span>

<span class="sd">            * Flushing the database.</span>
<span class="sd">            * If the Test Case class has a &#39;fixtures&#39; member, installing the</span>
<span class="sd">              named fixtures.</span>
<span class="sd">            * If the Test Case class has a &#39;urls&#39; member, replace the</span>
<span class="sd">              ROOT_URLCONF with it.</span>
<span class="sd">            * Clearing the mail test outbox.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_class</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixture_setup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_urlconf_setup</span><span class="p">()</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">outbox</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_databases_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_mirrors</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="c"># If the test case has a multi_db=True flag, act on all databases,</span>
        <span class="c"># including mirrors or not. Otherwise, just on the default DB.</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;multi_db&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">alias</span> <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">connections</span>
                    <span class="k">if</span> <span class="n">include_mirrors</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">connections</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;TEST_MIRROR&#39;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">DEFAULT_DB_ALIAS</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_reset_sequences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_name</span><span class="p">):</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span><span class="n">db_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">conn</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">supports_sequence_reset</span><span class="p">:</span>
            <span class="n">sql_list</span> <span class="o">=</span> \
                <span class="n">conn</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">sequence_reset_by_name_sql</span><span class="p">(</span><span class="n">no_style</span><span class="p">(),</span>
                                                    <span class="n">conn</span><span class="o">.</span><span class="n">introspection</span><span class="o">.</span><span class="n">sequence_list</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">sql_list</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">sql</span> <span class="ow">in</span> <span class="n">sql_list</span><span class="p">:</span>
                        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">transaction</span><span class="o">.</span><span class="n">rollback_unless_managed</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db_name</span><span class="p">)</span>
                    <span class="k">raise</span>
                <span class="n">transaction</span><span class="o">.</span><span class="n">commit_unless_managed</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fixture_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">db_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_databases_names</span><span class="p">(</span><span class="n">include_mirrors</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
            <span class="c"># Reset sequences</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_sequences</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reset_sequences</span><span class="p">(</span><span class="n">db_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;fixtures&#39;</span><span class="p">):</span>
                <span class="c"># We have to use this slightly awkward syntax due to the fact</span>
                <span class="c"># that we&#39;re using *args and **kwargs together.</span>
                <span class="n">call_command</span><span class="p">(</span><span class="s">&#39;loaddata&#39;</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">fixtures</span><span class="p">,</span>
                             <span class="o">**</span><span class="p">{</span><span class="s">&#39;verbosity&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;database&#39;</span><span class="p">:</span> <span class="n">db_name</span><span class="p">,</span> <span class="s">&#39;skip_validation&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">_urlconf_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;urls&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_old_root_urlconf</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ROOT_URLCONF</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">ROOT_URLCONF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urls</span>
            <span class="n">clear_url_caches</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_post_teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Performs any post-test things. This includes:</span>

<span class="sd">            * Putting back the original ROOT_URLCONF if it was changed.</span>
<span class="sd">            * Force closing the connection, so that the next test gets</span>
<span class="sd">              a clean cursor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixture_teardown</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_urlconf_teardown</span><span class="p">()</span>
        <span class="c"># Some DB cursors include SQL statements as part of cursor</span>
        <span class="c"># creation. If you have a test that does rollback, the effect</span>
        <span class="c"># of these statements is lost, which can effect the operation</span>
        <span class="c"># of tests (e.g., losing a timezone setting causing objects to</span>
        <span class="c"># be created with the wrong time).</span>
        <span class="c"># To make sure this doesn&#39;t happen, get a clean connection at the</span>
        <span class="c"># start of every test.</span>
        <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">connections</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_fixture_teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Roll back any pending transactions in order to avoid a deadlock</span>
        <span class="c"># during flush when TEST_MIRROR is used (#18984).</span>
        <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">connections</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">rollback_unless_managed</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">db</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_databases_names</span><span class="p">(</span><span class="n">include_mirrors</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
            <span class="n">call_command</span><span class="p">(</span><span class="s">&#39;flush&#39;</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
                         <span class="n">skip_validation</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">reset_sequences</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_urlconf_teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_old_root_urlconf&#39;</span><span class="p">):</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">ROOT_URLCONF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_old_root_urlconf</span>
            <span class="n">clear_url_caches</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">assertRedirects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">expected_url</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">302</span><span class="p">,</span>
                        <span class="n">target_status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Asserts that a response redirected to a specific URL, and that the</span>
<span class="sd">        redirect URL can be loaded.</span>

<span class="sd">        Note that assertRedirects won&#39;t work for external links since it uses</span>
<span class="sd">        TestClient to do a request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">msg_prefix</span><span class="p">:</span>
            <span class="n">msg_prefix</span> <span class="o">+=</span> <span class="s">&quot;: &quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">&#39;redirect_chain&#39;</span><span class="p">):</span>
            <span class="c"># The request was a followed redirect</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">redirect_chain</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">msg_prefix</span> <span class="o">+</span> <span class="s">&quot;Response didn&#39;t redirect as expected: Response&quot;</span>
                <span class="s">&quot; code was </span><span class="si">%d</span><span class="s"> (expected </span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status_code</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">redirect_chain</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">status_code</span><span class="p">,</span>
                <span class="n">msg_prefix</span> <span class="o">+</span> <span class="s">&quot;Initial response didn&#39;t redirect as expected:&quot;</span>
                <span class="s">&quot; Response code was </span><span class="si">%d</span><span class="s"> (expected </span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">redirect_chain</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">status_code</span><span class="p">))</span>

            <span class="n">url</span><span class="p">,</span> <span class="n">status_code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">redirect_chain</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">target_status_code</span><span class="p">,</span>
                <span class="n">msg_prefix</span> <span class="o">+</span> <span class="s">&quot;Response didn&#39;t redirect as expected: Final&quot;</span>
                <span class="s">&quot; Response code was </span><span class="si">%d</span><span class="s"> (expected </span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">target_status_code</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Not a followed redirect</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span>
                <span class="n">msg_prefix</span> <span class="o">+</span> <span class="s">&quot;Response didn&#39;t redirect as expected: Response&quot;</span>
                <span class="s">&quot; code was </span><span class="si">%d</span><span class="s"> (expected </span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status_code</span><span class="p">))</span>

            <span class="n">url</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;Location&#39;</span><span class="p">]</span>
            <span class="n">scheme</span><span class="p">,</span> <span class="n">netloc</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">fragment</span> <span class="o">=</span> <span class="n">urlsplit</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

            <span class="n">redirect_response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">QueryDict</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>

            <span class="c"># Get the redirection page, using the same client that was used</span>
            <span class="c"># to obtain the original response.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">redirect_response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">target_status_code</span><span class="p">,</span>
                <span class="n">msg_prefix</span> <span class="o">+</span> <span class="s">&quot;Couldn&#39;t retrieve redirection page &#39;</span><span class="si">%s</span><span class="s">&#39;:&quot;</span>
                <span class="s">&quot; response code was </span><span class="si">%d</span><span class="s"> (expected </span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">redirect_response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">target_status_code</span><span class="p">))</span>

        <span class="n">e_scheme</span><span class="p">,</span> <span class="n">e_netloc</span><span class="p">,</span> <span class="n">e_path</span><span class="p">,</span> <span class="n">e_query</span><span class="p">,</span> <span class="n">e_fragment</span> <span class="o">=</span> <span class="n">urlsplit</span><span class="p">(</span>
                                                              <span class="n">expected_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">e_scheme</span> <span class="ow">or</span> <span class="n">e_netloc</span><span class="p">):</span>
            <span class="n">expected_url</span> <span class="o">=</span> <span class="n">urlunsplit</span><span class="p">((</span><span class="s">&#39;http&#39;</span><span class="p">,</span> <span class="n">host</span> <span class="ow">or</span> <span class="s">&#39;testserver&#39;</span><span class="p">,</span> <span class="n">e_path</span><span class="p">,</span>
                <span class="n">e_query</span><span class="p">,</span> <span class="n">e_fragment</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">expected_url</span><span class="p">,</span>
            <span class="n">msg_prefix</span> <span class="o">+</span> <span class="s">&quot;Response redirected to &#39;</span><span class="si">%s</span><span class="s">&#39;, expected &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">expected_url</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">assertContains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                       <span class="n">msg_prefix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">html</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asserts that a response indicates that some content was retrieved</span>
<span class="sd">        successfully, (i.e., the HTTP status code was as expected), and that</span>
<span class="sd">        ``text`` occurs ``count`` times in the content of the response.</span>
<span class="sd">        If ``count`` is None, the count doesn&#39;t matter - the assertion is true</span>
<span class="sd">        if the text occurs at least once in the response.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># If the response supports deferred rendering and hasn&#39;t been rendered</span>
        <span class="c"># yet, then ensure that it does get rendered before proceeding further.</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">&#39;render&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">render</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">is_rendered</span><span class="p">):</span>
            <span class="n">response</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">msg_prefix</span><span class="p">:</span>
            <span class="n">msg_prefix</span> <span class="o">+=</span> <span class="s">&quot;: &quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span>
            <span class="n">msg_prefix</span> <span class="o">+</span> <span class="s">&quot;Couldn&#39;t retrieve content: Response code was </span><span class="si">%d</span><span class="s">&quot;</span>
            <span class="s">&quot; (expected </span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status_code</span><span class="p">))</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">force_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">_charset</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">streaming</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">streaming_content</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">_charset</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">html</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">assert_and_parse_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                <span class="s">&quot;Response&#39;s content is not valid HTML:&quot;</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">assert_and_parse_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                <span class="s">&quot;Second argument is not valid HTML:&quot;</span><span class="p">)</span>
        <span class="n">real_count</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">real_count</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
                <span class="n">msg_prefix</span> <span class="o">+</span> <span class="s">&quot;Found </span><span class="si">%d</span><span class="s"> instances of &#39;</span><span class="si">%s</span><span class="s">&#39; in response&quot;</span>
                <span class="s">&quot; (expected </span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">real_count</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">real_count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">msg_prefix</span> <span class="o">+</span> <span class="s">&quot;Couldn&#39;t find &#39;</span><span class="si">%s</span><span class="s">&#39; in response&quot;</span> <span class="o">%</span> <span class="n">text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">assertNotContains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                          <span class="n">msg_prefix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">html</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asserts that a response indicates that some content was retrieved</span>
<span class="sd">        successfully, (i.e., the HTTP status code was as expected), and that</span>
<span class="sd">        ``text`` doesn&#39;t occurs in the content of the response.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># If the response supports deferred rendering and hasn&#39;t been rendered</span>
        <span class="c"># yet, then ensure that it does get rendered before proceeding further.</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">&#39;render&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">render</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">is_rendered</span><span class="p">):</span>
            <span class="n">response</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">msg_prefix</span><span class="p">:</span>
            <span class="n">msg_prefix</span> <span class="o">+=</span> <span class="s">&quot;: &quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span>
            <span class="n">msg_prefix</span> <span class="o">+</span> <span class="s">&quot;Couldn&#39;t retrieve content: Response code was </span><span class="si">%d</span><span class="s">&quot;</span>
            <span class="s">&quot; (expected </span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status_code</span><span class="p">))</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">force_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">_charset</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">_charset</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">html</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">assert_and_parse_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                <span class="s">&#39;Response</span><span class="se">\&#39;</span><span class="s">s content is not valid HTML:&#39;</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">assert_and_parse_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                <span class="s">&#39;Second argument is not valid HTML:&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">msg_prefix</span> <span class="o">+</span> <span class="s">&quot;Response should not contain &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">assertFormError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asserts that a form used to render the response has a specific field</span>
<span class="sd">        error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">msg_prefix</span><span class="p">:</span>
            <span class="n">msg_prefix</span> <span class="o">+=</span> <span class="s">&quot;: &quot;</span>

        <span class="c"># Put context(s) into a list to simplify processing.</span>
        <span class="n">contexts</span> <span class="o">=</span> <span class="n">to_list</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">contexts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">msg_prefix</span> <span class="o">+</span> <span class="s">&quot;Response did not use any contexts to &quot;</span>
                      <span class="s">&quot;render the response&quot;</span><span class="p">)</span>

        <span class="c"># Put error(s) into a list to simplify processing.</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="n">to_list</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>

        <span class="c"># Search all contexts for the error.</span>
        <span class="n">found_form</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">context</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contexts</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">form</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">found_form</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">context</span><span class="p">[</span><span class="n">form</span><span class="p">]</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
                        <span class="n">field_errors</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="n">form</span><span class="p">]</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">err</span> <span class="ow">in</span> <span class="n">field_errors</span><span class="p">,</span>
                            <span class="n">msg_prefix</span> <span class="o">+</span> <span class="s">&quot;The field &#39;</span><span class="si">%s</span><span class="s">&#39; on form &#39;</span><span class="si">%s</span><span class="s">&#39; in&quot;</span>
                            <span class="s">&quot; context </span><span class="si">%d</span><span class="s"> does not contain the error &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span>
                            <span class="s">&quot; (actual errors: </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
                                <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">field_errors</span><span class="p">)))</span>
                    <span class="k">elif</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">context</span><span class="p">[</span><span class="n">form</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">msg_prefix</span> <span class="o">+</span> <span class="s">&quot;The field &#39;</span><span class="si">%s</span><span class="s">&#39; on form &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span>
                                  <span class="s">&quot; in context </span><span class="si">%d</span><span class="s"> contains no errors&quot;</span> <span class="o">%</span>
                                      <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">msg_prefix</span> <span class="o">+</span> <span class="s">&quot;The form &#39;</span><span class="si">%s</span><span class="s">&#39; in context </span><span class="si">%d</span><span class="s">&quot;</span>
                                  <span class="s">&quot; does not contain the field &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span>
                                      <span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">field</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">non_field_errors</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="n">form</span><span class="p">]</span><span class="o">.</span><span class="n">non_field_errors</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">err</span> <span class="ow">in</span> <span class="n">non_field_errors</span><span class="p">,</span>
                        <span class="n">msg_prefix</span> <span class="o">+</span> <span class="s">&quot;The form &#39;</span><span class="si">%s</span><span class="s">&#39; in context </span><span class="si">%d</span><span class="s"> does not&quot;</span>
                        <span class="s">&quot; contain the non-field error &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span>
                        <span class="s">&quot; (actual errors: </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">non_field_errors</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found_form</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">msg_prefix</span> <span class="o">+</span> <span class="s">&quot;The form &#39;</span><span class="si">%s</span><span class="s">&#39; was not used to render the&quot;</span>
                      <span class="s">&quot; response&quot;</span> <span class="o">%</span> <span class="n">form</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">assertTemplateUsed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">template_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asserts that the template with the provided name was used in rendering</span>
<span class="sd">        the response. Also usable as context manager.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">template_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;response and/or template_name argument must be provided&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">msg_prefix</span><span class="p">:</span>
            <span class="n">msg_prefix</span> <span class="o">+=</span> <span class="s">&quot;: &quot;</span>

        <span class="c"># Use assertTemplateUsed as context manager.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">response</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">template_name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
                <span class="n">template_name</span> <span class="o">=</span> <span class="n">response</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">_AssertTemplateUsedContext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">context</span>

        <span class="n">template_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">templates</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">template_names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">msg_prefix</span> <span class="o">+</span> <span class="s">&quot;No templates used to render the response&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">template_name</span> <span class="ow">in</span> <span class="n">template_names</span><span class="p">,</span>
            <span class="n">msg_prefix</span> <span class="o">+</span> <span class="s">&quot;Template &#39;</span><span class="si">%s</span><span class="s">&#39; was not a template used to render&quot;</span>
            <span class="s">&quot; the response. Actual template(s) used: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">template_names</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">assertTemplateNotUsed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">template_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">msg_prefix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asserts that the template with the provided name was NOT used in</span>
<span class="sd">        rendering the response. Also usable as context manager.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">template_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;response and/or template_name argument must be provided&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">msg_prefix</span><span class="p">:</span>
            <span class="n">msg_prefix</span> <span class="o">+=</span> <span class="s">&quot;: &quot;</span>

        <span class="c"># Use assertTemplateUsed as context manager.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">response</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">template_name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
                <span class="n">template_name</span> <span class="o">=</span> <span class="n">response</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">_AssertTemplateNotUsedContext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">context</span>

        <span class="n">template_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">templates</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">template_name</span> <span class="ow">in</span> <span class="n">template_names</span><span class="p">,</span>
            <span class="n">msg_prefix</span> <span class="o">+</span> <span class="s">&quot;Template &#39;</span><span class="si">%s</span><span class="s">&#39; was used unexpectedly in rendering&quot;</span>
            <span class="s">&quot; the response&quot;</span> <span class="o">%</span> <span class="n">template_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">assertQuerysetEqual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qs</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="nb">repr</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">moves</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">qs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ordered</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">items</span><span class="p">),</span> <span class="nb">set</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">items</span><span class="p">),</span> <span class="n">values</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">assertNumQueries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">using</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;using&quot;</span><span class="p">,</span> <span class="n">DEFAULT_DB_ALIAS</span><span class="p">)</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span><span class="n">using</span><span class="p">]</span>

        <span class="n">context</span> <span class="o">=</span> <span class="n">_AssertNumQueriesContext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">context</span>

        <span class="k">with</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">connections_support_transactions</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns True if all connections support transactions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">supports_transactions</span>
               <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">connections</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>


<div class="viewcode-block" id="TestCase"><a class="viewcode-back" href="../../../django.test.html#django.test.testcases.TestCase">[docs]</a><span class="k">class</span> <span class="nc">TestCase</span><span class="p">(</span><span class="n">TransactionTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Does basically the same as TransactionTestCase, but surrounds every test</span>
<span class="sd">    with a transaction, monkey-patches the real transaction management routines</span>
<span class="sd">    to do nothing, and rollsback the test transaction at the end of the test.</span>
<span class="sd">    You have to use TransactionTestCase, if you need transaction management</span>
<span class="sd">    inside a test.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_fixture_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">connections_support_transactions</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">TestCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_fixture_setup</span><span class="p">()</span>

        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_sequences</span><span class="p">,</span> <span class="s">&#39;reset_sequences cannot be used on TestCase instances&#39;</span>

        <span class="k">for</span> <span class="n">db_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_databases_names</span><span class="p">():</span>
            <span class="n">transaction</span><span class="o">.</span><span class="n">enter_transaction_management</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db_name</span><span class="p">)</span>
            <span class="n">transaction</span><span class="o">.</span><span class="n">managed</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="n">db_name</span><span class="p">)</span>
        <span class="n">disable_transaction_methods</span><span class="p">()</span>

        <span class="kn">from</span> <span class="nn">django.contrib.sites.models</span> <span class="kn">import</span> <span class="n">Site</span>
        <span class="n">Site</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">db</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_databases_names</span><span class="p">(</span><span class="n">include_mirrors</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;fixtures&#39;</span><span class="p">):</span>
                <span class="n">call_command</span><span class="p">(</span><span class="s">&#39;loaddata&#39;</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">fixtures</span><span class="p">,</span>
                             <span class="o">**</span><span class="p">{</span>
                                <span class="s">&#39;verbosity&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                <span class="s">&#39;commit&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                                <span class="s">&#39;database&#39;</span><span class="p">:</span> <span class="n">db</span><span class="p">,</span>
                                <span class="s">&#39;skip_validation&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                             <span class="p">})</span>

    <span class="k">def</span> <span class="nf">_fixture_teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">connections_support_transactions</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">TestCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_fixture_teardown</span><span class="p">()</span>

        <span class="n">restore_transaction_methods</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">db</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_databases_names</span><span class="p">():</span>
            <span class="n">transaction</span><span class="o">.</span><span class="n">rollback</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
            <span class="n">transaction</span><span class="o">.</span><span class="n">leave_transaction_management</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>

</div>
<span class="k">def</span> <span class="nf">_deferredSkip</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">test_func</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">test_func</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">issubclass</span><span class="p">(</span><span class="n">test_func</span><span class="p">,</span> <span class="n">TestCase</span><span class="p">)):</span>
            <span class="nd">@wraps</span><span class="p">(</span><span class="n">test_func</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">skip_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">condition</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="n">ut2</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">test_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">test_item</span> <span class="o">=</span> <span class="n">skip_wrapper</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">test_item</span> <span class="o">=</span> <span class="n">test_func</span>
        <span class="n">test_item</span><span class="o">.</span><span class="n">__unittest_skip_why__</span> <span class="o">=</span> <span class="n">reason</span>
        <span class="k">return</span> <span class="n">test_item</span>
    <span class="k">return</span> <span class="n">decorator</span>


<div class="viewcode-block" id="skipIfDBFeature"><a class="viewcode-back" href="../../../django.test.html#django.test.testcases.skipIfDBFeature">[docs]</a><span class="k">def</span> <span class="nf">skipIfDBFeature</span><span class="p">(</span><span class="n">feature</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Skip a test if a database has the named feature</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_deferredSkip</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">feature</span><span class="p">),</span>
                         <span class="s">&quot;Database has feature </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">feature</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="skipUnlessDBFeature"><a class="viewcode-back" href="../../../django.test.html#django.test.testcases.skipUnlessDBFeature">[docs]</a><span class="k">def</span> <span class="nf">skipUnlessDBFeature</span><span class="p">(</span><span class="n">feature</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Skip a test unless a database has the named feature</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_deferredSkip</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">feature</span><span class="p">),</span>
                         <span class="s">&quot;Database doesn&#39;t support feature </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">feature</span><span class="p">)</span>

</div>
<span class="k">class</span> <span class="nc">QuietWSGIRequestHandler</span><span class="p">(</span><span class="n">WSGIRequestHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Just a regular WSGIRequestHandler except it doesn&#39;t log to the standard</span>
<span class="sd">    output any of the requests received, so as to not clutter the output for</span>
<span class="sd">    the tests&#39; results.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">log_message</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">_ImprovedEvent</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span>
<span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">_ImprovedEvent</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">_Event</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">_ImprovedEvent</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">_Event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Does the same as `threading.Event` except it overrides the wait() method</span>
<span class="sd">        with some code borrowed from Python 2.7 to return the set state of the</span>
<span class="sd">        event (see: http://hg.python.org/cpython/rev/b5aa8aa78c0f/). This allows</span>
<span class="sd">        to know whether the wait() method exited normally or because of the</span>
<span class="sd">        timeout. This class can be removed when Django supports only Python &gt;= 2.7.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Event__cond</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Event__flag</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_Event__cond</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Event__flag</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Event__cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">StoppableWSGIServer</span><span class="p">(</span><span class="n">WSGIServer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The code in this class is borrowed from the `SocketServer.BaseServer` class</span>
<span class="sd">    in Python 2.6. The important functionality here is that the server is non-</span>
<span class="sd">    blocking and that it can be shut down at any moment. This is made possible</span>
<span class="sd">    by the server regularly polling the socket and checking if it has been</span>
<span class="sd">    asked to stop.</span>
<span class="sd">    Note for the future: Once Django stops supporting Python 2.6, this class</span>
<span class="sd">    can be removed as `WSGIServer` will have this ability to shutdown on</span>
<span class="sd">    demand and will not require the use of the _ImprovedEvent class whose code</span>
<span class="sd">    is borrowed from Python 2.7.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StoppableWSGIServer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__is_shut_down</span> <span class="o">=</span> <span class="n">_ImprovedEvent</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__serving</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">serve_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">poll_interval</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle one request at a time until shutdown.</span>

<span class="sd">        Polls for shutdown every poll_interval seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__serving</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__is_shut_down</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">__serving</span><span class="p">:</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="bp">self</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="n">poll_interval</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handle_request_noblock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__is_shut_down</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stops the serve_forever loop.</span>

<span class="sd">        Blocks until the loop has finished. This must be called while</span>
<span class="sd">        serve_forever() is running in another thread, or it will</span>
<span class="sd">        deadlock.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__serving</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_shut_down</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s">&quot;Failed to shutdown the live test server in 2 seconds. The &quot;</span>
                <span class="s">&quot;server might be stuck or generating a slow response.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle one request, possibly blocking.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fd_sets</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="bp">self</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fd_sets</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_request_noblock</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_handle_request_noblock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle one request, without blocking.</span>

<span class="sd">        I assume that select.select has returned that the socket is</span>
<span class="sd">        readable before this function was called, so there should be</span>
<span class="sd">        no risk of blocking in get_request().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">request</span><span class="p">,</span> <span class="n">client_address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_request</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">client_address</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">client_address</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">client_address</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_MediaFilesHandler</span><span class="p">(</span><span class="n">StaticFilesHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handler for serving the media files. This is a private class that is</span>
<span class="sd">    meant to be used solely as a convenience by LiveServerThread.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_base_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_ROOT</span>

    <span class="k">def</span> <span class="nf">get_base_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_URL</span>

    <span class="k">def</span> <span class="nf">serve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">relative_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">[</span><span class="mi">2</span><span class="p">]):]</span>
        <span class="k">return</span> <span class="n">serve</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">relative_url</span><span class="p">,</span> <span class="n">document_root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_base_dir</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">LiveServerThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Thread for running a live http server while the tests are running.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">possible_ports</span><span class="p">,</span> <span class="n">connections_override</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">possible_ports</span> <span class="o">=</span> <span class="n">possible_ports</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_ready</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connections_override</span> <span class="o">=</span> <span class="n">connections_override</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LiveServerThread</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets up the live server and databases, and then loops over handling</span>
<span class="sd">        http requests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections_override</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">connections</span>
            <span class="c"># Override this thread&#39;s database connections with the ones</span>
            <span class="c"># provided by the main thread.</span>
            <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">conn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections_override</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">connections</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Create the handler for serving static and media files</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">StaticFilesHandler</span><span class="p">(</span><span class="n">_MediaFilesHandler</span><span class="p">(</span><span class="n">WSGIHandler</span><span class="p">()))</span>

            <span class="c"># Go through the list of possible ports, hoping that we can find</span>
            <span class="c"># one that is free to use for the WSGI server.</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">port</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">possible_ports</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">httpd</span> <span class="o">=</span> <span class="n">StoppableWSGIServer</span><span class="p">(</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span> <span class="n">QuietWSGIRequestHandler</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">WSGIServerException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">possible_ports</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;errno&#39;</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EADDRINUSE</span><span class="p">):</span>
                        <span class="c"># This port is already in use, so we go on and try with</span>
                        <span class="c"># the next one in the list.</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c"># Either none of the given ports are free or the error</span>
                        <span class="c"># is something else than &quot;Address already in use&quot;. So</span>
                        <span class="c"># we let that error bubble up to the main thread.</span>
                        <span class="k">raise</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># A free port was found.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
                    <span class="k">break</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">httpd</span><span class="o">.</span><span class="n">set_app</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_ready</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">e</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_ready</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;httpd&#39;</span><span class="p">):</span>
            <span class="c"># Stop the WSGI server</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">httpd</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">httpd</span><span class="o">.</span><span class="n">server_close</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LiveServerThread</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">LiveServerTestCase</span><span class="p">(</span><span class="n">TransactionTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Does basically the same as TransactionTestCase but also launches a live</span>
<span class="sd">    http server in a separate thread so that the tests may use another testing</span>
<span class="sd">    framework, such as Selenium for example, instead of the built-in dummy</span>
<span class="sd">    client.</span>
<span class="sd">    Note that it inherits from TransactionTestCase instead of TestCase because</span>
<span class="sd">    the threads do not share the same transactions (unless if using in-memory</span>
<span class="sd">    sqlite) and each thread needs to commit all their transactions so that the</span>
<span class="sd">    other thread can see the changes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">live_server_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;http://</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server_thread</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_thread</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="n">connections_override</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">connections</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="c"># If using in-memory sqlite databases, pass the connections to</span>
            <span class="c"># the server thread.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;ENGINE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;sqlite3&#39;</span><span class="p">,</span> <span class="s">&#39;spatialite&#39;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">conn</span><span class="o">.</span><span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;NAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;:memory:&#39;</span><span class="p">):</span>
                <span class="c"># Explicitly enable thread-shareability for this connection</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">allow_thread_sharing</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">connections_override</span><span class="p">[</span><span class="n">conn</span><span class="o">.</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn</span>

        <span class="c"># Launch the live server&#39;s thread</span>
        <span class="n">specified_address</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s">&#39;DJANGO_LIVE_TEST_SERVER_ADDRESS&#39;</span><span class="p">,</span> <span class="s">&#39;localhost:8081&#39;</span><span class="p">)</span>

        <span class="c"># The specified ports may be of the form &#39;8000-8010,8080,9200-9300&#39;</span>
        <span class="c"># i.e. a comma-separated list of ports or ranges of ports, so we break</span>
        <span class="c"># it down into a detailed list of all possible ports.</span>
        <span class="n">possible_ports</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">host</span><span class="p">,</span> <span class="n">port_ranges</span> <span class="o">=</span> <span class="n">specified_address</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">port_range</span> <span class="ow">in</span> <span class="n">port_ranges</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">):</span>
                <span class="c"># A port range can be of either form: &#39;8000&#39; or &#39;8000-8010&#39;.</span>
                <span class="n">extremes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">port_range</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)))</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">extremes</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extremes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c"># Port range of the form &#39;8000&#39;</span>
                    <span class="n">possible_ports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extremes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># Port range of the form &#39;8000-8010&#39;</span>
                    <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">extremes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">extremes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">possible_ports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s">&#39;Invalid address (&quot;</span><span class="si">%s</span><span class="s">&quot;) for live &#39;</span>
                <span class="s">&#39;server.&#39;</span> <span class="o">%</span> <span class="n">specified_address</span><span class="p">)</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">server_thread</span> <span class="o">=</span> <span class="n">LiveServerThread</span><span class="p">(</span>
            <span class="n">host</span><span class="p">,</span> <span class="n">possible_ports</span><span class="p">,</span> <span class="n">connections_override</span><span class="p">)</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">server_thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">server_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c"># Wait for the live server to be ready</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">server_thread</span><span class="o">.</span><span class="n">is_ready</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cls</span><span class="o">.</span><span class="n">server_thread</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">cls</span><span class="o">.</span><span class="n">server_thread</span><span class="o">.</span><span class="n">error</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">LiveServerTestCase</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">setUpClass</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">tearDownClass</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="c"># There may not be a &#39;server_thread&#39; attribute if setUpClass() for some</span>
        <span class="c"># reasons has raised an exception.</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s">&#39;server_thread&#39;</span><span class="p">):</span>
            <span class="c"># Terminate the live server&#39;s thread</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">server_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="c"># Restore sqlite connections&#39; non-sharability</span>
        <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">connections</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;ENGINE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;sqlite3&#39;</span><span class="p">,</span> <span class="s">&#39;spatialite&#39;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">conn</span><span class="o">.</span><span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;NAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;:memory:&#39;</span><span class="p">):</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">allow_thread_sharing</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">LiveServerTestCase</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">tearDownClass</span><span class="p">()</span>
</pre></div>

      </div>
      <div class="bottomnav">
      
        <p>
        <a href="/">Home</a>:
        <a class="uplink" href="../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2012, HDKNR.COM.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>