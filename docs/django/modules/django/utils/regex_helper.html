

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>django.utils.regex_helper &mdash; Django Cheat 1 documentation</title>
    
    <link rel="stylesheet" href="../../../static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../../static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../static/jquery.js"></script>
    <script type="text/javascript" src="../../../static/underscore.js"></script>
    <script type="text/javascript" src="../../../static/doctools.js"></script>
    <script type="text/javascript" src="../../../static/theme_extras.js"></script>
    <link rel="top" title="Django Cheat 1 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../../../index.html">
          <span>Django Cheat 1 documentation</span></a></h1>
        <h2 class="heading"><span>django.utils.regex_helper</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a href="/">Home</a>:
        <a class="uplink" href="../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for django.utils.regex_helper</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Functions for reversing a regular expression (used in reverse URL resolving).</span>
<span class="sd">Used internally by Django and not intended for external use.</span>

<span class="sd">This is not, and is not intended to be, a complete reg-exp decompiler. It</span>
<span class="sd">should be good enough for a large class of URLS, however.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c"># Mapping of an escape character to a representative of that class. So, e.g.,</span>
<span class="c"># &quot;\w&quot; is replaced by &quot;x&quot; in a reverse URL. A value of None means to ignore</span>
<span class="c"># this sequence. Any missing key is mapped to itself.</span>
<span class="n">ESCAPE_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;A&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
    <span class="s">&quot;b&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
    <span class="s">&quot;B&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
    <span class="s">&quot;d&quot;</span><span class="p">:</span> <span class="s">u&quot;0&quot;</span><span class="p">,</span>
    <span class="s">&quot;D&quot;</span><span class="p">:</span> <span class="s">u&quot;x&quot;</span><span class="p">,</span>
    <span class="s">&quot;s&quot;</span><span class="p">:</span> <span class="s">u&quot; &quot;</span><span class="p">,</span>
    <span class="s">&quot;S&quot;</span><span class="p">:</span> <span class="s">u&quot;x&quot;</span><span class="p">,</span>
    <span class="s">&quot;w&quot;</span><span class="p">:</span> <span class="s">u&quot;x&quot;</span><span class="p">,</span>
    <span class="s">&quot;W&quot;</span><span class="p">:</span> <span class="s">u&quot;!&quot;</span><span class="p">,</span>
    <span class="s">&quot;Z&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
<span class="p">}</span>

<div class="viewcode-block" id="Choice"><a class="viewcode-back" href="../../../django.utils.html#django.utils.regex_helper.Choice">[docs]</a><span class="k">class</span> <span class="nc">Choice</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used to represent multiple possibilities at this point in a pattern string.</span>
<span class="sd">    We use a distinguished type, rather than a list, so that the usage in the</span>
<span class="sd">    code is clear.</span>
<span class="sd">    &quot;&quot;&quot;</span>
</div>
<div class="viewcode-block" id="Group"><a class="viewcode-back" href="../../../django.utils.html#django.utils.regex_helper.Group">[docs]</a><span class="k">class</span> <span class="nc">Group</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used to represent a capturing group in the pattern string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
</div>
<div class="viewcode-block" id="NonCapture"><a class="viewcode-back" href="../../../django.utils.html#django.utils.regex_helper.NonCapture">[docs]</a><span class="k">class</span> <span class="nc">NonCapture</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used to represent a non-capturing group in the pattern string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
</div>
<div class="viewcode-block" id="normalize"><a class="viewcode-back" href="../../../django.utils.html#django.utils.regex_helper.normalize">[docs]</a><span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a reg-exp pattern, normalizes it to a list of forms that suffice for</span>
<span class="sd">    reverse matching. This does the following:</span>

<span class="sd">    (1) For any repeating sections, keeps the minimum number of occurrences</span>
<span class="sd">        permitted (this means zero for optional groups).</span>
<span class="sd">    (2) If an optional group includes parameters, include one occurrence of</span>
<span class="sd">        that group (along with the zero occurrence case from step (1)).</span>
<span class="sd">    (3) Select the first (essentially an arbitrary) element from any character</span>
<span class="sd">        class. Select an arbitrary character for any unordered class (e.g. &#39;.&#39;</span>
<span class="sd">        or &#39;\w&#39;) in the pattern.</span>
<span class="sd">    (5) Ignore comments and any of the reg-exp flags that won&#39;t change</span>
<span class="sd">        what we construct (&quot;iLmsu&quot;). &quot;(?x)&quot; is an error, however.</span>
<span class="sd">    (6) Raise an error on all other non-capturing (?...) forms (e.g.</span>
<span class="sd">        look-ahead and look-behind matches) and any disjunctive (&#39;|&#39;)</span>
<span class="sd">        constructs.</span>

<span class="sd">    Django&#39;s URLs for forward resolving are either all positional arguments or</span>
<span class="sd">    all keyword arguments. That is assumed here, as well. Although reverse</span>
<span class="sd">    resolving can be done using positional args when keyword args are</span>
<span class="sd">    specified, the two cannot be mixed in the same reverse() call.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Do a linear scan to work out the special features of this pattern. The</span>
    <span class="c"># idea is that we scan once here and collect all the information we need to</span>
    <span class="c"># make future decisions.</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">non_capturing_groups</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">consume_next</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">pattern_iter</span> <span class="o">=</span> <span class="n">next_char</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">pattern</span><span class="p">))</span>
    <span class="n">num_args</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c"># A &quot;while&quot; loop is used here because later on we need to be able to peek</span>
    <span class="c"># at the next character and possibly go around without consuming another</span>
    <span class="c"># one at the top of the loop.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ch</span><span class="p">,</span> <span class="n">escaped</span> <span class="o">=</span> <span class="n">pattern_iter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">zip</span><span class="p">([</span><span class="s">u&#39;&#39;</span><span class="p">],</span>  <span class="p">[[]])</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">escaped</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span><span class="p">:</span>
                <span class="c"># Replace &quot;any character&quot; with an arbitrary representative.</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">u&quot;.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;|&#39;</span><span class="p">:</span>
                <span class="c"># FIXME: One day we&#39;ll should do this, but not in 1.0.</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&quot;^&quot;</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;$&#39;</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;)&#39;</span><span class="p">:</span>
                <span class="c"># This can only be the end of a non-capturing group, since all</span>
                <span class="c"># other unescaped parentheses are handled by the grouping</span>
                <span class="c"># section later (and the full group is handled there).</span>
                <span class="c">#</span>
                <span class="c"># We regroup everything inside the capturing group so that it</span>
                <span class="c"># can be quantified, if necessary.</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">non_capturing_groups</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">inner</span> <span class="o">=</span> <span class="n">NonCapture</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">start</span><span class="p">:])</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[:</span><span class="n">start</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">inner</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;[&#39;</span><span class="p">:</span>
                <span class="c"># Replace ranges with the first character in the range.</span>
                <span class="n">ch</span><span class="p">,</span> <span class="n">escaped</span> <span class="o">=</span> <span class="n">pattern_iter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
                <span class="n">ch</span><span class="p">,</span> <span class="n">escaped</span> <span class="o">=</span> <span class="n">pattern_iter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="k">while</span> <span class="n">escaped</span> <span class="ow">or</span> <span class="n">ch</span> <span class="o">!=</span> <span class="s">&#39;]&#39;</span><span class="p">:</span>
                    <span class="n">ch</span><span class="p">,</span> <span class="n">escaped</span> <span class="o">=</span> <span class="n">pattern_iter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;(&#39;</span><span class="p">:</span>
                <span class="c"># Some kind of group.</span>
                <span class="n">ch</span><span class="p">,</span> <span class="n">escaped</span> <span class="o">=</span> <span class="n">pattern_iter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ch</span> <span class="o">!=</span> <span class="s">&#39;?&#39;</span> <span class="ow">or</span> <span class="n">escaped</span><span class="p">:</span>
                    <span class="c"># A positional group</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;_</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">num_args</span>
                    <span class="n">num_args</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Group</span><span class="p">(((</span><span class="s">u&quot;</span><span class="si">%%</span><span class="s">(</span><span class="si">%s</span><span class="s">)s&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">),</span> <span class="n">name</span><span class="p">)))</span>
                    <span class="n">walk_to_end</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">pattern_iter</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ch</span><span class="p">,</span> <span class="n">escaped</span> <span class="o">=</span> <span class="n">pattern_iter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="s">&quot;iLmsu#&quot;</span><span class="p">:</span>
                        <span class="c"># All of these are ignorable. Walk to the end of the</span>
                        <span class="c"># group.</span>
                        <span class="n">walk_to_end</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">pattern_iter</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;:&#39;</span><span class="p">:</span>
                        <span class="c"># Non-capturing group</span>
                        <span class="n">non_capturing_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">ch</span> <span class="o">!=</span> <span class="s">&#39;P&#39;</span><span class="p">:</span>
                        <span class="c"># Anything else, other than a named group, is something</span>
                        <span class="c"># we cannot reverse.</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Non-reversible reg-exp portion: &#39;(?</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">ch</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ch</span><span class="p">,</span> <span class="n">escaped</span> <span class="o">=</span> <span class="n">pattern_iter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">ch</span> <span class="o">!=</span> <span class="s">&#39;&lt;&#39;</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Non-reversible reg-exp portion: &#39;(?P</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">ch</span><span class="p">)</span>
                        <span class="c"># We are in a named capturing group. Extra the name and</span>
                        <span class="c"># then skip to the end.</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">ch</span><span class="p">,</span> <span class="n">escaped</span> <span class="o">=</span> <span class="n">pattern_iter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                        <span class="k">while</span> <span class="n">ch</span> <span class="o">!=</span> <span class="s">&#39;&gt;&#39;</span><span class="p">:</span>
                            <span class="n">name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
                            <span class="n">ch</span><span class="p">,</span> <span class="n">escaped</span> <span class="o">=</span> <span class="n">pattern_iter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                        <span class="n">param</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Group</span><span class="p">(((</span><span class="s">u&quot;</span><span class="si">%%</span><span class="s">(</span><span class="si">%s</span><span class="s">)s&quot;</span> <span class="o">%</span> <span class="n">param</span><span class="p">),</span> <span class="n">param</span><span class="p">)))</span>
                        <span class="n">walk_to_end</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">pattern_iter</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="ow">in</span> <span class="s">&quot;*?+{&quot;</span><span class="p">:</span>
                <span class="c"># Quanitifers affect the previous item in the result list.</span>
                <span class="n">count</span><span class="p">,</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">get_quantifier</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">pattern_iter</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ch</span><span class="p">:</span>
                    <span class="c"># We had to look ahead, but it wasn&#39;t need to compute the</span>
                    <span class="c"># quanitifer, so use this character next time around the</span>
                    <span class="c"># main loop.</span>
                    <span class="n">consume_next</span> <span class="o">=</span> <span class="bp">False</span>

                <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">contains</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">Group</span><span class="p">):</span>
                        <span class="c"># If we are quantifying a capturing group (or</span>
                        <span class="c"># something containing such a group) and the minimum is</span>
                        <span class="c"># zero, we must also handle the case of one occurrence</span>
                        <span class="c"># being present. All the quantifiers (except {0,0},</span>
                        <span class="c"># which we conveniently ignore) that have a 0 minimum</span>
                        <span class="c"># also allow a single occurrence.</span>
                        <span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Choice</span><span class="p">([</span><span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Anything else is a literal.</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">consume_next</span><span class="p">:</span>
                <span class="n">ch</span><span class="p">,</span> <span class="n">escaped</span> <span class="o">=</span> <span class="n">pattern_iter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">consume_next</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
        <span class="c"># A case of using the disjunctive form. No results for you!</span>
        <span class="k">return</span> <span class="nb">zip</span><span class="p">([</span><span class="s">u&#39;&#39;</span><span class="p">],</span>  <span class="p">[[]])</span>

    <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">flatten_result</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="next_char"><a class="viewcode-back" href="../../../django.utils.html#django.utils.regex_helper.next_char">[docs]</a><span class="k">def</span> <span class="nf">next_char</span><span class="p">(</span><span class="n">input_iter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An iterator that yields the next character from &quot;pattern_iter&quot;, respecting</span>
<span class="sd">    escape sequences. An escaped character is replaced by a representative of</span>
<span class="sd">    its class (e.g. \w -&gt; &quot;x&quot;). If the escaped character is one that is</span>
<span class="sd">    skipped, it is not returned (the next character is returned instead).</span>

<span class="sd">    Yields the next character, along with a boolean indicating whether it is a</span>
<span class="sd">    raw (unescaped) character or not.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">input_iter</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="o">!=</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">ch</span><span class="p">,</span> <span class="bp">False</span>
            <span class="k">continue</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">input_iter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="n">representative</span> <span class="o">=</span> <span class="n">ESCAPE_MAPPINGS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">representative</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">yield</span> <span class="n">representative</span><span class="p">,</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="walk_to_end"><a class="viewcode-back" href="../../../django.utils.html#django.utils.regex_helper.walk_to_end">[docs]</a><span class="k">def</span> <span class="nf">walk_to_end</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">input_iter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The iterator is currently inside a capturing group. We want to walk to the</span>
<span class="sd">    close of this group, skipping over any nested groups and handling escaped</span>
<span class="sd">    parentheses correctly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;(&#39;</span><span class="p">:</span>
        <span class="n">nesting</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nesting</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ch</span><span class="p">,</span> <span class="n">escaped</span> <span class="ow">in</span> <span class="n">input_iter</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">escaped</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;(&#39;</span><span class="p">:</span>
            <span class="n">nesting</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;)&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">nesting</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">nesting</span> <span class="o">-=</span> <span class="mi">1</span>
</div>
<div class="viewcode-block" id="get_quantifier"><a class="viewcode-back" href="../../../django.utils.html#django.utils.regex_helper.get_quantifier">[docs]</a><span class="k">def</span> <span class="nf">get_quantifier</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">input_iter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse a quantifier from the input, where &quot;ch&quot; is the first character in the</span>
<span class="sd">    quantifier.</span>

<span class="sd">    Returns the minimum number of occurences permitted by the quantifier and</span>
<span class="sd">    either None or the next character from the input_iter if the next character</span>
<span class="sd">    is not part of the quantifier.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="s">&#39;*?+&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ch2</span><span class="p">,</span> <span class="n">escaped</span> <span class="o">=</span> <span class="n">input_iter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="n">ch2</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">ch2</span> <span class="o">==</span> <span class="s">&#39;?&#39;</span><span class="p">:</span>
            <span class="n">ch2</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;+&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ch2</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ch2</span>

    <span class="n">quant</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">ch</span> <span class="o">!=</span> <span class="s">&#39;}&#39;</span><span class="p">:</span>
        <span class="n">ch</span><span class="p">,</span> <span class="n">escaped</span> <span class="o">=</span> <span class="n">input_iter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="n">quant</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
    <span class="n">quant</span> <span class="o">=</span> <span class="n">quant</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">values</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">quant</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>

    <span class="c"># Consume the trailing &#39;?&#39;, if necessary.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ch</span><span class="p">,</span> <span class="n">escaped</span> <span class="o">=</span> <span class="n">input_iter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;?&#39;</span><span class="p">:</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">ch</span>
</div>
<div class="viewcode-block" id="contains"><a class="viewcode-back" href="../../../django.utils.html#django.utils.regex_helper.contains">[docs]</a><span class="k">def</span> <span class="nf">contains</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns True if the &quot;source&quot; contains an instance of &quot;inst&quot;. False,</span>
<span class="sd">    otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">NonCapture</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">contains</span><span class="p">(</span><span class="n">elt</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="flatten_result"><a class="viewcode-back" href="../../../django.utils.html#django.utils.regex_helper.flatten_result">[docs]</a><span class="k">def</span> <span class="nf">flatten_result</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Turns the given source sequence into a list of reg-exp possibilities and</span>
<span class="sd">    their arguments. Returns a list of strings and a list of argument lists.</span>
<span class="sd">    Each of the two lists will be of the same length.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="s">u&#39;&#39;</span><span class="p">],</span> <span class="p">[[]]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">Group</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">source</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">source</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">source</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">params</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="s">u&#39;&#39;</span><span class="p">]</span>
    <span class="n">result_args</span> <span class="o">=</span> <span class="p">[[]]</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">last</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">elt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elt</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">piece</span> <span class="o">=</span> <span class="s">u&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="n">last</span><span class="p">:</span><span class="n">pos</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elt</span><span class="p">,</span> <span class="n">Group</span><span class="p">):</span>
            <span class="n">piece</span> <span class="o">+=</span> <span class="n">elt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">elt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)):</span>
            <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">piece</span>
            <span class="k">if</span> <span class="n">param</span><span class="p">:</span>
                <span class="n">result_args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elt</span><span class="p">,</span> <span class="p">(</span><span class="n">Choice</span><span class="p">,</span> <span class="n">NonCapture</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elt</span><span class="p">,</span> <span class="n">NonCapture</span><span class="p">):</span>
                <span class="n">elt</span> <span class="o">=</span> <span class="p">[</span><span class="n">elt</span><span class="p">]</span>
            <span class="n">inner_result</span><span class="p">,</span> <span class="n">inner_args</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">elt</span><span class="p">:</span>
                <span class="n">res</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">flatten_result</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">inner_result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="n">inner_args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="n">new_result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">new_args</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">args</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">result_args</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i_item</span><span class="p">,</span> <span class="n">i_args</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">inner_result</span><span class="p">,</span> <span class="n">inner_args</span><span class="p">):</span>
                    <span class="n">new_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span> <span class="o">+</span> <span class="n">i_item</span><span class="p">)</span>
                    <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">args</span><span class="p">[:]</span> <span class="o">+</span> <span class="n">i_args</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">new_result</span>
            <span class="n">result_args</span> <span class="o">=</span> <span class="n">new_args</span>
    <span class="k">if</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">last</span><span class="p">:</span>
        <span class="n">piece</span> <span class="o">=</span> <span class="s">u&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="n">last</span><span class="p">:])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)):</span>
            <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">piece</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">result_args</span>
</pre></div></div>

      </div>
      <div class="bottomnav">
      
        <p>
        <a href="/">Home</a>:
        <a class="uplink" href="../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2012, HDKNR.COM.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2pre.
    </div>
  </body>
</html>