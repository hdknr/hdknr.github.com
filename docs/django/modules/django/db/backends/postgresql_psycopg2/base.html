

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>django.db.backends.postgresql_psycopg2.base &mdash; Django Cheat 1 documentation</title>
    
    <link rel="stylesheet" href="../../../../../static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../../static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../static/doctools.js"></script>
    <script type="text/javascript" src="../../../../../static/theme_extras.js"></script>
    <link rel="top" title="Django Cheat 1 documentation" href="../../../../../index.html" />
    <link rel="up" title="django.db.backends" href="../../backends.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../../../../../index.html">
          <span>Django Cheat 1 documentation</span></a></h1>
        <h2 class="heading"><span>django.db.backends.postgresql_psycopg2.base</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a href="/">Home</a>:
        <a class="uplink" href="../../../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for django.db.backends.postgresql_psycopg2.base</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">PostgreSQL database backend for Django.</span>

<span class="sd">Requires psycopg 2: http://initd.org/projects/psycopg2</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">django.db.backends</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">django.db.backends.signals</span> <span class="kn">import</span> <span class="n">connection_created</span>
<span class="kn">from</span> <span class="nn">django.db.backends.postgresql.operations</span> <span class="kn">import</span> <span class="n">DatabaseOperations</span> <span class="k">as</span> <span class="n">PostgresqlDatabaseOperations</span>
<span class="kn">from</span> <span class="nn">django.db.backends.postgresql.client</span> <span class="kn">import</span> <span class="n">DatabaseClient</span>
<span class="kn">from</span> <span class="nn">django.db.backends.postgresql.creation</span> <span class="kn">import</span> <span class="n">DatabaseCreation</span>
<span class="kn">from</span> <span class="nn">django.db.backends.postgresql.version</span> <span class="kn">import</span> <span class="n">get_version</span>
<span class="kn">from</span> <span class="nn">django.db.backends.postgresql_psycopg2.introspection</span> <span class="kn">import</span> <span class="n">DatabaseIntrospection</span>
<span class="kn">from</span> <span class="nn">django.utils.safestring</span> <span class="kn">import</span> <span class="n">SafeUnicode</span><span class="p">,</span> <span class="n">SafeString</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">psycopg2</span> <span class="kn">as</span> <span class="nn">Database</span>
    <span class="kn">import</span> <span class="nn">psycopg2.extensions</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ImproperlyConfigured</span>
    <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s">&quot;Error loading psycopg2 module: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

<span class="n">DatabaseError</span> <span class="o">=</span> <span class="n">Database</span><span class="o">.</span><span class="n">DatabaseError</span>
<span class="n">IntegrityError</span> <span class="o">=</span> <span class="n">Database</span><span class="o">.</span><span class="n">IntegrityError</span>

<span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">register_type</span><span class="p">(</span><span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>
<span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">register_adapter</span><span class="p">(</span><span class="n">SafeString</span><span class="p">,</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">QuotedString</span><span class="p">)</span>
<span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">register_adapter</span><span class="p">(</span><span class="n">SafeUnicode</span><span class="p">,</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">QuotedString</span><span class="p">)</span>

<div class="viewcode-block" id="CursorWrapper"><a class="viewcode-back" href="../../../../../django.db.backends.postgresql_psycopg2.html#django.db.backends.postgresql_psycopg2.base.CursorWrapper">[docs]</a><span class="k">class</span> <span class="nc">CursorWrapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A thin wrapper around psycopg2&#39;s normal cursor class so that we can catch</span>
<span class="sd">    particular exception instances and reraise them with the right types.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="n">cursor</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Database</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">(</span><span class="o">*</span><span class="nb">tuple</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">Database</span><span class="o">.</span><span class="n">DatabaseError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">DatabaseError</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">DatabaseError</span><span class="p">(</span><span class="o">*</span><span class="nb">tuple</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">executemany</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Database</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">(</span><span class="o">*</span><span class="nb">tuple</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">Database</span><span class="o">.</span><span class="n">DatabaseError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">DatabaseError</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">DatabaseError</span><span class="p">(</span><span class="o">*</span><span class="nb">tuple</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">)</span>
</div>
<span class="k">class</span> <span class="nc">DatabaseFeatures</span><span class="p">(</span><span class="n">BaseDatabaseFeatures</span><span class="p">):</span>
    <span class="n">needs_datetime_string_cast</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">can_return_id_from_insert</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">requires_rollback_on_dirty_transaction</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">has_real_datatype</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">can_defer_constraint_checks</span> <span class="o">=</span> <span class="bp">True</span>

<span class="k">class</span> <span class="nc">DatabaseOperations</span><span class="p">(</span><span class="n">PostgresqlDatabaseOperations</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">last_executed_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="c"># With psycopg2, cursor objects have a &quot;query&quot; attribute that is the</span>
        <span class="c"># exact query sent to the database. See docs here:</span>
        <span class="c"># http://www.initd.org/tracker/psycopg/wiki/psycopg2_documentation#postgresql-status-message-and-executed-query</span>
        <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">query</span>

    <span class="k">def</span> <span class="nf">return_insert_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;RETURNING </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">()</span>

<span class="k">class</span> <span class="nc">DatabaseWrapper</span><span class="p">(</span><span class="n">BaseDatabaseWrapper</span><span class="p">):</span>
    <span class="n">vendor</span> <span class="o">=</span> <span class="s">&#39;postgresql&#39;</span>
    <span class="n">operators</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;exact&#39;</span><span class="p">:</span> <span class="s">&#39;= </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="s">&#39;iexact&#39;</span><span class="p">:</span> <span class="s">&#39;= UPPER(</span><span class="si">%s</span><span class="s">)&#39;</span><span class="p">,</span>
        <span class="s">&#39;contains&#39;</span><span class="p">:</span> <span class="s">&#39;LIKE </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="s">&#39;icontains&#39;</span><span class="p">:</span> <span class="s">&#39;LIKE UPPER(</span><span class="si">%s</span><span class="s">)&#39;</span><span class="p">,</span>
        <span class="s">&#39;regex&#39;</span><span class="p">:</span> <span class="s">&#39;~ </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="s">&#39;iregex&#39;</span><span class="p">:</span> <span class="s">&#39;~* </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="s">&#39;gt&#39;</span><span class="p">:</span> <span class="s">&#39;&gt; </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="s">&#39;gte&#39;</span><span class="p">:</span> <span class="s">&#39;&gt;= </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="s">&#39;lt&#39;</span><span class="p">:</span> <span class="s">&#39;&lt; </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="s">&#39;lte&#39;</span><span class="p">:</span> <span class="s">&#39;&lt;= </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="s">&#39;startswith&#39;</span><span class="p">:</span> <span class="s">&#39;LIKE </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="s">&#39;endswith&#39;</span><span class="p">:</span> <span class="s">&#39;LIKE </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="s">&#39;istartswith&#39;</span><span class="p">:</span> <span class="s">&#39;LIKE UPPER(</span><span class="si">%s</span><span class="s">)&#39;</span><span class="p">,</span>
        <span class="s">&#39;iendswith&#39;</span><span class="p">:</span> <span class="s">&#39;LIKE UPPER(</span><span class="si">%s</span><span class="s">)&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DatabaseWrapper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">DatabaseFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">autocommit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings_dict</span><span class="p">[</span><span class="s">&quot;OPTIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;autocommit&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">uses_autocommit</span> <span class="o">=</span> <span class="n">autocommit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_isolation_level</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="ow">not</span> <span class="n">autocommit</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ops</span> <span class="o">=</span> <span class="n">DatabaseOperations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">DatabaseClient</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">creation</span> <span class="o">=</span> <span class="n">DatabaseCreation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">introspection</span> <span class="o">=</span> <span class="n">DatabaseIntrospection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation</span> <span class="o">=</span> <span class="n">BaseDatabaseValidation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">new_connection</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">set_tz</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">settings_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings_dict</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">new_connection</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">set_tz</span> <span class="o">=</span> <span class="n">settings_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;TIME_ZONE&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;NAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ImproperlyConfigured</span>
                <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s">&quot;You need to specify NAME in your Django settings file.&quot;</span><span class="p">)</span>
            <span class="n">conn_params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;database&#39;</span><span class="p">:</span> <span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;NAME&#39;</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="n">conn_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;OPTIONS&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;autocommit&#39;</span> <span class="ow">in</span> <span class="n">conn_params</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">conn_params</span><span class="p">[</span><span class="s">&#39;autocommit&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;USER&#39;</span><span class="p">]:</span>
                <span class="n">conn_params</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;USER&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;PASSWORD&#39;</span><span class="p">]:</span>
                <span class="n">conn_params</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;PASSWORD&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;HOST&#39;</span><span class="p">]:</span>
                <span class="n">conn_params</span><span class="p">[</span><span class="s">&#39;host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;HOST&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;PORT&#39;</span><span class="p">]:</span>
                <span class="n">conn_params</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;PORT&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">Database</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="n">conn_params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">set_client_encoding</span><span class="p">(</span><span class="s">&#39;UTF8&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isolation_level</span><span class="p">)</span>
            <span class="n">connection_created</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">tzinfo_factory</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">new_connection</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">set_tz</span><span class="p">:</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SET TIME ZONE </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;TIME_ZONE&#39;</span><span class="p">]])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_version&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="n">get_version</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="c"># No savepoint support for earlier version of PostgreSQL.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">uses_savepoints</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">uses_autocommit</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="c"># FIXME: Needs extra code to do reliable model insert</span>
                    <span class="c"># handling, so we forbid it for now.</span>
                    <span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ImproperlyConfigured</span>
                    <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s">&quot;You cannot use autocommit=True with PostgreSQL prior to 8.2 at the moment.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># FIXME: Eventually we&#39;re enable this by default for</span>
                    <span class="c"># versions that support it, but, right now, that&#39;s hard to</span>
                    <span class="c"># do without breaking other things (#10509).</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">can_return_id_from_insert</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">CursorWrapper</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_enter_transaction_management</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">managed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Switch the isolation level when needing transaction support, so that</span>
<span class="sd">        the same transaction is visible across all the queries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">uses_autocommit</span> <span class="ow">and</span> <span class="n">managed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isolation_level</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_isolation_level</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_leave_transaction_management</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">managed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If the normal operating mode is &quot;autocommit&quot;, switch back to that when</span>
<span class="sd">        leaving transaction management.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">uses_autocommit</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">managed</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">isolation_level</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_isolation_level</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_isolation_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Do all the related feature configurations for changing isolation</span>
<span class="sd">        levels. This doesn&#39;t touch the uses_autocommit feature, since that</span>
<span class="sd">        controls the movement *between* isolation levels.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">level</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isolation_level</span> <span class="o">=</span> <span class="n">level</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">uses_savepoints</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">Database</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">(</span><span class="o">*</span><span class="nb">tuple</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
</pre></div>

      </div>
      <div class="bottomnav">
      
        <p>
        <a href="/">Home</a>:
        <a class="uplink" href="../../../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2012, HDKNR.COM.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2pre.
    </div>
  </body>
</html>