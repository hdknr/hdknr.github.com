

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Monitoring and Management Guide &mdash; Celery 1 documentation</title>
    
    <link rel="stylesheet" href="../static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../static/jquery.js"></script>
    <script type="text/javascript" src="../static/underscore.js"></script>
    <script type="text/javascript" src="../static/doctools.js"></script>
    <script type="text/javascript" src="../static/theme_extras.js"></script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="top" title="Celery 1 documentation" href="../index.html" />
    <link rel="up" title="User Guide" href="index.html" />
    <link rel="next" title="Security" href="security.html" />
    <link rel="prev" title="Routing Tasks" href="routing.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../index.html">
          <span>Celery 1 documentation</span></a></h1>
        <h2 class="heading"><span>Monitoring and Management Guide</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a href="/">Home</a>:
        «&#160;&#160;<a href="routing.html">Routing Tasks</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="security.html">Security</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="monitoring-and-management-guide">
<span id="guide-monitoring"></span><h1>Monitoring and Management Guide<a class="headerlink" href="#monitoring-and-management-guide" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id4">Introduction</a></li>
<li><a class="reference internal" href="#workers" id="id5">Workers</a><ul>
<li><a class="reference internal" href="#celery-management-command-line-utilities" id="id6"><tt class="docutils literal"><span class="pre">celery</span></tt>: Management Command-line Utilities</a><ul>
<li><a class="reference internal" href="#commands" id="id7">Commands</a></li>
<li><a class="reference internal" href="#specifying-destination-nodes" id="id8">Specifying destination nodes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#celery-flower-web-interface" id="id9">Celery Flower: Web interface</a><ul>
<li><a class="reference internal" href="#features" id="id10">Features</a></li>
<li><a class="reference internal" href="#usage" id="id11">Usage</a></li>
</ul>
</li>
<li><a class="reference internal" href="#django-admin-monitor" id="id12">Django Admin Monitor</a><ul>
<li><a class="reference internal" href="#starting-the-monitor" id="id13">Starting the monitor</a></li>
<li><a class="reference internal" href="#shutter-frequency" id="id14">Shutter frequency</a></li>
<li><a class="reference internal" href="#resetting-monitor-data" id="id15">Resetting monitor data</a></li>
<li><a class="reference internal" href="#expiration" id="id16">Expiration</a></li>
<li><a class="reference internal" href="#using-outside-of-django" id="id17">Using outside of Django</a></li>
</ul>
</li>
<li><a class="reference internal" href="#celery-events-curses-monitor" id="id18">celery events: Curses Monitor</a></li>
<li><a class="reference internal" href="#celerymon-web-monitor" id="id19">celerymon: Web monitor</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rabbitmq" id="id20">RabbitMQ</a><ul>
<li><a class="reference internal" href="#inspecting-queues" id="id21">Inspecting queues</a></li>
</ul>
</li>
<li><a class="reference internal" href="#redis" id="id22">Redis</a><ul>
<li><a class="reference internal" href="#monitoring-redis-queues" id="id23">Inspecting queues</a></li>
</ul>
</li>
<li><a class="reference internal" href="#munin" id="id24">Munin</a></li>
<li><a class="reference internal" href="#events" id="id25">Events</a><ul>
<li><a class="reference internal" href="#snapshots" id="id26">Snapshots</a><ul>
<li><a class="reference internal" href="#custom-camera" id="id27">Custom Camera</a></li>
</ul>
</li>
<li><a class="reference internal" href="#real-time-processing" id="id28">Real-time processing</a></li>
<li><a class="reference internal" href="#event-reference" id="id29">Event Reference</a><ul>
<li><a class="reference internal" href="#task-events" id="id30">Task Events</a></li>
<li><a class="reference internal" href="#worker-events" id="id31">Worker Events</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id3" id="id32">その他コマンド</a><ul>
<li><a class="reference internal" href="#report" id="id33">report</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id4">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>There are several tools available to monitor and inspect Celery clusters.</p>
<p>This document describes some of these, as as well as
features related to monitoring, like events and broadcast commands.</p>
</div>
<div class="section" id="workers">
<span id="monitoring-workers"></span><h2><a class="toc-backref" href="#id5">Workers</a><a class="headerlink" href="#workers" title="Permalink to this headline">¶</a></h2>
<div class="section" id="celery-management-command-line-utilities">
<span id="monitoring-celeryctl"></span><h3><a class="toc-backref" href="#id6"><tt class="docutils literal"><span class="pre">celery</span></tt>: Management Command-line Utilities</a><a class="headerlink" href="#celery-management-command-line-utilities" title="Permalink to this headline">¶</a></h3>
<p class="versionadded">
<span class="versionmodified">New in version 2.1.</span></p>
<p><strong class="program">celery</strong> can also be used to inspect
and manage worker nodes (and to some degree tasks).</p>
<p>To list all the commands available do:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>celery <span class="nb">help</span>
</pre></div>
</div>
<p>or to get help for a specific command do:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>celery &lt;<span class="nb">command</span>&gt; --help
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>python ../manage.py celery <span class="nb">help</span>

---- -- - - ---- Commands- -------------- --- ------------

+ Main:
|    celery worker
|    celery events
|    celery beat
|    celery shell
|    celery multi
|    celery amqp

+ Remote Control:
|    celery status

|    celery inspect --help
|    celery inspect active
|    celery inspect active_queues
|    celery inspect ping
|    celery inspect registered
|    celery inspect report
|    celery inspect reserved
|    celery inspect revoked
|    celery inspect scheduled
|    celery inspect stats

|    celery control --help
|    celery control add_consumer &lt;queue&gt; <span class="o">[</span>exchange <span class="o">[</span><span class="nb">type</span> <span class="o">[</span>routing_key<span class="o">]]]</span>
|    celery control autoscale <span class="o">[</span>max<span class="o">]</span> <span class="o">[</span>min<span class="o">]</span>
|    celery control cancel_consumer &lt;queue&gt;
|    celery control disable_events
|    celery control enable_events
|    celery control pool_grow <span class="o">[</span><span class="nv">N</span><span class="o">=</span>1<span class="o">]</span>
|    celery control pool_shrink <span class="o">[</span><span class="nv">N</span><span class="o">=</span>1<span class="o">]</span>
|    celery control rate_limit &lt;task_name&gt; &lt;rate_limit&gt; <span class="o">(</span>e.g. 5/s | 5/m | 5/h<span class="o">)</span>&gt;
|    celery control time_limit &lt;task_name&gt; &lt;soft_secs&gt; <span class="o">[</span>hard_secs<span class="o">]</span>

+ Utils:
|    celery purge
|    celery list
|    celery migrate
|    celery call
|    celery result
|    celery report
---- -- - - --------- -- - -------------- --- ------------
</pre></div>
</div>
<div class="section" id="commands">
<h4><a class="toc-backref" href="#id7">Commands</a><a class="headerlink" href="#commands" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first"><strong>shell</strong>: Drop into a Python shell.</p>
<p>The locals will include the <tt class="docutils literal"><span class="pre">celery</span></tt> variable, which is the current app.
Also all known tasks will be automatically added to locals (unless the
<tt class="docutils literal"><span class="pre">--without-tasks</span></tt> flag is set).</p>
<p>Uses Ipython, bpython, or regular python in that order if installed.
You can force an implementation using <tt class="docutils literal"><span class="pre">--force-ipython|-I</span></tt>,
<tt class="docutils literal"><span class="pre">--force-bpython|-B</span></tt>, or <tt class="docutils literal"><span class="pre">--force-python|-P</span></tt>.</p>
</li>
<li><p class="first"><strong>status</strong>: List active nodes in this cluster</p>
<blockquote>
<div><div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>celery status
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>python ../manage.py celery status
-&gt; wzy: OK

1 node online.
</pre></div>
</div>
<div class="highlight-bash"><pre>$ python ../manage.py celery status -h
Usage: manage.py celery status [options]

Show list of workers that are online.

Options:
  -A APP, --app=APP     app instance to use (e.g. module.attr_name)
  -b BROKER, --broker=BROKER
                        url to broker.  default is 'amqp://guest@localhost//'
  --loader=LOADER       name of custom loader class to use.
  --config=CONFIG_MODULE
                        name of the configuration module (default:
                        celeryconfig)
  -q, --quiet
  -C, --no-color
  -t TIMEOUT, --timeout=TIMEOUT
                        Timeout in seconds (float) waiting for reply
  -d DESTINATION, --destination=DESTINATION
                        Comma separated list of destination node names.
  --version             show program's version number and exit
  -h, --help            show this help message and exit</pre>
</div>
</div></blockquote>
</li>
<li><p class="first"><strong>result</strong>: Show the result of a task</p>
<blockquote>
<div><ul class="simple">
<li>指定したタスクの結果を取得します。</li>
</ul>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>celery result -t tasks.add 4e196aa4-0141-4601-8138-7aa33db0f577
</pre></div>
</div>
<p>Note that you can omit the name of the task as long as the
task doesn&#8217;t use a custom result backend.</p>
<div class="highlight-bash"><pre>(tact)hdknr@wzy:~/ve/tact/src/paloma/example/app$ python ../manage.py celery result --help
Usage: manage.py celery result [options] &lt;task_id&gt;

Gives the return value for a given task id.

Examples::

    celery result 8f511516-e2f5-4da4-9d2f-0fb83a86e500
    celery result 8f511516-e2f5-4da4-9d2f-0fb83a86e500 -t tasks.add
    celery result 8f511516-e2f5-4da4-9d2f-0fb83a86e500 --traceback

Options:
  -A APP, --app=APP     app instance to use (e.g. module.attr_name)
  -b BROKER, --broker=BROKER
                        url to broker.  default is 'amqp://guest@localhost//'
  --loader=LOADER       name of custom loader class to use.
  --config=CONFIG_MODULE
                        name of the configuration module (default:
                        celeryconfig)
  -q, --quiet
  -C, --no-color
  -t TASK, --task=TASK  name of task (if custom backend)
  --traceback           show traceback instead
  --version             show program's version number and exit
  -h, --help            show this help message and exit</pre>
</div>
</div></blockquote>
</li>
<li><p class="first"><strong>purge</strong>: Purge messages from all configured task queues.</p>
<blockquote>
<div><div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>celery purge
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">There is no undo for this operation, and messages will
be permanently deleted!</p>
</div>
<div class="highlight-bash"><pre>$ python ../manage.py celery purge --help
Usage: manage.py celery purge [options]

Erase all messages from all known task queues.

WARNING: There is no undo operation for this command.

Options:
  -A APP, --app=APP     app instance to use (e.g. module.attr_name)
  -b BROKER, --broker=BROKER
                        url to broker.  default is 'amqp://guest@localhost//'
  --loader=LOADER       name of custom loader class to use.
  --config=CONFIG_MODULE
                        name of the configuration module (default:
                        celeryconfig)
  -q, --quiet
  -C, --no-color
  --version             show program's version number and exit
  -h, --help            show this help message and exit</pre>
</div>
</div></blockquote>
</li>
<li><p class="first"><strong>inspect active</strong>: List active tasks</p>
<blockquote>
<div><div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>celery inspect active
</pre></div>
</div>
<p>These are all the tasks that are currently being executed.</p>
</div></blockquote>
</li>
<li><p class="first"><strong>inspect scheduled</strong>: List scheduled ETA tasks</p>
<blockquote>
<div><div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>celery inspect scheduled
</pre></div>
</div>
<p>These are tasks reserved by the worker because they have the
<cite>eta</cite> or <cite>countdown</cite> argument set.</p>
</div></blockquote>
</li>
<li><p class="first"><strong>inspect reserved</strong>: List reserved tasks</p>
<blockquote>
<div><div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>celery inspect reserved
</pre></div>
</div>
<p>This will list all tasks that have been prefetched by the worker,
and is currently waiting to be executed (does not include tasks
with an eta).</p>
</div></blockquote>
</li>
<li><p class="first"><strong>inspect revoked</strong>: List history of revoked tasks</p>
<blockquote>
<div><div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>celery inspect revoked
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first"><strong>inspect registered</strong>: List registered tasks</p>
<blockquote>
<div><div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>celery inspect registered
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first"><strong>inspect stats</strong>: Show worker statistics</p>
<blockquote>
<div><div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>celery inspect stats
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first"><strong>control enable_events</strong>: Enable events</p>
<blockquote>
<div><div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>celery control enable_events
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first"><strong>control disable_events</strong>: Disable events</p>
<blockquote>
<div><div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>celery inspect disable_events
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first"><strong>migrate</strong>: Migrate tasks from one broker to another (<strong>EXPERIMENTAL</strong>).</p>
<blockquote>
<div><div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>celery migrate redis://localhost amqp://localhost
</pre></div>
</div>
</div></blockquote>
<p>This command will migrate all the tasks on one broker to another.
As this command is new and experimental you should be sure to have
a backup of the data before proceeding.</p>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">All <tt class="docutils literal"><span class="pre">inspect</span></tt> commands supports a <tt class="docutils literal"><span class="pre">--timeout</span></tt> argument,
This is the number of seconds to wait for responses.
You may have to increase this timeout if you&#8217;re not getting a response
due to latency.</p>
</div>
</div>
<div class="section" id="specifying-destination-nodes">
<span id="celeryctl-inspect-destination"></span><h4><a class="toc-backref" href="#id8">Specifying destination nodes</a><a class="headerlink" href="#specifying-destination-nodes" title="Permalink to this headline">¶</a></h4>
<p>By default the inspect commands operates on all workers.
You can specify a single, or a list of workers by using the
<cite>&#8211;destination</cite> argument:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>celery inspect -d w1,w2 reserved
</pre></div>
</div>
</div>
</div>
<div class="section" id="celery-flower-web-interface">
<span id="monitoring-flower"></span><h3><a class="toc-backref" href="#id9">Celery Flower: Web interface</a><a class="headerlink" href="#celery-flower-web-interface" title="Permalink to this headline">¶</a></h3>
<p>Celery Flower is a web based, real-time monitor and administration tool.</p>
<div class="section" id="features">
<h4><a class="toc-backref" href="#id10">Features</a><a class="headerlink" href="#features" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Workers monitoring and management</li>
<li>Configuration viewer</li>
<li>Worker pool control</li>
<li>Broker options viewer</li>
<li>Queues management</li>
<li>Tasks execution statistics</li>
<li>Task viewer</li>
</ul>
<p><strong>Screenshot</strong></p>
<div class="figure">
<img alt="../images/dashboard.png" src="../images/dashboard.png" />
</div>
<p>More <a class="reference external" href="https://github.com/mher/flower/tree/master/docs/screenshots">screenshots</a>:</p>
</div>
<div class="section" id="usage">
<h4><a class="toc-backref" href="#id11">Usage</a><a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h4>
<p>Install Celery Flower:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>pip install flower
</pre></div>
</div>
<p>Launch Celery Flower and open <a class="reference external" href="http://localhost:8008">http://localhost:8008</a> in browser:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>celery flower
</pre></div>
</div>
</div>
</div>
<div class="section" id="django-admin-monitor">
<span id="monitoring-django-admin"></span><h3><a class="toc-backref" href="#id12">Django Admin Monitor</a><a class="headerlink" href="#django-admin-monitor" title="Permalink to this headline">¶</a></h3>
<p class="versionadded">
<span class="versionmodified">New in version 2.1.</span></p>
<p>When you add <a class="reference external" href="http://pypi.python.org/pypi/django-celery">django-celery</a> to your Django project you will
automatically get a monitor section as part of the Django admin interface.</p>
<p>This can also be used if you&#8217;re not using Celery with a Django project.</p>
<p><em>Screenshot</em></p>
<div class="figure">
<img alt="../images/djangoceleryadmin2.jpg" src="../images/djangoceleryadmin2.jpg" />
</div>
<div class="section" id="starting-the-monitor">
<span id="monitoring-django-starting"></span><h4><a class="toc-backref" href="#id13">Starting the monitor</a><a class="headerlink" href="#starting-the-monitor" title="Permalink to this headline">¶</a></h4>
<p>The Celery section will already be present in your admin interface,
but you won&#8217;t see any data appearing until you start the snapshot camera.</p>
<p>The camera takes snapshots of the events your workers sends at regular
intervals, storing them in your database (See <a class="reference internal" href="#monitoring-snapshots"><em>Snapshots</em></a>).</p>
<p>To start the camera run:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>python manage.py celerycam
</pre></div>
</div>
<p>If you haven&#8217;t already enabled the sending of events you need to do so:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>python manage.py celery control enable_events
</pre></div>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Tip:</th><td class="field-body">You can enable events when the worker starts using the <cite>-E</cite> argument.</td>
</tr>
</tbody>
</table>
<p>Now that the camera has been started, and events have been enabled
you should be able to see your workers and the tasks in the admin interface
(it may take some time for workers to show up).</p>
<p>The admin interface shows tasks, worker nodes, and even
lets you perform some actions, like revoking and rate limiting tasks,
or shutting down worker nodes.</p>
</div>
<div class="section" id="shutter-frequency">
<span id="monitoring-django-frequency"></span><h4><a class="toc-backref" href="#id14">Shutter frequency</a><a class="headerlink" href="#shutter-frequency" title="Permalink to this headline">¶</a></h4>
<p>By default the camera takes a snapshot every second, if this is too frequent
or you want to have higher precision, then you can change this using the
<tt class="docutils literal"><span class="pre">--frequency</span></tt> argument.  This is a float describing how often, in seconds,
it should wake up to check if there are any new events:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>python manage.py celerycam --frequency<span class="o">=</span>3.0
</pre></div>
</div>
<p>The camera also supports rate limiting using the <tt class="docutils literal"><span class="pre">--maxrate</span></tt> argument.
While the frequency controls how often the camera thread wakes up,
the rate limit controls how often it will actually take a snapshot.</p>
<p>The rate limits can be specified in seconds, minutes or hours
by appending <cite>/s</cite>, <cite>/m</cite> or <cite>/h</cite> to the value.
Example: <tt class="docutils literal"><span class="pre">--maxrate=100/m</span></tt>, means &#8220;hundred writes a minute&#8221;.</p>
<p>The rate limit is off by default, which means it will take a snapshot
for every <tt class="docutils literal"><span class="pre">--frequency</span></tt> seconds.</p>
<p>The events also expire after some time, so the database doesn&#8217;t fill up.
Successful tasks are deleted after 1 day, failed tasks after 3 days,
and tasks in other states after 5 days.</p>
</div>
<div class="section" id="resetting-monitor-data">
<span id="monitoring-django-reset"></span><h4><a class="toc-backref" href="#id15">Resetting monitor data</a><a class="headerlink" href="#resetting-monitor-data" title="Permalink to this headline">¶</a></h4>
<p>To reset the monitor data you need to clear out two models:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">djcelery.models</span> <span class="kn">import</span> <span class="n">WorkerState</span><span class="p">,</span> <span class="n">TaskState</span>

<span class="go"># delete worker history</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">WorkerState</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

<span class="go"># delete task history</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">TaskState</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hidden</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">TaskState</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">purge</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="expiration">
<span id="monitoring-django-expiration"></span><h4><a class="toc-backref" href="#id16">Expiration</a><a class="headerlink" href="#expiration" title="Permalink to this headline">¶</a></h4>
<p>By default monitor data for successful tasks will expire in 1 day,
failed tasks in 3 days and pending tasks in 5 days.</p>
<p>You can change the expiry times for each of these using
adding the following settings to your <tt class="file docutils literal"><span class="pre">settings.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>

<span class="n">CELERYCAM_EXPIRE_SUCCESS</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">CELERYCAM_EXPIRE_ERROR</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">CELERYCAM_EXPIRE_PENDING</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="using-outside-of-django">
<span id="monitoring-nodjango"></span><h4><a class="toc-backref" href="#id17">Using outside of Django</a><a class="headerlink" href="#using-outside-of-django" title="Permalink to this headline">¶</a></h4>
<p><cite>django-celery</cite> also installs the <strong class="program">djcelerymon</strong> program. This
can be used by non-Django users, and runs both a web server and a snapshot
camera in the same process.</p>
<p><strong>Installing</strong></p>
<p>Using <strong class="program">pip</strong>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>pip install -U django-celery
</pre></div>
</div>
<p>or using <strong class="program">easy_install</strong>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>easy_install -U django-celery
</pre></div>
</div>
<p><strong>Running</strong></p>
<p><strong class="program">djcelerymon</strong> reads configuration from your Celery configuration
module, and sets up the Django environment using the same settings:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>djcelerymon
</pre></div>
</div>
<p>Database tables will be created the first time the monitor is run.
By default an <cite>sqlite3</cite> database file named
<tt class="file docutils literal"><span class="pre">djcelerymon.db</span></tt> is used, so make sure this file is writeable by the
user running the monitor.</p>
<p>If you want to store the events in a different database, e.g. MySQL,
then you can configure the <cite>DATABASE*</cite> settings directly in your Celery
config module.  See <a class="reference external" href="http://docs.djangoproject.com/en/dev/ref/settings/#databases">http://docs.djangoproject.com/en/dev/ref/settings/#databases</a>
for more information about the database options available.</p>
<p>You will also be asked to create a superuser (and you need to create one
to be able to log into the admin later):</p>
<div class="highlight-python"><pre>Creating table auth_permission
Creating table auth_group_permissions
[...]

You just installed Django's auth system, which means you don't
have any superusers defined.  Would you like to create
one now? (yes/no): yes
Username (Leave blank to use 'username'): username
Email address: me@example.com
Password: ******
Password (again): ******
Superuser created successfully.

[...]
Django version 1.2.1, using settings 'celeryconfig'
Development server is running at http://127.0.0.1:8000/
Quit the server with CONTROL-C.</pre>
</div>
<p>Now that the service is started you can visit the monitor
at <a class="reference external" href="http://127.0.0.1:8000">http://127.0.0.1:8000</a>, and log in using the user you created.</p>
<p>For a list of the command line options supported by <strong class="program">djcelerymon</strong>,
please see <tt class="docutils literal"><span class="pre">djcelerymon</span> <span class="pre">--help</span></tt>.</p>
</div>
</div>
<div class="section" id="celery-events-curses-monitor">
<span id="monitoring-celeryev"></span><h3><a class="toc-backref" href="#id18">celery events: Curses Monitor</a><a class="headerlink" href="#celery-events-curses-monitor" title="Permalink to this headline">¶</a></h3>
<p class="versionadded">
<span class="versionmodified">New in version 2.0.</span></p>
<p><cite>celery events</cite> is a simple curses monitor displaying
task and worker history.  You can inspect the result and traceback of tasks,
and it also supports some management commands like rate limiting and shutting
down workers.</p>
<p>Starting:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>celery events
</pre></div>
</div>
<p>You should see a screen like:</p>
<div class="figure">
<img alt="../images/celeryevshotsm1.jpg" src="../images/celeryevshotsm1.jpg" />
</div>
<p><cite>celery events</cite> is also used to start snapshot cameras (see
<a class="reference internal" href="#monitoring-snapshots"><em>Snapshots</em></a>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>celery events --camera<span class="o">=</span>&lt;camera-class&gt; --frequency<span class="o">=</span>1.0
</pre></div>
</div>
<p>and it includes a tool to dump events to <tt class="file docutils literal"><span class="pre">stdout</span></tt>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>celery events --dump
</pre></div>
</div>
<p>For a complete list of options use <tt class="docutils literal"><span class="pre">--help</span></tt>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>celery events --help
</pre></div>
</div>
</div>
<div class="section" id="celerymon-web-monitor">
<span id="monitoring-celerymon"></span><h3><a class="toc-backref" href="#id19">celerymon: Web monitor</a><a class="headerlink" href="#celerymon-web-monitor" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://github.com/celery/celerymon/">celerymon</a> is the ongoing work to create a web monitor.
It&#8217;s far from complete yet, and does currently only support
a JSON API.  Help is desperately needed for this project, so if you,
or someone you know would like to contribute templates, design, code
or help this project in any way, please get in touch!</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Tip:</th><td class="field-body">The Django admin monitor can be used even though you&#8217;re not using
Celery with a Django project.  See <a class="reference internal" href="#monitoring-nodjango"><em>Using outside of Django</em></a>.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="rabbitmq">
<span id="monitoring-rabbitmq"></span><h2><a class="toc-backref" href="#id20">RabbitMQ</a><a class="headerlink" href="#rabbitmq" title="Permalink to this headline">¶</a></h2>
<p>To manage a Celery cluster it is important to know how
RabbitMQ can be monitored.</p>
<p>RabbitMQ ships with the <a class="reference external" href="http://www.rabbitmq.com/man/rabbitmqctl.1.man.html">rabbitmqctl(1)</a> command,
with this you can list queues, exchanges, bindings,
queue lengths, the memory usage of each queue, as well
as manage users, virtual hosts and their permissions.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The default virtual host (<tt class="docutils literal"><span class="pre">&quot;/&quot;</span></tt>) is used in these
examples, if you use a custom virtual host you have to add
the <tt class="docutils literal"><span class="pre">-p</span></tt> argument to the command, e.g:
<tt class="docutils literal"><span class="pre">rabbitmqctl</span> <span class="pre">list_queues</span> <span class="pre">-p</span> <span class="pre">my_vhost</span> <span class="pre">....</span></tt></p>
</div>
<div class="section" id="inspecting-queues">
<span id="monitoring-rmq-queues"></span><h3><a class="toc-backref" href="#id21">Inspecting queues</a><a class="headerlink" href="#inspecting-queues" title="Permalink to this headline">¶</a></h3>
<p>Finding the number of tasks in a queue:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>rabbitmqctl list_queues name messages messages_ready <span class="se">\</span>
                          messages_unacknowledged
</pre></div>
</div>
<p>Here <cite>messages_ready</cite> is the number of messages ready
for delivery (sent but not received), <cite>messages_unacknowledged</cite>
is the number of messages that has been received by a worker but
not acknowledged yet (meaning it is in progress, or has been reserved).
<cite>messages</cite> is the sum of ready and unacknowledged messages.</p>
<p>Finding the number of workers currently consuming from a queue:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>rabbitmqctl list_queues name consumers
</pre></div>
</div>
<p>Finding the amount of memory allocated to a queue:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>rabbitmqctl list_queues name memory
</pre></div>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Tip:</th><td class="field-body">Adding the <tt class="docutils literal"><span class="pre">-q</span></tt> option to <a class="reference external" href="http://www.rabbitmq.com/man/rabbitmqctl.1.man.html">rabbitmqctl(1)</a> makes the output
easier to parse.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="redis">
<span id="monitoring-redis"></span><h2><a class="toc-backref" href="#id22">Redis</a><a class="headerlink" href="#redis" title="Permalink to this headline">¶</a></h2>
<p>If you&#8217;re using Redis as the broker, you can monitor the Celery cluster using
the <cite>redis-cli(1)</cite> command to list lengths of queues.</p>
<div class="section" id="monitoring-redis-queues">
<span id="id1"></span><h3><a class="toc-backref" href="#id23">Inspecting queues</a><a class="headerlink" href="#monitoring-redis-queues" title="Permalink to this headline">¶</a></h3>
<p>Finding the number of tasks in a queue:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>redis-cli -h HOST -p PORT -n DATABASE_NUMBER llen QUEUE_NAME
</pre></div>
</div>
<p>The default queue is named <cite>celery</cite>. To get all available queues, invoke:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>redis-cli -h HOST -p PORT -n DATABASE_NUMBER keys <span class="se">\*</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>If a list has no elements in Redis, it doesn&#8217;t exist. Hence it won&#8217;t show up
in the <cite>keys</cite> command output. <cite>llen</cite> for that list returns 0 in that case.</p>
<p class="last">On the other hand, if you&#8217;re also using Redis for other purposes, the output
of the <cite>keys</cite> command will include unrelated values stored in the database.
The recommended way around this is to use a dedicated <cite>DATABASE_NUMBER</cite> for
Celery.</p>
</div>
</div>
</div>
<div class="section" id="munin">
<span id="monitoring-munin"></span><h2><a class="toc-backref" href="#id24">Munin</a><a class="headerlink" href="#munin" title="Permalink to this headline">¶</a></h2>
<p>This is a list of known Munin plug-ins that can be useful when
maintaining a Celery cluster.</p>
<ul>
<li><p class="first">rabbitmq-munin: Munin plug-ins for RabbitMQ.</p>
<blockquote>
<div><p><a class="reference external" href="http://github.com/ask/rabbitmq-munin">http://github.com/ask/rabbitmq-munin</a></p>
</div></blockquote>
</li>
<li><p class="first">celery_tasks: Monitors the number of times each task type has
been executed (requires <cite>celerymon</cite>).</p>
<blockquote>
<div><p><a class="reference external" href="http://exchange.munin-monitoring.org/plugins/celery_tasks-2/details">http://exchange.munin-monitoring.org/plugins/celery_tasks-2/details</a></p>
</div></blockquote>
</li>
<li><p class="first">celery_task_states: Monitors the number of tasks in each state
(requires <cite>celerymon</cite>).</p>
<blockquote>
<div><p><a class="reference external" href="http://exchange.munin-monitoring.org/plugins/celery_tasks/details">http://exchange.munin-monitoring.org/plugins/celery_tasks/details</a></p>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="events">
<span id="monitoring-events"></span><h2><a class="toc-backref" href="#id25">Events</a><a class="headerlink" href="#events" title="Permalink to this headline">¶</a></h2>
<p>The worker has the ability to send a message whenever some event
happens.  These events are then captured by tools like <strong class="program">celerymon</strong>
and <strong class="program">celery events</strong> to monitor the cluster.</p>
<div class="section" id="snapshots">
<span id="monitoring-snapshots"></span><h3><a class="toc-backref" href="#id26">Snapshots</a><a class="headerlink" href="#snapshots" title="Permalink to this headline">¶</a></h3>
<p class="versionadded">
<span class="versionmodified">New in version 2.1.</span></p>
<p>Even a single worker can produce a huge amount of events, so storing
the history of all events on disk may be very expensive.</p>
<p>A sequence of events describes the cluster state in that time period,
by taking periodic snapshots of this state you can keep all history, but
still only periodically write it to disk.</p>
<p>To take snapshots you need a Camera class, with this you can define
what should happen every time the state is captured;  You can
write it to a database, send it by email or something else entirely.</p>
<p><strong class="program">celery events</strong> is then used to take snapshots with the camera,
for example if you want to capture state every 2 seconds using the
camera <tt class="docutils literal"><span class="pre">myapp.Camera</span></tt> you run <strong class="program">celery events</strong> with the following
arguments:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>celery events -c myapp.Camera --frequency<span class="o">=</span>2.0
</pre></div>
</div>
<div class="section" id="custom-camera">
<span id="monitoring-camera"></span><h4><a class="toc-backref" href="#id27">Custom Camera</a><a class="headerlink" href="#custom-camera" title="Permalink to this headline">¶</a></h4>
<p>Cameras can be useful if you need to capture events and do something
with those events at an interval.  For real-time event processing
you should use <a class="reference internal" href="../api/celery.events.html#celery.events.Events.Receiver" title="celery.events.Events.Receiver"><tt class="xref py py-class docutils literal"><span class="pre">celery.events.Receiver</span></tt></a> directly, like in
<a class="reference internal" href="#event-real-time-example"><em>Real-time processing</em></a>.</p>
<p>Here is an example camera, dumping the snapshot to screen:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pformat</span>

<span class="kn">from</span> <span class="nn">celery.events.snapshot</span> <span class="kn">import</span> <span class="n">Polaroid</span>

<span class="k">class</span> <span class="nc">DumpCam</span><span class="p">(</span><span class="n">Polaroid</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">on_shutter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">event_count</span><span class="p">:</span>
            <span class="c"># No new events since last snapshot.</span>
            <span class="k">return</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Workers: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pformat</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">workers</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span> <span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Tasks: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pformat</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span> <span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Total: </span><span class="si">%s</span><span class="s"> events, </span><span class="si">%s</span><span class="s"> tasks&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">state</span><span class="o">.</span><span class="n">event_count</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">task_count</span><span class="p">))</span>
</pre></div>
</div>
<p>See the API reference for <a class="reference internal" href="../api/celery.events.state.html#module-celery.events.state" title="celery.events.state"><tt class="xref py py-mod docutils literal"><span class="pre">celery.events.state</span></tt></a> to read more
about state objects.</p>
<p>Now you can use this cam with <strong class="program">celery events</strong> by specifying
it with the <em class="xref std std-option">-c</em> option:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>celery events -c myapp.DumpCam --frequency<span class="o">=</span>2.0
</pre></div>
</div>
<p>Or you can use it programmatically like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>
<span class="kn">from</span> <span class="nn">myapp</span> <span class="kn">import</span> <span class="n">DumpCam</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">State</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">recv</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">Receiver</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">handlers</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;*&#39;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">event</span><span class="p">})</span>
        <span class="k">with</span> <span class="n">DumpCam</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">):</span>
            <span class="n">recv</span><span class="o">.</span><span class="n">capture</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">celery</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="n">broker</span><span class="o">=</span><span class="s">&#39;amqp://guest@localhost//&#39;</span><span class="p">)</span>
    <span class="n">main</span><span class="p">(</span><span class="n">celery</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="real-time-processing">
<span id="event-real-time-example"></span><h3><a class="toc-backref" href="#id28">Real-time processing</a><a class="headerlink" href="#real-time-processing" title="Permalink to this headline">¶</a></h3>
<p>To process events in real-time you need the following</p>
<ul>
<li><p class="first">An event consumer (this is the <tt class="docutils literal"><span class="pre">Receiver</span></tt>)</p>
</li>
<li><p class="first">A set of handlers called when events come in.</p>
<blockquote>
<div><p>You can have different handlers for each event type,
or a catch-all handler can be used (&#8216;*&#8217;)</p>
</div></blockquote>
</li>
<li><p class="first">State (optional)</p>
<p><a class="reference internal" href="../api/celery.events.html#celery.events.Events.State" title="celery.events.Events.State"><tt class="xref py py-class docutils literal"><span class="pre">celery.events.State</span></tt></a> is a convenient in-memory representation
of tasks and workers in the cluster that is updated as events come in.</p>
<p>It encapsulates solutions for many common things, like checking if a
worker is still alive (by verifying heartbeats), merging event fields
together as events come in, making sure timestamps are in sync, and so on.</p>
</li>
</ul>
<p>Combining these you can easily process events in real-time:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>


<span class="k">def</span> <span class="nf">monitor_events</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">State</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_event</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">state</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>   <span class="c"># &lt;-- updates in-memory cluster state</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Workers online: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">worker</span> <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">workers</span> <span class="k">if</span> <span class="n">worker</span><span class="o">.</span><span class="n">alive</span>
        <span class="p">)</span>

    <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">recv</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">Receiver</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">handlers</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;*&#39;</span><span class="p">:</span> <span class="n">on_event</span><span class="p">})</span>
        <span class="n">recv</span><span class="o">.</span><span class="n">capture</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">wakeup</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The wakeup argument to <tt class="docutils literal"><span class="pre">capture</span></tt> sends a signal to all workers
to force them to send a heartbeat.  This way you can immediately see
workers when the monitor starts.</p>
</div>
<p>You can listen to specific events by specifying the handlers:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="k">def</span> <span class="nf">my_monitor</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">State</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">announce_failed_tasks</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">state</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">task_id</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s">&#39;uuid&#39;</span><span class="p">]</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&#39;TASK FAILED: </span><span class="si">%s</span><span class="s">[</span><span class="si">%s</span><span class="s">] </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">event</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">(),</span> <span class="p">))</span>

    <span class="k">def</span> <span class="nf">announce_dead_workers</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">state</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">hostname</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s">&#39;hostname&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">workers</span><span class="p">[</span><span class="n">hostname</span><span class="p">]</span><span class="o">.</span><span class="n">alive</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Worker </span><span class="si">%s</span><span class="s"> missed heartbeats&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="p">))</span>


    <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">recv</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">Receiver</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">handlers</span><span class="o">=</span><span class="p">{</span>
                <span class="s">&#39;task-failed&#39;</span><span class="p">:</span> <span class="n">announce_failed_tasks</span><span class="p">,</span>
                <span class="s">&#39;worker-heartbeat&#39;</span><span class="p">:</span> <span class="n">announce_dead_workers</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">recv</span><span class="o">.</span><span class="n">capture</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">wakeup</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">celery</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="n">broker</span><span class="o">=</span><span class="s">&#39;amqp://guest@localhost//&#39;</span><span class="p">)</span>
    <span class="n">my_monitor</span><span class="p">(</span><span class="n">celery</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="event-reference">
<span id="id2"></span><h3><a class="toc-backref" href="#id29">Event Reference</a><a class="headerlink" href="#event-reference" title="Permalink to this headline">¶</a></h3>
<p>This list contains the events sent by the worker, and their arguments.</p>
<div class="section" id="task-events">
<span id="event-reference-task"></span><h4><a class="toc-backref" href="#id30">Task Events</a><a class="headerlink" href="#task-events" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">task-sent(uuid,</span> <span class="pre">name,</span> <span class="pre">args,</span> <span class="pre">kwargs,</span> <span class="pre">retries,</span> <span class="pre">eta,</span> <span class="pre">expires,</span>
<span class="pre">queue,</span> <span class="pre">exchange,</span> <span class="pre">routing_key)</span></tt></p>
<blockquote>
<div><p>Sent when a task message is published and
the <a class="reference internal" href="../configuration.html#std:setting-CELERY_SEND_TASK_SENT_EVENT"><tt class="xref std std-setting docutils literal"><span class="pre">CELERY_SEND_TASK_SENT_EVENT</span></tt></a> setting is enabled.</p>
</div></blockquote>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">task-received(uuid,</span> <span class="pre">name,</span> <span class="pre">args,</span> <span class="pre">kwargs,</span> <span class="pre">retries,</span> <span class="pre">eta,</span> <span class="pre">hostname,</span>
<span class="pre">timestamp)</span></tt></p>
<blockquote>
<div><p>Sent when the worker receives a task.</p>
</div></blockquote>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">task-started(uuid,</span> <span class="pre">hostname,</span> <span class="pre">timestamp,</span> <span class="pre">pid)</span></tt></p>
<blockquote>
<div><p>Sent just before the worker executes the task.</p>
</div></blockquote>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">task-succeeded(uuid,</span> <span class="pre">result,</span> <span class="pre">runtime,</span> <span class="pre">hostname,</span> <span class="pre">timestamp)</span></tt></p>
<blockquote>
<div><p>Sent if the task executed successfully.</p>
<p>Runtime is the time it took to execute the task using the pool.
(Starting from the task is sent to the worker pool, and ending when the
pool result handler callback is called).</p>
</div></blockquote>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">task-failed(uuid,</span> <span class="pre">exception,</span> <span class="pre">traceback,</span> <span class="pre">hostname,</span> <span class="pre">timestamp)</span></tt></p>
<blockquote>
<div><p>Sent if the execution of the task failed.</p>
</div></blockquote>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">task-revoked(uuid,</span> <span class="pre">terminated,</span> <span class="pre">signum,</span> <span class="pre">expired)</span></tt></p>
<blockquote>
<div><p>Sent if the task has been revoked (Note that this is likely
to be sent by more than one worker).</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">terminated</span></tt> is set to true if the task process was terminated,
and the <tt class="docutils literal"><span class="pre">signum</span></tt> field set to the signal used.</li>
<li><tt class="docutils literal"><span class="pre">expired</span></tt> is set to true if the task expired.</li>
</ul>
</div></blockquote>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">task-retried(uuid,</span> <span class="pre">exception,</span> <span class="pre">traceback,</span> <span class="pre">hostname,</span> <span class="pre">timestamp)</span></tt></p>
<blockquote>
<div><p>Sent if the task failed, but will be retried in the future.</p>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="worker-events">
<span id="event-reference-worker"></span><h4><a class="toc-backref" href="#id31">Worker Events</a><a class="headerlink" href="#worker-events" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">worker-online(hostname,</span> <span class="pre">timestamp,</span> <span class="pre">freq,</span> <span class="pre">sw_ident,</span> <span class="pre">sw_ver,</span> <span class="pre">sw_sys)</span></tt></p>
<blockquote>
<div><p>The worker has connected to the broker and is online.</p>
<ul class="simple">
<li><cite>hostname</cite>: Hostname of the worker.</li>
<li><cite>timestamp</cite>: Event timestamp.</li>
<li><cite>freq</cite>: Heartbeat frequency in seconds (float).</li>
<li><cite>sw_ident</cite>: Name of worker software (e.g. <tt class="docutils literal"><span class="pre">py-celery</span></tt>).</li>
<li><cite>sw_ver</cite>: Software version (e.g. 2.2.0).</li>
<li><cite>sw_sys</cite>: Operating System (e.g. Linux, Windows, Darwin).</li>
</ul>
</div></blockquote>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">worker-heartbeat(hostname,</span> <span class="pre">timestamp,</span> <span class="pre">freq,</span> <span class="pre">sw_ident,</span> <span class="pre">sw_ver,</span> <span class="pre">sw_sys)</span></tt></p>
<blockquote>
<div><p>Sent every minute, if the worker has not sent a heartbeat in 2 minutes,
it is considered to be offline.</p>
</div></blockquote>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">worker-offline(hostname,</span> <span class="pre">timestamp,</span> <span class="pre">freq,</span> <span class="pre">sw_ident,</span> <span class="pre">sw_ver,</span> <span class="pre">sw_sys)</span></tt></p>
<blockquote>
<div><p>The worker has disconnected from the broker.</p>
</div></blockquote>
</li>
</ul>
</div>
</div>
</div>
<div class="section" id="id3">
<h2><a class="toc-backref" href="#id32">その他コマンド</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<div class="section" id="report">
<h3><a class="toc-backref" href="#id33">report</a><a class="headerlink" href="#report" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash"><pre>$ python ../manage.py celery report --help
Usage: manage.py celery report [options]

Shows information useful to include in bugreports.

Options:
  -A APP, --app=APP     app instance to use (e.g. module.attr_name)
  -b BROKER, --broker=BROKER
                        url to broker.  default is 'amqp://guest@localhost//'
  --loader=LOADER       name of custom loader class to use.
  --config=CONFIG_MODULE
                        name of the configuration module (default:
                        celeryconfig)
  -q, --quiet
  -C, --no-color
  --version             show program's version number and exit
  -h, --help            show this help message and exit</pre>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>python ../manage.py celery report

software -&gt; celery:3.0.5 <span class="o">(</span>Chiastic Slide<span class="o">)</span> kombu:2.3.2 py:2.7.3rc2
            billiard:2.7.3.11 amqplib:N/A
platform -&gt; system:Linux arch:64bit, ELF imp:CPython
loader   -&gt; djcelery.loaders.DjangoLoader
settings -&gt; transport:amqp results:database

_wrapped: &lt;django.conf.Settings object at 0x1fe5850&gt;
</pre></div>
</div>
</div>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        <a href="/">Home</a>:
        «&#160;&#160;<a href="routing.html">Routing Tasks</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="security.html">Security</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2012, HDKNR.COM.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2pre/3c28de26aac2.
    </div>
  </body>
</html>