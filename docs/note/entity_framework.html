

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Entity Framework &mdash; Note 1 documentation</title>
    
    <link rel="stylesheet" href="static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="static/jquery.js"></script>
    <script type="text/javascript" src="static/underscore.js"></script>
    <script type="text/javascript" src="static/doctools.js"></script>
    <script type="text/javascript" src="static/theme_extras.js"></script>
    <link rel="top" title="Note 1 documentation" href="index.html" />
    <link rel="next" title="Moq" href="moq.html" />
    <link rel="prev" title="Active Directory" href="active_directory.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="index.html">
          <span>Note 1 documentation</span></a></h1>
        <h2 class="heading"><span>Entity Framework</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a href="/">Home</a>:
        «&#160;&#160;<a href="active_directory.html">Active Directory</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="moq.html">Moq</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="entity-framework">
<h1><a class="toc-backref" href="#id19">Entity Framework</a><a class="headerlink" href="#entity-framework" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="id1">
<p class="topic-title first">Entity Framework</p>
<ul class="simple">
<li><a class="reference internal" href="#entity-framework" id="id19">Entity Framework</a><ul>
<li><a class="reference internal" href="#id2" id="id20">インストール</a></li>
<li><a class="reference internal" href="#id4" id="id21">マイグレーション</a><ul>
<li><a class="reference internal" href="#id5" id="id22">マイグレーションの有効化</a><ul>
<li><a class="reference internal" href="#id6" id="id23">無効にするには</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id7" id="id24">マイグレーション追加</a></li>
<li><a class="reference internal" href="#id8" id="id25">マイグレーション反映</a></li>
<li><a class="reference internal" href="#id9" id="id26">カスケード削除</a></li>
</ul>
</li>
<li><a class="reference internal" href="#one-to-one-relation" id="id27">One-To-One Relation</a></li>
<li><a class="reference internal" href="#metadata" id="id28">Metadata</a></li>
<li><a class="reference internal" href="#id10" id="id29">コマンド</a><ul>
<li><a class="reference internal" href="#enable-migrations" id="id30">Enable-Migrations</a><ul>
<li><a class="reference internal" href="#dbcontext" id="id31">DbContextが決まっていない場合</a></li>
</ul>
</li>
<li><a class="reference internal" href="#add-migration" id="id32">Add-Migration</a></li>
<li><a class="reference internal" href="#update-database" id="id33">Update-Database</a></li>
<li><a class="reference internal" href="#get-migrations" id="id34">Get-Migrations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id11" id="id35">データベース接続</a><ul>
<li><a class="reference internal" href="#id13" id="id36">プログラムで明示的に指定</a></li>
<li><a class="reference internal" href="#id14" id="id37">接続文字列を追加/編集する方法</a></li>
</ul>
</li>
<li><a class="reference internal" href="#tools-libraries" id="id38">Tools &amp; Libraries</a></li>
<li><a class="reference internal" href="#how-to" id="id39">How To</a></li>
<li><a class="reference internal" href="#id17" id="id40">その他</a><ul>
<li><a class="reference internal" href="#codeplex" id="id41">CodePlex</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id20">インストール</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>&#8220;ツール&#8221;&gt;&#8221;Library Package Manager&#8221; &gt; &#8220;Package Manager Console&#8221; でPackage Manager Console を開く</li>
<li>プロンプトにコマンドを投入して <a class="reference external" href="http://nuget.org/packages/EntityFramework/4.3.1">パッケージ</a>
パッケージのインストール。</li>
</ul>
<div class="highlight-python"><pre>PM&gt; Install-Package EntityFramework


'EntityFramework 4.3.1' already installed.
Successfully added 'EntityFramework 4.3.1' to AdConnectUnit.</pre>
</div>
<ul class="simple">
<li>プロジェクトにパッケージが追加されます(package.config)。</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;packages&gt;</span>
  <span class="nt">&lt;package</span> <span class="na">id=</span><span class="s">&quot;EntityFramework&quot;</span> <span class="na">version=</span><span class="s">&quot;4.3.1&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/packages&gt;</span>
</pre></div>
</div>
<ul class="simple">
<li>データベースにアクセスするための設定ファイルが追加されます(App.config/Web.config )</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;configuration&gt;</span>
  <span class="nt">&lt;configSections&gt;</span>
    <span class="c">&lt;!-- For more information on Entity Framework configuration, visit http://go.microsoft.com/fwlink/?LinkID=237468 --&gt;</span>
    <span class="nt">&lt;section</span> <span class="na">name=</span><span class="s">&quot;entityFramework&quot;</span>
        <span class="na">type=</span><span class="s">&quot;System.Data.Entity.Internal.ConfigFile.EntityFrameworkSection, EntityFramework, Version=4.3.1.0, Culture=neutral, PublicKeyToken=b77a5c561934e089&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/configSections&gt;</span>
  <span class="nt">&lt;entityFramework&gt;</span>
    <span class="nt">&lt;defaultConnectionFactory</span> <span class="na">type=</span><span class="s">&quot;System.Data.Entity.Infrastructure.SqlConnectionFactory, EntityFramework&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;parameters&gt;</span>
        <span class="nt">&lt;parameter</span> <span class="na">value=</span><span class="s">&quot;Data Source=.\SQLEXPRESS; Integrated Security=True; MultipleActiveResultSets=True&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/parameters&gt;</span>
    <span class="nt">&lt;/defaultConnectionFactory&gt;</span>
  <span class="nt">&lt;/entityFramework&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h2><a class="toc-backref" href="#id21">マイグレーション</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id22">マイグレーションの有効化</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span class="n">PM</span><span class="o">&gt;</span> <span class="n">Enable</span><span class="o">-</span><span class="n">Migrations</span>
</pre></div>
</div>
<div class="section" id="id6">
<h4><a class="toc-backref" href="#id23">無効にするには</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Migrationsフォルダーごと削除</li>
<li>App.config からDB接続を削除</li>
<li>不要であれば、package.config からEntityFramework を削除</li>
<li>不要であれば、EntityFramework のアセンブリ参照を削除</li>
</ul>
</div>
</div>
<div class="section" id="id7">
<h3><a class="toc-backref" href="#id24">マイグレーション追加</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>PM&gt; Add-Migration session-move-to-connect-lib</pre>
</div>
</div>
<div class="section" id="id8">
<h3><a class="toc-backref" href="#id25">マイグレーション反映</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span class="n">PM</span><span class="o">&gt;</span> <span class="n">Update</span><span class="o">-</span><span class="n">Database</span>
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h3><a class="toc-backref" href="#id26">カスケード削除</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>外部キーに ON DELETE CASCADE の制約を付けるには、
<a class="reference external" href="http://msdn.microsoft.com/en-us/library/hh829659%28v=vs.103%29.aspx">System.Data.Entity.Migrations.Builders.TableBuilder&lt;TColumns&gt;.ForeignKey()</a> メソッドの
３番目の引数を true にする。</p>
<div class="highlight-csharp"><div class="highlight"><pre><span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">Start</span> <span class="p">:</span> <span class="n">DbMigration</span>
 <span class="p">{</span>
     <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Up</span><span class="p">()</span>
     <span class="p">{</span>
         <span class="n">CreateTable</span><span class="p">(</span>
             <span class="s">&quot;Accesses&quot;</span><span class="p">,</span>
             <span class="n">c</span> <span class="p">=&gt;</span> <span class="k">new</span>
                 <span class="p">{</span>
                     <span class="n">Id</span> <span class="p">=</span> <span class="n">c</span><span class="p">.</span><span class="n">Int</span><span class="p">(</span><span class="n">nullable</span><span class="p">:</span> <span class="k">false</span><span class="p">),</span>
                     <span class="n">access_token</span> <span class="p">=</span> <span class="n">c</span><span class="p">.</span><span class="n">String</span><span class="p">(),</span>
                 <span class="p">})</span>
             <span class="p">.</span><span class="n">PrimaryKey</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span>
             <span class="p">.</span><span class="n">ForeignKey</span><span class="p">(</span>
                 <span class="s">&quot;Sessions&quot;</span><span class="p">,</span>     <span class="c1">// 参照先テーブル(principalTable)</span>
                 <span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span>      <span class="c1">// 依存キー表現</span>
                 <span class="k">true</span>            <span class="c1">// cascaeDelete(default=false)</span>
             <span class="p">)</span>
             <span class="p">.</span><span class="n">Index</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>

     <span class="p">}</span>
 <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="one-to-one-relation">
<h2><a class="toc-backref" href="#id27">One-To-One Relation</a><a class="headerlink" href="#one-to-one-relation" title="Permalink to this headline">¶</a></h2>
<p>One-To-Oneリレーションでは １方が <strong>プリンシパルエンド</strong> (principal)、もう一方が <strong>依存エンド</strong> (dependent)となります。
プリンシパルエンドは最初にINSERTされるモデルで、依存エンドがなくても存在可能です。
依存エンドはプリンシパルがINSERTされてからINSERTされます。依存エンドはプリンシパルエンドの外部キーを持っているからです。</p>
<div class="highlight-csharp"><div class="highlight"><pre><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web</span><span class="p">;</span>

<span class="k">using</span> <span class="nn">System.Data.Entity</span><span class="p">;</span>

<span class="k">using</span> <span class="nn">System.ComponentModel.DataAnnotations</span><span class="p">;</span>
<span class="c1">// for KeyAttribute,ForeignKeyAttribte</span>

<span class="k">namespace</span> <span class="nn">AdConnect.Models</span>
<span class="p">{</span>

    <span class="k">public</span> <span class="k">class</span> <span class="nc">Husband</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="n">Wife</span> <span class="n">Wife</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">class</span> <span class="nc">Wife</span>
    <span class="p">{</span>
<span class="na">        [Key,ForeignKey(&quot;Husband&quot; )]</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="n">Husband</span> <span class="n">Husband</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">class</span> <span class="nc">ConnectContext</span> <span class="p">:</span> <span class="n">DbContext</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">Husband</span><span class="p">&gt;</span> <span class="n">Husbands</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">Wife</span><span class="p">&gt;</span> <span class="n">Wives</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>プリンシパル</p>
<div class="highlight-mysql"><div class="highlight"><pre><span class="k">USE</span> <span class="p">[</span><span class="n">AdConnect</span><span class="p">.</span><span class="n">Models</span><span class="p">.</span><span class="n">ConnectContext</span><span class="p">]</span>
<span class="n">GO</span>

<span class="kt">SET</span> <span class="n">ANSI_NULLS</span> <span class="k">ON</span>
<span class="n">GO</span>

<span class="kt">SET</span> <span class="n">QUOTED_IDENTIFIER</span> <span class="k">ON</span>
<span class="n">GO</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">Husbands</span><span class="p">](</span>
    <span class="p">[</span><span class="n">Id</span><span class="p">]</span> <span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="nf">IDENTITY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span><span class="p">,</span>
 <span class="k">CONSTRAINT</span> <span class="p">[</span><span class="n">PK_Husbands</span><span class="p">]</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="nf">CLUSTERED</span>
<span class="p">(</span>
    <span class="p">[</span><span class="n">Id</span><span class="p">]</span> <span class="k">ASC</span>
<span class="p">)</span><span class="k">WITH</span> <span class="p">(</span><span class="n">PAD_INDEX</span>  <span class="o">=</span> <span class="n">OFF</span><span class="p">,</span> <span class="n">STATISTICS_NORECOMPUTE</span>  <span class="o">=</span> <span class="n">OFF</span><span class="p">,</span>
       <span class="n">IGNORE_DUP_KEY</span> <span class="o">=</span> <span class="n">OFF</span><span class="p">,</span> <span class="n">ALLOW_ROW_LOCKS</span>  <span class="o">=</span> <span class="k">ON</span><span class="p">,</span> <span class="n">ALLOW_PAGE_LOCKS</span>  <span class="o">=</span> <span class="k">ON</span><span class="p">)</span> <span class="k">ON</span> <span class="p">[</span><span class="k">PRIMARY</span><span class="p">]</span>
<span class="p">)</span> <span class="k">ON</span> <span class="p">[</span><span class="k">PRIMARY</span><span class="p">]</span>

<span class="n">GO</span>
</pre></div>
</div>
<p>依存</p>
<div class="highlight-mysql"><div class="highlight"><pre><span class="k">USE</span> <span class="p">[</span><span class="n">AdConnect</span><span class="p">.</span><span class="n">Models</span><span class="p">.</span><span class="n">ConnectContext</span><span class="p">]</span>
<span class="n">GO</span>

<span class="kt">SET</span> <span class="n">ANSI_NULLS</span> <span class="k">ON</span>
<span class="n">GO</span>

<span class="kt">SET</span> <span class="n">QUOTED_IDENTIFIER</span> <span class="k">ON</span>
<span class="n">GO</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">Wives</span><span class="p">](</span>
    <span class="p">[</span><span class="n">Id</span><span class="p">]</span> <span class="p">[</span><span class="kt">int</span><span class="p">]</span> <span class="k">NOT</span> <span class="no">NULL</span><span class="p">,</span>
 <span class="k">CONSTRAINT</span> <span class="p">[</span><span class="n">PK_Wives</span><span class="p">]</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="nf">CLUSTERED</span>
<span class="p">(</span>
    <span class="p">[</span><span class="n">Id</span><span class="p">]</span> <span class="k">ASC</span>
<span class="p">)</span><span class="k">WITH</span> <span class="p">(</span><span class="n">PAD_INDEX</span>  <span class="o">=</span> <span class="n">OFF</span><span class="p">,</span> <span class="n">STATISTICS_NORECOMPUTE</span>  <span class="o">=</span> <span class="n">OFF</span><span class="p">,</span>
        <span class="n">IGNORE_DUP_KEY</span> <span class="o">=</span> <span class="n">OFF</span><span class="p">,</span> <span class="n">ALLOW_ROW_LOCKS</span>  <span class="o">=</span> <span class="k">ON</span><span class="p">,</span> <span class="n">ALLOW_PAGE_LOCKS</span>  <span class="o">=</span> <span class="k">ON</span><span class="p">)</span> <span class="k">ON</span> <span class="p">[</span><span class="k">PRIMARY</span><span class="p">]</span>
<span class="p">)</span> <span class="k">ON</span> <span class="p">[</span><span class="k">PRIMARY</span><span class="p">]</span>

<span class="n">GO</span>

<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">Wives</span><span class="p">]</span>  <span class="k">WITH</span> <span class="k">CHECK</span> <span class="k">ADD</span>  <span class="k">CONSTRAINT</span> <span class="p">[</span><span class="n">FK_Wives_Husbands_Id</span><span class="p">]</span> <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">([</span><span class="n">Id</span><span class="p">])</span>
<span class="k">REFERENCES</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">Husbands</span><span class="p">]</span> <span class="p">([</span><span class="n">Id</span><span class="p">])</span>
<span class="n">GO</span>

<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">Wives</span><span class="p">]</span> <span class="k">CHECK</span> <span class="k">CONSTRAINT</span> <span class="p">[</span><span class="n">FK_Wives_Husbands_Id</span><span class="p">]</span>
<span class="n">GO</span>
</pre></div>
</div>
</div>
<div class="section" id="metadata">
<h2><a class="toc-backref" href="#id28">Metadata</a><a class="headerlink" href="#metadata" title="Permalink to this headline">¶</a></h2>
<p>メタデータ取得はめんどくさい気がする。
DbContextをObjetContextに変換して、MetadataWorkspaceにアクセスすることでメタデータの操作をする。
MetadataWorkspaceからモデルクラスの名前(Name)が等しいEntitySetをクエリするとそのテーブルのメタデータ
にアクセスできるっぽい。</p>
<div class="highlight-csharp"><div class="highlight"><pre><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web</span><span class="p">;</span>

<span class="c1">// メターデータ系のネームスペース</span>
<span class="k">using</span> <span class="nn">System.Data.Entity</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Data.Objects</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Data.Metadata.Edm</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Data.Entity.Infrastructure</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AdConnectTest.Models</span>
<span class="p">{</span>
    <span class="c1">/// データベースコンテキストクラス</span>

    <span class="k">public</span> <span class="k">class</span> <span class="nc">ConnectContext</span> <span class="p">:</span> <span class="n">DbContext</span>
    <span class="p">{</span>
        <span class="c1">// モデルクラス(POCO)</span>
        <span class="k">public</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">Connect</span><span class="p">.</span><span class="n">Models</span><span class="p">.</span><span class="n">Grant</span><span class="p">&gt;</span> <span class="n">Grants</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>


        <span class="c1">// DbContextからObjectContextを取得</span>
        <span class="k">public</span> <span class="n">ObjectContext</span> <span class="n">ObjectContext</span>
        <span class="p">{</span>
            <span class="k">get</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="p">((</span><span class="n">IObjectContextAdapter</span><span class="p">)</span><span class="k">this</span><span class="p">).</span><span class="n">ObjectContext</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// メタ情報</span>
        <span class="k">public</span> <span class="n">MetadataWorkspace</span> <span class="n">Meta</span>
        <span class="p">{</span>
            <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">ObjectContext</span><span class="p">.</span><span class="n">MetadataWorkspace</span><span class="p">;</span> <span class="p">}</span>
        <span class="p">}</span>


        <span class="c1">// 指定したモデルクラスのメタ情報</span>
        <span class="k">public</span> <span class="n">EntitySet</span> <span class="nf">GetTableMeta</span><span class="p">(</span><span class="n">Type</span> <span class="n">model</span><span class="p">)</span>
        <span class="p">{</span>

            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">Meta</span><span class="p">.</span><span class="n">GetItemCollection</span><span class="p">(</span><span class="n">DataSpace</span><span class="p">.</span><span class="n">SSpace</span><span class="p">)</span>
                    <span class="p">.</span><span class="n">GetItems</span><span class="p">&lt;</span><span class="n">EntityContainer</span><span class="p">&gt;()</span>
                    <span class="p">.</span><span class="n">Single</span><span class="p">()</span>
                    <span class="p">.</span><span class="n">BaseEntitySets</span>
                    <span class="p">.</span><span class="n">OfType</span><span class="p">&lt;</span><span class="n">EntitySet</span><span class="p">&gt;()</span>
                    <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="n">model</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span>
                    <span class="p">.</span><span class="n">ToArray</span><span class="p">()[</span><span class="m">0</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>これを実行するには、</p>
<div class="highlight-csharp"><div class="highlight"><pre><span class="c1">// DbContextを生成し、データベース接続を用意する</span>
<span class="n">Models</span><span class="p">.</span><span class="n">ConnectContext</span> <span class="n">ctx</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Models</span><span class="p">.</span><span class="n">ConnectContext</span><span class="p">();</span>

<span class="kt">string</span> <span class="n">grant_table_name</span> <span class="p">=</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="n">ctx</span><span class="p">.</span><span class="n">GetTableMeta</span><span class="p">(</span>
                                    <span class="k">typeof</span><span class="p">(</span><span class="n">Connect</span><span class="p">.</span><span class="n">Models</span><span class="p">.</span><span class="n">Grant</span><span class="p">)</span> <span class="c1">// POCO モデルクラス</span>
                                <span class="p">).</span><span class="n">MetadataProperties</span><span class="p">[</span><span class="s">&quot;Table&quot;</span><span class="p">].</span><span class="n">Value</span><span class="p">;</span>
</pre></div>
</div>
<p>実際のモデル名は:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">Grants</span>
</pre></div>
</div>
<p>と複数形が返る。</p>
</div>
<div class="section" id="id10">
<h2><a class="toc-backref" href="#id29">コマンド</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference internal" href="#enable-migrations">Enable-Migrations</a> : Enables Code First Migrations をプロジェクトで有効にする</li>
<li><a class="reference internal" href="#add-migration">Add-Migration</a> : ペンディングのモデル修正のマイグレーションスクリプトをスキャフォールドする</li>
<li><a class="reference internal" href="#update-database">Update-Database</a> : ペンディングされたマイグレーションをデータベースに適用</li>
<li><a class="reference internal" href="#get-migrations">Get-Migrations</a> : データベースに適用されたマイグレーションを表示する。</li>
</ul>
<div class="section" id="enable-migrations">
<h3><a class="toc-backref" href="#id30">Enable-Migrations</a><a class="headerlink" href="#enable-migrations" title="Permalink to this headline">¶</a></h3>
<div class="section" id="dbcontext">
<h4><a class="toc-backref" href="#id31">DbContextが決まっていない場合</a><a class="headerlink" href="#dbcontext" title="Permalink to this headline">¶</a></h4>
<p>Migration対象のDbContextの派生クラスが別のDLLに入っているなど、Wizardが判定できない場合は
クラスがコメントされてMigrations/Configuation.cs が作成されるので、手動で埋める。</p>
<div class="highlight-python"><pre>PM&gt; Enable-Migrations
No classes deriving from DbContext found in the current project.
Edit the generated Configuration class to specify the context to enable migrations for.
Code First Migrations enabled for project AdConnect.</pre>
</div>
<div class="highlight-csharp"><div class="highlight"><pre><span class="k">internal</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">Configuration</span> <span class="p">:</span> <span class="n">DbMigrationsConfiguration</span><span class="p">&lt;</span><span class="cm">/** TODO: put your Code First context type name here **/</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">Configuration</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">AutomaticMigrationsEnabled</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Seed</span><span class="p">(</span><span class="cm">/** TODO: put your Code First context type name here **/</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//.....</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="add-migration">
<h3><a class="toc-backref" href="#id32">Add-Migration</a><a class="headerlink" href="#add-migration" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>PM&gt; Add-Migration Start
Scaffolding migration 'Start'.
The Designer Code for this migration file includes a snapshot of your current Code First model. This snapshot is used to calculate the changes to your model when you scaffold the next migration. If you make additional changes to your model that you want to include in this migration, then you can re-scaffold it by running 'Add-Migration 201206060712563_Start' again.</pre>
</div>
</div>
<div class="section" id="update-database">
<h3><a class="toc-backref" href="#id33">Update-Database</a><a class="headerlink" href="#update-database" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>PM&gt; Update-Database
Specify the '-Verbose' flag to view the SQL statements being applied to the target database.
Applying explicit migrations: [201206050458407_InitialCreate, 201206060520281_Initial].
Applying explicit migration: 201206050458407_InitialCreate.
Applying explicit migration: 201206060520281_Initial.</pre>
</div>
</div>
<div class="section" id="get-migrations">
<h3><a class="toc-backref" href="#id34">Get-Migrations</a><a class="headerlink" href="#get-migrations" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>PM&gt; Get-Migrations -Verbose
Using NuGet project 'AdConnect'.
Using StartUp project 'AdConnect'.
Retrieving migrations that have been applied to the target database.
Target database is: 'AdConnect.Models.ConnectContext'
(DataSource: .\SQLEXPRESS, Provider: System.Data.SqlClient, Origin: Convention).
201206040429540_NonceTime
201206030843292_First</pre>
</div>
<p>ヘルプ:</p>
<div class="highlight-python"><pre>PM&gt; get-help Get-Migrations -full.</pre>
</div>
</div>
</div>
<div class="section" id="id11">
<h2><a class="toc-backref" href="#id35">データベース接続</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="http://note.harajuku-tech.org/dbcontext-class-systemdataentity">DbContext</a>
でデータベース接続が行われるルールは少しむずかしいです。</p>
<div class="section" id="id13">
<h3><a class="toc-backref" href="#id36">プログラムで明示的に指定</a><a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<p>DbContextクラスのコンストラクタにデータベース名を指定すると
app.config で指定したデータベースサーバーに指定した名前でデータベースを作るようです。</p>
<p>TestDatabase というデータベースを作るには以下のようにします</p>
<div class="highlight-csharp"><div class="highlight"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">ConnectContext</span> <span class="p">:</span> <span class="n">DbContext</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">ConnectContext</span><span class="p">()</span>
        <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="s">&quot;TestDatabase&quot;</span><span class="p">)</span>
    <span class="p">{}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">app.config からデータベース名を取得して設定するようにコードすればいいのかな？</p>
</div>
</div>
<div class="section" id="id14">
<h3><a class="toc-backref" href="#id37">接続文字列を追加/編集する方法</a><a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<p>接続文字列を設定すると app.config /web.config だけで制御可能です。
SQL Server(Express)だと &#8220;Initial Catalog&#8221; がデータベース名になります。
ポイントは <strong>name</strong> 属性に、DbContext クラスのクラス名を指定する、ということです。</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;configuration&gt;</span>
  <span class="nt">&lt;configSections&gt;</span>
    <span class="nt">&lt;section</span> <span class="na">name=</span><span class="s">&quot;entityFramework&quot;</span>
            <span class="na">type=</span><span class="s">&quot;System.Data.Entity.Internal.ConfigFile.EntityFrameworkSection, EntityFramework, Version=4.3.1.0, Culture=neutral, PublicKeyToken=b77a5c561934e089&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/configSections&gt;</span>

  <span class="c">&lt;!-- ここから追加</span>
<span class="c">        name : DbContextから派生したConnectContext</span>
<span class="c">        Initial Catalog : SQL Server(Express) のデータベース名</span>
<span class="c">  --&gt;</span>
  <span class="nt">&lt;connectionStrings&gt;</span>
   <span class="nt">&lt;add</span>
    <span class="na">name=</span><span class="s">&quot;ConnectContext&quot;</span>
    <span class="na">connectionString=</span><span class="s">&quot;Server=.\SQLEXPRESS;Initial Catalog=ConnectDB;Integrated Security=true;MultipleActiveResultSets=True;&quot;</span>
    <span class="na">providerName=</span><span class="s">&quot;System.Data.SqlClient&quot;</span>
   <span class="nt">/&gt;</span>
  <span class="nt">&lt;/connectionStrings&gt;</span>
  <span class="c">&lt;!-- ここまで追加 --&gt;</span>

  <span class="nt">&lt;entityFramework&gt;</span>
    <span class="nt">&lt;defaultConnectionFactory</span>
        <span class="na">type=</span><span class="s">&quot;System.Data.Entity.Infrastructure.SqlConnectionFactory, EntityFramework&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;parameters&gt;</span>
        <span class="nt">&lt;parameter</span>
           <span class="na">value=</span><span class="s">&quot;Data Source=.\SQLEXPRESS; Integrated Security=True; MultipleActiveResultSets=True;Initial Catalog=ConnectDB&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/parameters&gt;</span>
    <span class="nt">&lt;/defaultConnectionFactory&gt;</span>
  <span class="nt">&lt;/entityFramework&gt;</span>

<span class="nt">&lt;/configuration&gt;</span>
</pre></div>
</div>
<p>これで <a class="reference internal" href="#update-database">Update-Database</a> コマンドを実行すると、(存在しなかったら)データベースを作成してMigrationコードを実行します。</p>
</div>
</div>
<div class="section" id="tools-libraries">
<h2><a class="toc-backref" href="#id38">Tools &amp; Libraries</a><a class="headerlink" href="#tools-libraries" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>NuGet</li>
<li>JSON.Net</li>
<li>RestSharp ( <a class="reference external" href="https://github.com/restsharp/RestSharp.git">https://github.com/restsharp/RestSharp.git</a> )</li>
<li>HtmlAgilePack</li>
<li><a class="reference internal" href="moq.html"><em>Moq</em></a> ( <a class="reference external" href="https://github.com/Moq">https://github.com/Moq</a> )</li>
<li>BouncyCastle</li>
</ul>
</div>
<div class="section" id="how-to">
<h2><a class="toc-backref" href="#id39">How To</a><a class="headerlink" href="#how-to" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://note.harajuku-tech.org/entityframework-visual-studio-c-express">Entity Framework を Visual Studio C# Expressに入れてみる</a></li>
<li><a class="reference external" href="http://note.harajuku-tech.org/linq-to-entities-my-first-linq-to-entities">My first &#8220;LINQ to Entities&#8221;</a></li>
<li><a class="reference external" href="http://note.harajuku-tech.org/aspnet-mvc-entity-framework-abstrat">abstratクラスの定義は継承できます</a></li>
<li><a class="reference external" href="http://note.harajuku-tech.org/nunit-entity-framework-431-code-first-model">NUnitからもテスト可能</a></li>
<li><a class="reference external" href="http://note.harajuku-tech.org/aspnet-mvc-1">コンテキスト1</a></li>
<li><a class="reference external" href="http://note.harajuku-tech.org/aspnet-mvc-2-db">コンテキスト2</a></li>
</ul>
</div>
<div class="section" id="id17">
<h2><a class="toc-backref" href="#id40">その他</a><a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://note.harajuku-tech.org/nunit">単純なテスト</a></li>
<li><a class="reference external" href="http://note.harajuku-tech.org/aspnet-40-aspnetregiisexe-i">aspnet_regiis.exe -i 実行すること</a></li>
<li><a class="reference external" href="http://note.harajuku-tech.org/iis70-aspnet-20-40">ASP.NET 4.0 を有効にする</a></li>
<li><a class="reference external" href="http://note.harajuku-tech.org/aspnet-mvc-json">JSONを返す</a></li>
<li><a class="reference external" href="http://note.harajuku-tech.org/aspnet-controller-and-view">Control/View</a></li>
<li><a class="reference external" href="http://note.harajuku-tech.org/systemdirectoryservices">DirectoryサービスでActive Directoryにアクセス</a></li>
<li><a class="reference external" href="http://www.asp.net/entity-framework">http://www.asp.net/entity-framework</a></li>
<li>ADO.NET Entity Framework (<a class="reference external" href="http://msdn.microsoft.com/en-us/library/bb399572.aspx">http://msdn.microsoft.com/en-us/library/bb399572.aspx</a>)</li>
</ul>
<div class="section" id="codeplex">
<h3><a class="toc-backref" href="#id41">CodePlex</a><a class="headerlink" href="#codeplex" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Entity Framework Contrib (<a class="reference external" href="http://efcontrib.codeplex.com/">http://efcontrib.codeplex.com/</a>)</li>
<li>Tutorial: ADO.NET Entity Framework ( <a class="reference external" href="http://adoeftutorial.codeplex.com/">http://adoeftutorial.codeplex.com/</a> )</li>
</ul>
</div>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        <a href="/">Home</a>:
        «&#160;&#160;<a href="active_directory.html">Active Directory</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="moq.html">Moq</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2012, HDKNR.COM.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2pre/3c28de26aac2.
    </div>
  </body>
</html>