

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Trac &mdash; Note 1 documentation</title>
    
    <link rel="stylesheet" href="static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="static/jquery.js"></script>
    <script type="text/javascript" src="static/underscore.js"></script>
    <script type="text/javascript" src="static/doctools.js"></script>
    <script type="text/javascript" src="static/theme_extras.js"></script>
    <link rel="top" title="Note 1 documentation" href="index.html" />
    <link rel="next" title="Git" href="git.html" />
    <link rel="prev" title="AES: Advanced Encryption Standard" href="aes.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="index.html">
          <span>Note 1 documentation</span></a></h1>
        <h2 class="heading"><span>Trac</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a href="/">Home</a>:
        «&#160;&#160;<a href="aes.html">AES: Advanced Encryption Standard</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="git.html">Git</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="trac">
<h1>Trac<a class="headerlink" href="#trac" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#apache" id="id8">apacheでの配置</a><ul>
<li><a class="reference internal" href="#id1" id="id9">前提</a></li>
<li><a class="reference internal" href="#trac-apache-tree" id="id10">配置ディレクトリ構成例</a></li>
<li><a class="reference internal" href="#trac-apache-basedir" id="id11">ベースディレクトリ</a></li>
<li><a class="reference internal" href="#apache-macro" id="id12">apache macro</a><ul>
<li><a class="reference internal" href="#id4" id="id13">マクロ</a></li>
<li><a class="reference internal" href="#id5" id="id14">変数</a></li>
<li><a class="reference internal" href="#id6" id="id15">例</a></li>
</ul>
</li>
<li><a class="reference internal" href="#httpd-conf" id="id16">httpd.conf</a></li>
<li><a class="reference internal" href="#ssl-def" id="id17">ssl.def</a></li>
</ul>
</li>
<li><a class="reference internal" href="#trac-subversion" id="id18">Trac/Subversion</a></li>
<li><a class="reference internal" href="#subversion" id="id19">Subversion同期</a><ul>
<li><a class="reference internal" href="#id7" id="id20">同期スクリプト</a></li>
<li><a class="reference internal" href="#post-commit" id="id21">post-commit</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="apache">
<span id="trac-apache"></span><h2><a class="toc-backref" href="#id8">apacheでの配置</a><a class="headerlink" href="#apache" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id1">
<h3><a class="toc-backref" href="#id9">前提</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference internal" href="apache.html#apache-mod-macro"><em>mod_macro</em></a>  を使って定義を簡略化します。</li>
<li>{{ cname }} を trac.lafoglia.jp としてapacheで仮想ホストするとします。</li>
<li>プロジェクトを複数立てるとして、 それぞれのプロジェクト名は {{ prj }} とします。</li>
<li><a class="reference internal" href="python.html#term-python"><em class="xref std std-term">Python</em></a> は <a class="reference internal" href="python.html#term-virtualenv"><em class="xref std std-term">virtualenv</em></a> として環境を構築します。</li>
<li>移行することを考えて、全てのファイルは ベースディレクトリ以下に置きます。</li>
</ul>
</div>
<div class="section" id="trac-apache-tree">
<span id="id2"></span><h3><a class="toc-backref" href="#id10">配置ディレクトリ構成例</a><a class="headerlink" href="#trac-apache-tree" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>/home/system/trac.lafoglia.jp
│
├── cert
│   ├── cert.pem
│   └── privatekey.pem
├── conf
│   ├── httpd.conf
│   ├── macro.def
│   ├── .htpasswd.apps
│   ├── .htpasswd.services
│   └── httpd.conf.d
├── logs
│   ├── error.log
│   └── access.lg
├── prj
│   ├── apps
│   │   ├── cache
│   │   ├── svn
│   │   │   ├── conf
│   │   │   ├── dav
│   │   │   │   └── activities.d
│   │   │   ├── db
│   │   │   │   ├── revprops
│   │   │   │   │   └── 0
│   │   │   │   ├── revs
│   │   │   │   │   └── 0
│   │   │   │   ├── transactions
│   │   │   │   └── txn-protorevs
│   │   │   ├── hooks
│   │   │   └── locks
│   │   └── trac
│   │       ├── attachments
│   │       │   └── ticket
│   │       ├── conf
│   │       │   └── trac.ini
│   │       ├── db
│   │       ├── htdocs
│   │       ├── log
│   │       ├── plugins
│   │       └── templates
│   ├── services
│   │   ├── cache
│   │   ├── svn
│   │   │   ├── conf
│   │   │   ├── dav
│   │   │   │   └── activities.d
│   │   │   ├── db
│   │   │   │   ├── revprops
│   │   │   │   │   ├── 0
│   │   │   │   │   └── 1
│   │   │   │   ├── revs
│   │   │   │   │   ├── 0
│   │   │   │   │   └── 1
│   │   │   │   ├── transactions
│   │   │   │   └── txn-protorevs
│   │   │   ├── hooks
│   │   │   └── locks
│   │   └── trac
│   │       ├── attachments
│   │       │   └── ticket
│   │       ├── conf
│   │       │   └── trac.ini
│   │       ├── db
│           ├── htdocs
│           ├── log
│           ├── plugins
│           └── templates
└── www</pre>
</div>
</div>
<div class="section" id="trac-apache-basedir">
<span id="id3"></span><h3><a class="toc-backref" href="#id11">ベースディレクトリ</a><a class="headerlink" href="#trac-apache-basedir" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>/home/sites を {{ basedir }}とします。</li>
</ul>
</div>
<div class="section" id="apache-macro">
<span id="trac-apache-macro"></span><h3><a class="toc-backref" href="#id12">apache macro</a><a class="headerlink" href="#apache-macro" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id4">
<h4><a class="toc-backref" href="#id13">マクロ</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>VHost : 仮想ホスト</li>
<li>Trac  : TracとSubversionを動かす仮想ディレクトリ</li>
<li>SSL   : 証明書とキーの設定</li>
<li>WSGI  : <a class="reference internal" href="python.html#term-mod-wsgi"><em class="xref std std-term">mod_wsgi</em></a> の設定</li>
</ul>
</div>
<div class="section" id="id5">
<h4><a class="toc-backref" href="#id14">変数</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>$host : {{ cname }}</li>
<li>$base : {{ basedir }}</li>
<li>$port : ポート番号( 80, 443 .. )</li>
<li>$prt  : {{ prj }}</li>
<li>$prefix : {{ cname }} を短くして分かり易くしたもの</li>
</ul>
</div>
<div class="section" id="id6">
<h4><a class="toc-backref" href="#id15">例</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>{{basedir}}/{{cname}}/conf/macro.def を以下の用にします。</li>
</ul>
<div class="highlight-python"><pre># Virtual Host
&lt;Macro VHost $host $base $port&gt;
    &lt;VirtualHost *:$port&gt;
    #Basic
            ServerAdmin admin@$host
            ServerName  $host
            DocumentRoot /home/emdocs/$host/www/

    # BasicAuth
       &lt;Location "/" &gt;
            Include $base/$host/conf/httpd.conf.d/auth_pwd_file.def
            &lt;/Location&gt;

            Include $base/$host/conf/httpd.conf.d/wsgi.def
            Include $base/$host/conf/httpd.conf.d/trac.def
    #Log
            ErrorLog $base/$host/logs/error.log
            LogLevel warn
            CustomLog $base/$host/logs/access.log combined

    # SSL
            Include $base/$host/conf/ssl.def
    &lt;/VirtualHost&gt;
&lt;/Macro&gt;

#Virtual Directory
&lt;Macro Trac $host $base $prefix  $prj&gt;

    &lt;Location /prj/$prj &gt;
      AuthName "Secret Zone"
      AuthUserFile $base/$host/conf/.htpasswd.$prj
      Require valid-user
    &lt;/Location&gt;

    &lt;Location /prj/$prj/svn &gt;
      DAV svn
      SVNPath $base/$host/prj/$prj/svn
      SVNAutoversioning On
    &lt;/Location&gt;

    WSGIScriptAlias /prj/$prj/trac $base/$host/prj/wsgi.py

    &lt;Location /prj/$prj/trac &gt;
       WSGIProcessGroup ve_$prefix_trac_$prj
       WSGIApplicationGroup %{SERVER}
       Options All
    &lt;/Location&gt;
&lt;/Macro&gt;

#WSGI
&lt;Macro WSGI $ve $prefix $prj &gt;
    WSGIDaemonProcess ve_$prefix_trac_$prj user=www-data group=www-data threads=25 python-path=$ve/lib/python2.7/site-packages:$ve/bin
&lt;/Macro&gt;

#SSL
&lt;Macro SSL $host $base &gt;
    SSLEngine on
    SSLCertificateFile $base/$host/cert/cert.pem
    SSLCertificateKeyFile $base/$host/cert/privatekey.pem
&lt;/Macro&gt;</pre>
</div>
</div>
</div>
<div class="section" id="httpd-conf">
<span id="trac-apache-basedir-httpd-conf"></span><h3><a class="toc-backref" href="#id16">httpd.conf</a><a class="headerlink" href="#httpd-conf" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference internal" href="#trac-apache-macro"><em>apache macro</em></a> を使って次のように書きます。</li>
</ul>
<div class="highlight-python"><pre>Include /home/system/trac.lafoglia.jp/conf/macro.def

# Virtual Host
Use VHost trac.lafoglia.jp /home/system 443

# WSGI
Usr WSGI /home/system/ve/main lafoglia apps
Usr WSGI /home/system/ve/main lafoglia services

# Virtual Directory for each project
Use Trac trac.lafoglia.jp /home/system lafoglia apps
Use Trac trac.lafoglia.jp /home/system lafoglia servcies</pre>
</div>
<ul>
<li><p class="first">/home/sites/{{ cname }}/conf/httd.conf に置きます。</p>
</li>
<li><p class="first">Linuxディストリビューションの apache の設定に読みこませるようにします。</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="debian.html"><em>Debian Linux</em></a> だと /etc/apache2/site-enabled に置くので以下のようにします。</li>
</ul>
<div class="highlight-python"><pre>$ ls -l /etc/apache2/sites-enabled/

合計 0
lrwxrwxrwx 1 root root 26 2011-06-28 13:58 000-default -&gt; ../sites-available/default
lrwxrwxrwx 1 root root 48 2011-07-05 16:01 lafoglia.conf -&gt; /home/sites/trac.lafoglia.jp/conf/httpd.conf</pre>
</div>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="ssl-def">
<span id="trac-apache-ssl"></span><h3><a class="toc-backref" href="#id17">ssl.def</a><a class="headerlink" href="#ssl-def" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>ssl.def がインクルードされるときにはmacro.def が用意されているので、適切に設定します。</li>
</ul>
<div class="highlight-python"><pre>Use SSL trac.laofglia.jp /home/system</pre>
</div>
</div>
</div>
<div class="section" id="trac-subversion">
<h2><a class="toc-backref" href="#id18">Trac/Subversion</a><a class="headerlink" href="#trac-subversion" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Trac は  {{ basedir }}/{{ cnamme }}/prj/{{ prj }}/trac</li>
<li>Subversion は  {{ basedir }}/{{ cnamme }}/prj/{{ prj }}/svn</li>
<li>Python cache は  {{ basedir }}/{{ cnamme }}/prj/{{ prj }}/cache</li>
<li>trac{{ prj }} 以下に wsgi.py を置きます。これが仮想ディレクトリごとのapache設定によりWSGIプロセスに読み込まれます。</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">sys</span>
<span class="c">#</span>
<span class="n">current</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
<span class="c">#</span>
<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;TRAC_ENV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/trac&quot;</span> <span class="o">%</span> <span class="n">current</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;PYTHON_EGG_CACHE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/cache&quot;</span> <span class="o">%</span> <span class="n">current</span>
<span class="c">#</span>
<span class="kn">from</span> <span class="nn">trac.web.main</span> <span class="kn">import</span> <span class="n">dispatch_request</span>
<span class="n">application</span> <span class="o">=</span> <span class="n">dispatch_request</span>
</pre></div>
</div>
</div>
<div class="section" id="subversion">
<h2><a class="toc-backref" href="#id19">Subversion同期</a><a class="headerlink" href="#subversion" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id7">
<h3><a class="toc-backref" href="#id20">同期スクリプト</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>virualenv のパスを設定します。</li>
<li>{{ basedir }} / {{ cnamem }}  /prj/sync.bash とします。</li>
</ul>
<div class="highlight-bash"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c">#</span>
<span class="nv">PY</span><span class="o">=</span>/home/system/ve/main/bin/python
<span class="nv">TA</span><span class="o">=</span>/home/system/ve/main/bin/trac-admin
<span class="nv">BASE</span><span class="o">=</span><span class="sb">`</span>dirname <span class="nv">$0</span><span class="sb">`</span>
<span class="nb">echo</span> <span class="nv">$BASE</span>/<span class="nv">$1</span>
<span class="nv">$PY</span> <span class="nv">$TA</span> <span class="nv">$BASE</span>/<span class="nv">$1</span>/trac repository resync <span class="nv">$2</span>
</pre></div>
</div>
</div>
<div class="section" id="post-commit">
<h3><a class="toc-backref" href="#id21">post-commit</a><a class="headerlink" href="#post-commit" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>{{ basedir }}/{{ cname }}/prj/svn/hooks/post-commit から sync.bashを呼びます。</li>
</ul>
<div class="highlight-bash"><div class="highlight"><pre><span class="c">#: configure</span>

<span class="nv">BASEDIR</span><span class="o">=</span>/thome/sites
<span class="nv">CODE</span><span class="o">=</span>apps
<span class="nv">REPO</span><span class="o">=</span>apps
<span class="nv">CNAME</span><span class="o">=</span>trac.lafoglia.jp
<span class="nv">NOTIFY</span><span class="o">=</span><span class="s2">&quot;developers@$CNAME&quot;</span>
<span class="nv">TITLE</span><span class="o">=</span><span class="s2">&quot;$CNAME-$CODE&quot;</span>
<span class="nv">SCRIPT</span><span class="o">=</span>sync.bash
<span class="nv">URL</span><span class="o">=</span>https://<span class="nv">$CNAME</span>/<span class="nv">$CODE</span>/trac/browser
<span class="nv">PROJECT</span><span class="o">=</span><span class="nv">$CODE</span>

<span class="c">#: Execute Trac Synchronization</span>

<span class="nv">$BASEDIR</span>/<span class="nv">$CNAME</span>/prj/<span class="nv">$SCRIPT</span>  <span class="nv">$CODE</span> <span class="nv">$REPO</span>

<span class="c">#: Mail to group</span>

<span class="nv">REPOSITORY</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">REVISION</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">SENDMAIL</span><span class="o">=</span>/usr/sbin/sendmail
<span class="nv">ICONV</span><span class="o">=</span>/usr/bin/iconv
<span class="nv">SVNLOOK</span><span class="o">=</span>/usr/bin/svnlook
<span class="nv">NKF</span><span class="o">=</span>/usr/bin/nkf
<span class="nv">LC</span><span class="o">=</span>ja_JP.UTF-8
<span class="o">{</span>
        <span class="nv">LOGMSG</span><span class="o">=</span><span class="sb">`</span><span class="nv">LANG</span><span class="o">=</span><span class="nv">$LC</span> <span class="nv">$SVNLOOK</span> -r <span class="nv">$REVISION</span> log <span class="nv">$REPOSITORY</span><span class="sb">`</span>
        <span class="nb">echo</span> <span class="s2">&quot;From: $NOTIFY&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;To: $NOTIFY&quot;</span>
        <span class="nb">echo </span>Subject: <span class="nv">$TITLE</span>  r<span class="k">${</span><span class="nv">REVISION</span><span class="k">}</span> <span class="sb">`</span><span class="nv">$SVNLOOK</span> -r <span class="nv">$REVISION</span> <span class="nb">dirs</span>-changed <span class="nv">$REPOSITORY</span>|sed <span class="s1">&#39;s;/$;;&#39;</span><span class="sb">`</span>
        <span class="nb">echo</span> <span class="s2">&quot;Content-Type: text/plain; charset=utf8&quot;</span>
        <span class="nb">echo</span>
        <span class="o">(</span>
                <span class="nb">echo</span> <span class="s2">&quot;Log message for $URL&quot;</span>
                <span class="nb">echo</span> <span class="nv">$LOGMSG</span>
                <span class="nb">echo</span>
<span class="nb">                echo</span> -n <span class="s2">&quot;Author: &quot;</span>
                <span class="nv">LANG</span><span class="o">=</span><span class="nv">$LC</span> <span class="nv">$SVNLOOK</span> -r <span class="nv">$REVISION</span> author <span class="nv">$REPOSITORY</span>
                <span class="nv">LANG</span><span class="o">=</span><span class="nv">$LC</span> <span class="nv">$SVNLOOK</span> -r <span class="nv">$REVISION</span> date   <span class="nv">$REPOSITORY</span>
                <span class="nb">echo</span>
<span class="nb">                echo</span> <span class="s2">&quot;Files changed:&quot;</span>
                <span class="nv">LANG</span><span class="o">=</span><span class="nv">$LC</span> <span class="nv">$SVNLOOK</span> -r <span class="nv">$REVISION</span> changed <span class="nv">$REPOSITORY</span>
                <span class="nb">echo</span>
<span class="nb">                </span><span class="nv">LANG</span><span class="o">=</span><span class="nv">$LC</span> <span class="nv">$SVNLOOK</span> -r <span class="nv">$REVISION</span> diff <span class="nv">$REPOSITORY</span>
        <span class="o">)</span>
<span class="o">}</span> 2&gt;&amp;1 | <span class="nv">$SENDMAIL</span> <span class="nv">$NOTIFY</span>
</pre></div>
</div>
</div>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        <a href="/">Home</a>:
        «&#160;&#160;<a href="aes.html">AES: Advanced Encryption Standard</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="git.html">Git</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2012, HDKNR.COM.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2pre/3c28de26aac2.
    </div>
  </body>
</html>