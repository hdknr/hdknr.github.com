

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>OpenSSL &mdash; Note 1 documentation</title>
    
    <link rel="stylesheet" href="static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="static/jquery.js"></script>
    <script type="text/javascript" src="static/underscore.js"></script>
    <script type="text/javascript" src="static/doctools.js"></script>
    <script type="text/javascript" src="static/theme_extras.js"></script>
    <link rel="top" title="Note 1 documentation" href="index.html" />
    <link rel="next" title="Git" href="git.html" />
    <link rel="prev" title="PKCS:Public-Key Cryptography Standards" href="pkcs.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="index.html">
          <span>Note 1 documentation</span></a></h1>
        <h2 class="heading"><span>OpenSSL</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a href="/">Home</a>:
        «&#160;&#160;<a href="pkcs.html">PKCS:Public-Key Cryptography Standards</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="git.html">Git</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="openssl">
<h1>OpenSSL<a class="headerlink" href="#openssl" title="Permalink to this headline">¶</a></h1>
<div class="section" id="bignum">
<h2>BIGNUM<a class="headerlink" href="#bignum" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>巨大整数を表現する構造体。</li>
<li>OpenSSLにおいて、MPI(Muliti Precision Integer ) を表現します。</li>
</ul>
<span class="target" id="module-app.openssl.BIGNUM"></span><div class="highlight-c"><div class="highlight"><pre><span class="cm">/* openssl/ossl_typ.h  */</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">bignum_st</span> <span class="n">BIGNUM</span><span class="p">;</span>    
</pre></div>
</div>
<div class="highlight-c"><div class="highlight"><pre><span class="cm">/* openssl/bn.h */</span>

<span class="cp">#define BN_ULONG    unsigned long                   </span><span class="c1">//  8byte</span>
<span class="k">struct</span> <span class="n">bignum_st</span>        
<span class="p">{</span>   
    <span class="n">BN_ULONG</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>    <span class="cm">/* Pointer to an array of &#39;BN_BITS2&#39; bit chunks. */</span>
    <span class="kt">int</span> <span class="n">top</span><span class="p">;</span>        <span class="cm">/* Index of last used d +1. */</span>

    <span class="cm">/* The next are internal book keeping for bn_expand. */</span>
    <span class="kt">int</span> <span class="n">dmax</span><span class="p">;</span>   <span class="cm">/* Size of the d array. */</span>
    <span class="kt">int</span> <span class="n">neg</span><span class="p">;</span>    <span class="cm">/* one if the number is negative */</span>
    <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="ecdsa-sig">
<h2>ECDSA_SIG構造体<a class="headerlink" href="#ecdsa-sig" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>ECDSAの署名の r, s をMPIで保持する構造体</li>
</ul>
<span class="target" id="module-app.openssl.ECDSA_SIG"></span><div class="highlight-c"><div class="highlight"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="n">ECDSA_SIG_st</span>
    <span class="p">{</span>   
    <span class="n">BIGNUM</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span> 
    <span class="n">BIGNUM</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span> 
    <span class="p">}</span> <span class="n">ECDSA_SIG</span><span class="p">;</span>
</pre></div>
</div>
<dl class="function">
<dt id="app.openssl.ECDSA_SIG.BN_bn2mpi">
<tt class="descclassname">app.openssl.ECDSA_SIG.</tt><tt class="descname">BN_bn2mpi</tt><big>(</big><big>)</big><a class="reference internal" href="modules/app/openssl/ECDSA_SIG.html#BN_bn2mpi"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#app.openssl.ECDSA_SIG.BN_bn2mpi" title="Permalink to this definition">¶</a></dt>
<dd><p><a class="reference external" href="http://www.openssl.org/docs/crypto/BN_bn2bin.html">BN_bn2bin(3) - format conversions</a></p>
<div class="highlight-c"><div class="highlight"><pre><span class="kt">int</span> <span class="n">BN_bn2mpi</span><span class="p">(</span><span class="k">const</span> <span class="n">BIGNUM</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">to</span><span class="p">);</span>
</pre></div>
</div>
<p>BN_bn2mpi() と BN_mpi2bn() は</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="#bignum">BIGNUM</a> 構造体</li>
<li>４バイトのビッグエンディアンのバイト列とその長さを表す４バイトのビッグエンディアン</li>
</ul>
</div></blockquote>
<p>との間で書式変換する。</p>
<p>MSB(the most significant bit:最上位ビット)は負の数を表します。
(MSBがセットされたら、nullバイト(0x00) が先頭に付与されます )</p>
</dd></dl>

<dl class="function">
<dt id="app.openssl.ECDSA_SIG.DN_mpi2bn">
<tt class="descclassname">app.openssl.ECDSA_SIG.</tt><tt class="descname">DN_mpi2bn</tt><big>(</big><big>)</big><a class="reference internal" href="modules/app/openssl/ECDSA_SIG.html#DN_mpi2bn"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#app.openssl.ECDSA_SIG.DN_mpi2bn" title="Permalink to this definition">¶</a></dt>
<dd><div class="highlight-c"><div class="highlight"><pre><span class="n">BIGNUM</span> <span class="o">*</span><span class="n">BN_mpi2bn</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">BIGNUM</span> <span class="o">*</span><span class="n">ret</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li>M2Crytpoは ECDSA_sigで作成した署名を DN_bn2mpiで(r,s)のtupleに変換しています。</li>
</ul>
</dd></dl>

</div>
<div class="section" id="openssl-ecdsa">
<h2>OpenSSL での ECDSA署名<a class="headerlink" href="#openssl-ecdsa" title="Permalink to this headline">¶</a></h2>
<div class="section" id="asn-1">
<h3>ASN.1オブジェクト形式<a class="headerlink" href="#asn-1" title="Permalink to this headline">¶</a></h3>
<p>コマンドで行うと、出力はASN.1 Object形式のバイナリストリームです。</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>openssl dgst -ecdsa-with-SHA1 -sign server.ecdsa.key data.txt  &gt; data.sig
</pre></div>
</div>
<p>同じことをM2Cryptoで行うには、 M2Crytpo.EC.EC.sign_dsa_asn1 を使います</p>
<span class="target" id="module-app.openssl.m2crypt_ec_sign"></span><div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">text</span> <span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">&quot;data.txt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="s">&quot;[</span><span class="si">%s</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="n">text</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">key_file</span><span class="o">=</span><span class="s">&quot;server.ecdsa.key&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">key</span> <span class="o">=</span> <span class="n">load_key</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">key_file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x509_file</span><span class="o">=</span><span class="s">&quot;server.ecdsa.pem.crt&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pub</span> <span class="o">=</span> <span class="n">load_pub_key</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">x509_file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span>
<span class="gp">&gt;&gt;&gt; </span><span class="c">#: 署名の作成</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sig</span><span class="p">,</span><span class="n">digest</span> <span class="o">=</span> <span class="n">ec_sha1_sign_asn1</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">text</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="s">&quot;digest=&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">digest</span><span class="p">),</span><span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">digest</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="s">&quot;signature =&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="p">),</span><span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="s">&quot;signature(base64) =&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="p">),</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>
<span class="gp">&gt;&gt;&gt; </span><span class="c">#: 検証</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">pub</span><span class="o">.</span><span class="n">verify_dsa_asn1</span><span class="p">(</span><span class="n">digest</span><span class="p">,</span><span class="n">sig</span><span class="p">)</span>
</pre></div>
</div>
<dl class="function">
<dt id="app.openssl.m2crypt_ec_sign.ec_sha1_sign_asn1">
<tt class="descclassname">app.openssl.m2crypt_ec_sign.</tt><tt class="descname">ec_sha1_sign_asn1</tt><big>(</big><em>pri</em>, <em>text</em><big>)</big><a class="reference internal" href="modules/app/openssl/m2crypt_ec_sign.html#ec_sha1_sign_asn1"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#app.openssl.m2crypt_ec_sign.ec_sha1_sign_asn1" title="Permalink to this definition">¶</a></dt>
<dd><p>プライベートキーで署名をASN.1 Objectで作成します。</p>
</dd></dl>

<dl class="function">
<dt id="app.openssl.m2crypt_ec_sign.ec_sha1_verify_asn1">
<tt class="descclassname">app.openssl.m2crypt_ec_sign.</tt><tt class="descname">ec_sha1_verify_asn1</tt><big>(</big><em>ASpub</em>, <em>text</em>, <em>signature</em><big>)</big><a class="reference internal" href="modules/app/openssl/m2crypt_ec_sign.html#ec_sha1_verify_asn1"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#app.openssl.m2crypt_ec_sign.ec_sha1_verify_asn1" title="Permalink to this definition">¶</a></dt>
<dd><p>パブリックキーでASN.1 Object形式の署名を検証します。</p>
</dd></dl>

<dl class="function">
<dt id="app.openssl.m2crypt_ec_sign.load_key">
<tt class="descclassname">app.openssl.m2crypt_ec_sign.</tt><tt class="descname">load_key</tt><big>(</big><em>pem</em><big>)</big><a class="reference internal" href="modules/app/openssl/m2crypt_ec_sign.html#load_key"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#app.openssl.m2crypt_ec_sign.load_key" title="Permalink to this definition">¶</a></dt>
<dd><p>PEM形式のECプライベートキーを読み込みます</p>
</dd></dl>

<dl class="function">
<dt id="app.openssl.m2crypt_ec_sign.load_pub_key">
<tt class="descclassname">app.openssl.m2crypt_ec_sign.</tt><tt class="descname">load_pub_key</tt><big>(</big><em>pem_x509</em><big>)</big><a class="reference internal" href="modules/app/openssl/m2crypt_ec_sign.html#load_pub_key"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#app.openssl.m2crypt_ec_sign.load_pub_key" title="Permalink to this definition">¶</a></dt>
<dd><p>PEM形式のX.509 証明書から、ECパブリックキーを取得します</p>
</dd></dl>

<p>C# でBouncyCastle ライブラリを使って SHA256 / ECDSA で署名した場合</p>
<p>ASN.1(わかりやすいように改行入れています):</p>
<div class="highlight-python"><pre>303E
021D
008BBFDD5BA874B9CA3BBE2626E3A11729643F1E2EAF6792EC66C10E35
021D
0086F797C61DFD48D5D99A74DAB4B5E463CCEA6B5E0FA533F79B003325</pre>
</div>
<p>これを、BigIntegerに変換すると</p>
<p>r:</p>
<div class="highlight-python"><pre>8BBFDD5BA874B9CA3BBE2626E3A11729643F1E2EAF6792EC66C10E35</pre>
</div>
<p>s:</p>
<div class="highlight-python"><pre>86F797C61DFD48D5D99A74DAB4B5E463CCEA6B5E0FA533F79B003325</pre>
</div>
<p>ASN.1の 021Dはおそらく、長さが29バイト(0x1D)の整数(0x02)だと思われます。
そして、先頭のバイトは、配列(SEQUECE, 0x30)が後ろに62バイト(0x3E)続く、と思われます。</p>
</div>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        <a href="/">Home</a>:
        «&#160;&#160;<a href="pkcs.html">PKCS:Public-Key Cryptography Standards</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="git.html">Git</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2012, HDKNR.COM.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2pre/3c28de26aac2.
    </div>
  </body>
</html>