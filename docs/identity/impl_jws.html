

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>JOSE JWS:Implementation &mdash; identity 1.0 documentation</title>
    
    <link rel="stylesheet" href="static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/print.css" type="text/css" />
    <link rel="stylesheet" href="static/openid.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="static/jquery.js"></script>
    <script type="text/javascript" src="static/underscore.js"></script>
    <script type="text/javascript" src="static/doctools.js"></script>
    <script type="text/javascript" src="_static/theme_extras.js"></script>
    <link rel="top" title="identity 1.0 documentation" href="index.html" />
    <link rel="prev" title="ID Token:Implementation" href="impl_id_token.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="index.html">
          <span>identity 1.0 documentation</span></a></h1>
        <h2 class="heading"><span>JOSE JWS:Implementation</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="impl_id_token.html">ID Token:Implementation</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="jose-jws-implementation">
<h1><a class="toc-backref" href="#id14">JOSE JWS:Implementation</a><a class="headerlink" href="#jose-jws-implementation" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="id1">
<p class="topic-title first">JOSE JWS Implementation</p>
<ul class="simple">
<li><a class="reference internal" href="#jose-jws-implementation" id="id14">JOSE JWS:Implementation</a><ul>
<li><a class="reference internal" href="#jws-token" id="id15">JWS Token</a><ul>
<li><a class="reference internal" href="#base64url" id="id16">base64url</a><ul>
<li><a class="reference internal" href="#python" id="id17">Python</a></li>
<li><a class="reference internal" href="#c" id="id18">C#:</a></li>
</ul>
</li>
<li><a class="reference internal" href="#token" id="id19">Token</a><ul>
<li><a class="reference internal" href="#create-jws-token-rsa" id="id20">create_jws_token_rsa()</a><ul>
<li><a class="reference internal" href="#id2" id="id21">Python</a></li>
<li><a class="reference internal" href="#id3" id="id22">C#</a></li>
</ul>
</li>
<li><a class="reference internal" href="#verify-jws-token-rsa" id="id23">verify_jws_token_rsa()</a><ul>
<li><a class="reference internal" href="#id4" id="id24">Python</a></li>
<li><a class="reference internal" href="#id5" id="id25">C#</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#x-509" id="id26">X.509</a><ul>
<li><a class="reference internal" href="#key-negotiation-in-advance" id="id27">Key negotiation in advance</a><ul>
<li><a class="reference internal" href="#rp-registartion" id="id28">RP : Registartion</a></li>
<li><a class="reference internal" href="#op-discovery-information" id="id29">OP:Discovery Information</a></li>
</ul>
</li>
<li><a class="reference internal" href="#session-wise-key-negotiation" id="id30">Session-wise Key Negotiation</a></li>
<li><a class="reference internal" href="#sign-verify-with-rsa-key-and-x-509-certificate" id="id31">Sign/Verify with RSA Key and X.509 Certificate</a><ul>
<li><a class="reference internal" href="#sha-name" id="id32">sha_name()</a><ul>
<li><a class="reference internal" href="#id6" id="id33">Python</a></li>
<li><a class="reference internal" href="#id7" id="id34">C#</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rsa-sign" id="id35">rsa_sign()</a><ul>
<li><a class="reference internal" href="#id8" id="id36">Python</a></li>
<li><a class="reference internal" href="#id9" id="id37">C#</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rsa-verify" id="id38">rsa_verify()</a><ul>
<li><a class="reference internal" href="#id10" id="id39">Python</a></li>
<li><a class="reference internal" href="#id11" id="id40">C#</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pem-in-c" id="id41">PEM in C#</a><ul>
<li><a class="reference internal" href="#x-509-certificate-im-pem" id="id42">X.509 Certificate im PEM</a></li>
<li><a class="reference internal" href="#der-private-key-im-pem" id="id43">DER Private Key im PEM</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#libraries" id="id44">Libraries</a><ul>
<li><a class="reference internal" href="#id12" id="id45">Python</a></li>
<li><a class="reference internal" href="#id13" id="id46">C#</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="jws-token">
<h2><a class="toc-backref" href="#id15">JWS Token</a><a class="headerlink" href="#jws-token" title="Permalink to this headline">¶</a></h2>
<div class="section" id="base64url">
<h3><a class="toc-backref" href="#id16">base64url</a><a class="headerlink" href="#base64url" title="Permalink to this headline">¶</a></h3>
<div class="section" id="python">
<h4><a class="toc-backref" href="#id17">Python</a><a class="headerlink" href="#python" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">to_base64url</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">src</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">from_base64url</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64decode</span><span class="p">(</span><span class="n">src</span> <span class="o">+</span> <span class="s">&#39;=&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="c">
<h4><a class="toc-backref" href="#id18">C#:</a><a class="headerlink" href="#c" title="Permalink to this headline">¶</a></h4>
<div class="highlight-csharp"><div class="highlight"><pre><span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">ToBase64Url</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">StringBuilder</span> <span class="n">result</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">(</span>
                   <span class="n">Convert</span><span class="p">.</span><span class="n">ToBase64String</span><span class="p">(</span><span class="n">input</span><span class="p">).</span><span class="n">TrimEnd</span><span class="p">(</span><span class="sc">&#39;=&#39;</span><span class="p">));</span>
    <span class="n">result</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="sc">&#39;+&#39;</span><span class="p">,</span> <span class="sc">&#39;-&#39;</span><span class="p">);</span>
    <span class="n">result</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="sc">&#39;/&#39;</span><span class="p">,</span> <span class="sc">&#39;_&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">static</span> <span class="kt">byte</span><span class="p">[]</span> <span class="nf">FromBase64Url</span><span class="p">(</span><span class="kt">string</span> <span class="n">base64ForUrlInput</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">padChars</span> <span class="p">=</span> <span class="p">(</span><span class="n">base64ForUrlInput</span><span class="p">.</span><span class="n">Length</span> <span class="p">%</span> <span class="m">4</span><span class="p">)</span> <span class="p">==</span> <span class="m">0</span> <span class="p">?</span> <span class="m">0</span>
                 <span class="p">:</span> <span class="p">(</span><span class="m">4</span> <span class="p">-</span> <span class="p">(</span><span class="n">base64ForUrlInput</span><span class="p">.</span><span class="n">Length</span> <span class="p">%</span> <span class="m">4</span><span class="p">));</span>
    <span class="n">StringBuilder</span> <span class="n">result</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">(</span>
                               <span class="n">base64ForUrlInput</span><span class="p">,</span>
                               <span class="n">base64ForUrlInput</span><span class="p">.</span><span class="n">Length</span> <span class="p">+</span> <span class="n">padChars</span><span class="p">);</span>
    <span class="n">result</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="n">Empty</span><span class="p">.</span><span class="n">PadRight</span><span class="p">(</span><span class="n">padChars</span><span class="p">,</span> <span class="sc">&#39;=&#39;</span><span class="p">));</span>
    <span class="n">result</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="sc">&#39;-&#39;</span><span class="p">,</span> <span class="sc">&#39;+&#39;</span><span class="p">);</span>
    <span class="n">result</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="sc">&#39;_&#39;</span><span class="p">,</span> <span class="sc">&#39;/&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">Convert</span><span class="p">.</span><span class="n">FromBase64String</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="token">
<h3><a class="toc-backref" href="#id19">Token</a><a class="headerlink" href="#token" title="Permalink to this headline">¶</a></h3>
<div class="section" id="create-jws-token-rsa">
<h4><a class="toc-backref" href="#id20">create_jws_token_rsa()</a><a class="headerlink" href="#create-jws-token-rsa" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id2">
<h5><a class="toc-backref" href="#id21">Python</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">json</span>

<span class="k">def</span> <span class="nf">create_jws_token_rsa</span><span class="p">(</span><span class="n">header</span><span class="p">,</span><span class="n">payload</span> <span class="p">,</span><span class="n">pem_private_key</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :param header: JWS Header JSON</span>
<span class="sd">        :param payload: JWS Payload in JSON</span>
<span class="sd">        :param pem_private_key: RSA Private Key in PEM format</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">jws_header</span><span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span> <span class="n">header</span> <span class="p">)</span>        <span class="c">#dumps produdes utf8 string by default</span>
    <span class="n">jws_payload</span><span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span> <span class="n">payload</span> <span class="p">)</span>

    <span class="n">encoded_jws_header</span> <span class="o">=</span> <span class="n">to_base64url</span><span class="p">(</span><span class="n">jws_header</span><span class="p">)</span>
    <span class="n">encoded_jws_payload</span><span class="o">=</span> <span class="n">to_base64url</span><span class="p">(</span><span class="n">jws_payload</span><span class="p">)</span>

    <span class="n">jws_secured_input</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">encoded_jws_header</span><span class="p">,</span> <span class="n">encoded_jws_payload</span> <span class="p">)</span>
    <span class="n">jws_signature</span> <span class="o">=</span> <span class="n">rsa_sign</span><span class="p">(</span><span class="n">pem_private_key</span><span class="p">,</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;alg&#39;</span><span class="p">],</span><span class="n">jws_secured_input</span> <span class="p">)</span>

    <span class="n">encoded_jws_signature</span> <span class="o">=</span> <span class="n">to_base64url</span><span class="p">(</span><span class="n">jws_signature</span><span class="p">)</span>
    <span class="n">jws_token</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">encoded_jws_header</span><span class="p">,</span><span class="n">encoded_jws_payload</span><span class="p">,</span> <span class="n">encoded_jws_signature</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">jws_token</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="n">token</span> <span class="o">=</span> <span class="n">create_jws_token_rsa</span><span class="p">(</span>
        <span class="p">{</span><span class="s">&quot;typ&quot;</span><span class="p">:</span><span class="s">&quot;JWT&quot;</span><span class="p">,</span><span class="s">&quot;alg&quot;</span><span class="p">:</span><span class="s">&quot;RS256&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&quot;iss&quot;</span><span class="p">:</span><span class="s">&quot;alice&quot;</span><span class="p">,</span><span class="s">&quot;aud&quot;</span><span class="p">:</span><span class="s">&quot;bob&quot;</span><span class="p">,</span><span class="s">&quot;user_id&quot;</span><span class="p">:</span><span class="s">&quot;charlie&quot;</span><span class="p">},</span>
        <span class="n">Idp</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">issuer</span><span class="o">=</span><span class="s">&quot;me&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">private_key</span>            <span class="c">#: Load private key</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h5><a class="toc-backref" href="#id22">C#</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h5>
<div class="highlight-csharp"><div class="highlight"><pre><span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">CreateTokenRsa</span><span class="p">(</span>
    <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="kt">object</span><span class="p">&gt;</span> <span class="n">header</span><span class="p">,</span><span class="kt">object</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">string</span> <span class="n">pem_private_key</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">jws_header</span> <span class="p">=</span> <span class="n">JsonConvert</span><span class="p">.</span><span class="n">SerializeObject</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
    <span class="kt">string</span> <span class="n">jws_payload</span> <span class="p">=</span> <span class="n">JsonConvert</span><span class="p">.</span><span class="n">SerializeObject</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>

    <span class="kt">string</span> <span class="n">encoded_jws_header</span> <span class="p">=</span> <span class="n">Jose</span><span class="p">.</span><span class="n">Utils</span><span class="p">.</span><span class="n">ToBase64Url</span><span class="p">(</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="n">jws_header</span><span class="p">));</span>
    <span class="kt">string</span> <span class="n">encoded_jws_payload</span> <span class="p">=</span> <span class="n">Jose</span><span class="p">.</span><span class="n">Utils</span><span class="p">.</span><span class="n">ToBase64Url</span><span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="n">jws_payload</span><span class="p">));</span>

    <span class="kt">string</span> <span class="n">jws_secured_input</span> <span class="p">=</span> <span class="n">encoded_jws_header</span> <span class="p">+</span> <span class="s">&quot;.&quot;</span> <span class="p">+</span> <span class="n">encoded_jws_payload</span><span class="p">;</span>


    <span class="kt">byte</span><span class="p">[]</span> <span class="n">jws_signature</span> <span class="p">=</span> <span class="n">RsaSign</span><span class="p">(</span><span class="n">pem_private_key</span><span class="p">,</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="n">header</span><span class="p">[</span><span class="s">&quot;alg&quot;</span><span class="p">],</span>
                                <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="n">jws_secured_input</span><span class="p">));</span>

    <span class="kt">string</span> <span class="n">encoded_jws_signature</span> <span class="p">=</span> <span class="n">Jose</span><span class="p">.</span><span class="n">Utils</span><span class="p">.</span><span class="n">ToBase64Url</span><span class="p">(</span><span class="n">jws_signature</span><span class="p">);</span>

    <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;{0}.{1}.{2}&quot;</span><span class="p">,</span>
                <span class="n">encoded_jws_header</span><span class="p">,</span> <span class="n">encoded_jws_payload</span><span class="p">,</span> <span class="n">encoded_jws_signature</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-csharp"><pre>// just a sample
Dictionary&lt;string, object&gt; header = new Dictionary&lt;string, object&gt;()
                                        { { "typ", "JWT" },
                                          { "alg", "RS256" } };
Dictionary&lt;string, object&gt; payload = new Dictionary&lt;string, object&gt;()
                                        { { "iss", "alice" },
                                          { "aud", "bob" },
                                          { "user_id", "charlie" } };
string token = Jose.Jws.CreateTokenRsa(header, payload,
                                        GetIdpByName('alice").private_key);</pre>
</div>
</div>
</div>
<div class="section" id="verify-jws-token-rsa">
<h4><a class="toc-backref" href="#id23">verify_jws_token_rsa()</a><a class="headerlink" href="#verify-jws-token-rsa" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id4">
<h5><a class="toc-backref" href="#id24">Python</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">verify_jws_token_rsa</span><span class="p">(</span><span class="n">jws_token</span><span class="p">,</span><span class="n">pem_x509</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :param jws_token:  JWS Token</span>
<span class="sd">        :param pem_x509:   X.509 Certificate</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="p">(</span><span class="n">encoded_jws_header</span><span class="p">,</span><span class="n">encoded_jws_payload</span><span class="p">,</span><span class="n">encoded_jws_signature</span><span class="p">)</span> <span class="o">=</span> <span class="n">jws_token</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>

    <span class="n">jws_header</span> <span class="o">=</span> <span class="n">from_base64url</span><span class="p">(</span><span class="n">encoded_jws_header</span><span class="p">)</span>
    <span class="n">jws_payload</span> <span class="o">=</span> <span class="n">from_base64url</span><span class="p">(</span><span class="n">encoded_jws_payload</span><span class="p">)</span>
    <span class="n">jws_signature</span><span class="o">=</span><span class="n">from_base64url</span><span class="p">(</span><span class="n">encoded_jws_signature</span><span class="p">)</span>

    <span class="n">jws_secured_input</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">encoded_jws_header</span><span class="p">,</span> <span class="n">encoded_jws_payload</span> <span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">jws_header</span><span class="p">)</span>

    <span class="n">is_valid</span> <span class="o">=</span> <span class="n">rsa_verify</span><span class="p">(</span><span class="n">pem_x509</span><span class="p">,</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;alg&#39;</span><span class="p">],</span><span class="n">jws_secured_input</span><span class="p">,</span> <span class="n">jws_signature</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">is_valid</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="n">header</span><span class="p">,</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">jws_payload</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">pem_x509 can be None for session wise certificate negotiation.
There should be the other utility which fetch and validate the certficate
based on <strong>header</strong> decoded from <strong>jws_token</strong> .</p>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">is_valid</span><span class="p">,</span><span class="n">header</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span> <span class="o">=</span> <span class="n">verify_jws_token_rsa</span><span class="p">(</span>
                                <span class="n">token</span><span class="p">,</span>
                                <span class="n">Op</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">issuer</span><span class="o">=</span><span class="s">&quot;alice&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">x509_cert_cache</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h5><a class="toc-backref" href="#id25">C#</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h5>
<div class="highlight-csharp"><div class="highlight"><pre><span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">VerifyTokenRsa</span><span class="p">(</span><span class="kt">string</span> <span class="n">jws_token</span><span class="p">,</span> <span class="kt">string</span> <span class="n">pem_x509</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Match</span> <span class="n">m</span><span class="p">=</span>  <span class="p">(</span><span class="k">new</span> <span class="n">Regex</span><span class="p">(</span><span class="s">@&quot;^(?&lt;encoded_jws_header&gt;.+)\.(?&lt;encoded_jws_payload&gt;.+)\.(?&lt;encoded_jws_signature&gt;.+)$&quot;</span><span class="p">)).</span><span class="n">Match</span><span class="p">(</span><span class="n">jws_token</span><span class="p">);</span>
    <span class="kt">string</span> <span class="n">jws_header</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span> <span class="n">Jose</span><span class="p">.</span><span class="n">Utils</span><span class="p">.</span><span class="n">FromBase64Url</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="s">&quot;encoded_jws_header&quot;</span><span class="p">].</span><span class="n">Value</span><span class="p">))</span> <span class="p">;</span>
    <span class="kt">string</span> <span class="n">jws_payload</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span> <span class="n">Jose</span><span class="p">.</span><span class="n">Utils</span><span class="p">.</span><span class="n">FromBase64Url</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="s">&quot;encoded_jws_header&quot;</span><span class="p">].</span><span class="n">Value</span><span class="p">))</span> <span class="p">;</span>
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">jws_signature</span> <span class="p">=</span> <span class="n">Jose</span><span class="p">.</span><span class="n">Utils</span><span class="p">.</span><span class="n">FromBase64Url</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="s">&quot;encoded_jws_signature&quot;</span><span class="p">].</span><span class="n">Value</span><span class="p">);</span>

    <span class="kt">string</span> <span class="n">jws_secured_input</span> <span class="p">=</span> <span class="n">m</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="s">&quot;encoded_jws_header&quot;</span><span class="p">].</span><span class="n">Value</span> <span class="p">+</span> <span class="s">&quot;.&quot;</span> <span class="p">+</span>  <span class="n">m</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="s">&quot;encoded_jws_payload&quot;</span><span class="p">].</span><span class="n">Value</span><span class="p">;</span>

    <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="kt">object</span><span class="p">&gt;</span> <span class="n">header</span> <span class="p">=</span> <span class="n">JsonConvert</span><span class="p">.</span><span class="n">DeserializeObject</span><span class="p">&lt;</span><span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="kt">object</span><span class="p">&gt;&gt;(</span><span class="n">jws_header</span><span class="p">);</span>

    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;jws_secured_input={0}&quot;</span><span class="p">,</span> <span class="n">jws_secured_input</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;ALG={0}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="n">header</span><span class="p">[</span><span class="s">&quot;alg&quot;</span><span class="p">]);</span>

    <span class="kt">bool</span> <span class="n">ret</span> <span class="p">=</span> <span class="n">RsaVerify</span><span class="p">(</span><span class="n">pem_x509</span><span class="p">,</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="n">header</span><span class="p">[</span><span class="s">&quot;alg&quot;</span><span class="p">],</span>
                   <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="n">jws_secured_input</span><span class="p">),</span>
                    <span class="n">jws_signature</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-csharp"><div class="highlight"><pre><span class="c1">// just a sample</span>
<span class="kt">bool</span> <span class="n">ret</span> <span class="p">=</span> <span class="n">Jose</span><span class="p">.</span><span class="n">Jws</span><span class="p">.</span><span class="n">VerifyTokenRsa</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">GetOpByName</span><span class="p">(</span><span class="s">&quot;alice&quot;</span><span class="p">).</span><span class="n">x509_cache</span><span class="p">);</span>
</pre></div>
</div>
<p>So what is rsa_sign() and rsa_verify() ?</p>
</div>
</div>
</div>
</div>
<div class="section" id="x-509">
<h2><a class="toc-backref" href="#id26">X.509</a><a class="headerlink" href="#x-509" title="Permalink to this headline">¶</a></h2>
<div class="section" id="key-negotiation-in-advance">
<h3><a class="toc-backref" href="#id27">Key negotiation in advance</a><a class="headerlink" href="#key-negotiation-in-advance" title="Permalink to this headline">¶</a></h3>
<p>Any RP and OP can negotiate their private keys and X.509 certificate
in advance before a OpenID Connect session begins.</p>
<div class="section" id="rp-registartion">
<h4><a class="toc-backref" href="#id28">RP : Registartion</a><a class="headerlink" href="#rp-registartion" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>An Relying Party  can register it&#8217;s X.509 certificate via <a class="reference internal" href="reg.html"><em>OpenID Connect Dynamic Client Registration 1.0</em></a>.</li>
<li><a class="reference internal" href="reg.html#term-x509-url"><em class="xref std std-term">x509_url</em></a> is the RP&#8217;s X.509 Certificate for OP
to verify requsets&#8217; signatures, or public-encrypt token and other data.</li>
<li>If RP ask OP to encrypt wth the other public key,
<a class="reference internal" href="reg.html#term-x509-encryption-url"><em class="xref std std-term">x509_encryption_url</em></a> can be specified.</li>
<li>If you want to specify <a class="reference internal" href="reg.html#term-jwk-url"><em class="xref std std-term">jwk_url</em></a> as well, both keys must be the same.</li>
<li>So do <a class="reference internal" href="reg.html#term-x509-encryption-url"><em class="xref std std-term">x509_encryption_url</em></a> and <a class="reference internal" href="reg.html#term-jwk-encryption-url"><em class="xref std std-term">jwk_encryption_url</em></a>.</li>
<li>Format is <a class="reference internal" href="glossary.html#term-pem"><em class="xref std std-term">PEM</em></a></li>
</ul>
</div>
<div class="section" id="op-discovery-information">
<h4><a class="toc-backref" href="#id29">OP:Discovery Information</a><a class="headerlink" href="#op-discovery-information" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>OP can advertise its public key for signing and encrypton via <a class="reference internal" href="discovery.html"><em>OpenID Connect Discovery 1.0</em></a></li>
<li>As with RP in <a class="reference internal" href="reg.html"><em>OpenID Connect Dynamic Client Registration 1.0</em></a>, both <a class="reference internal" href="reg.html#term-x509-url"><em class="xref std std-term">x509_url</em></a> and <a class="reference internal" href="reg.html#term-x509-encryption-url"><em class="xref std std-term">x509_encryption_url</em></a> work
in the same way.</li>
<li>So do <a class="reference internal" href="reg.html#term-jwk-url"><em class="xref std std-term">jwk_url</em></a> and <a class="reference internal" href="reg.html#term-jwk-encryption-url"><em class="xref std std-term">jwk_encryption_url</em></a>.</li>
<li>Format is <a class="reference internal" href="glossary.html#term-pem"><em class="xref std std-term">PEM</em></a></li>
</ul>
</div>
</div>
<div class="section" id="session-wise-key-negotiation">
<h3><a class="toc-backref" href="#id30">Session-wise Key Negotiation</a><a class="headerlink" href="#session-wise-key-negotiation" title="Permalink to this headline">¶</a></h3>
<p>Any RP can specifiy its X.509 certificate for the private key used to sign a OpenID Request Object.
Also any OP can specify its X.509 certificate for the private key used to sign tokens or response data.
To do those, JWS header provides the following X.509 parameters.  {See <a class="reference internal" href="jws.html#jws-4-1"><em>4.1.  Reserved Header Parameter Names</em></a> )</p>
<table border="1" class="docutils">
<caption>JWS X.509 Header Parameters</caption>
<colgroup>
<col width="10%" />
<col width="45%" />
<col width="45%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>x5u</td>
<td>URL, like as <a class="reference internal" href="reg.html#term-x509-url"><em class="xref std std-term">x509_url</em></a> in <a class="reference internal" href="reg.html"><em>OpenID Connect Dynamic Client Registration 1.0</em></a> and <a class="reference internal" href="discovery.html"><em>OpenID Connect Discovery 1.0</em></a>.</td>
<td>Format of data returned by this URL is <a class="reference internal" href="glossary.html#term-pem"><em class="xref std std-term">PEM</em></a></td>
</tr>
<tr class="row-even"><td>x5c</td>
<td>X.509 certificate(chain) used this JWS</td>
<td>base64-encode <a class="reference internal" href="glossary.html#term-der"><em class="xref std std-term">DER</em></a>/<a class="reference internal" href="glossary.html#term-170"><em class="xref std std-term">BER</em></a> ( <strong>NOT</strong> in <a class="reference internal" href="session.html#term-base64url"><em class="xref std std-term">base64url</em></a> )</td>
</tr>
<tr class="row-odd"><td>x5t</td>
<td>SHA-1 thumprint of :<a class="reference internal" href="glossary.html#term-der"><em class="xref std std-term">DER</em></a> (binary) encoded X.509 certificate</td>
<td>base64url encoded thumprint</td>
</tr>
</tbody>
</table>
<p>Fingerprint of specifed <a class="reference internal" href="glossary.html#term-pem"><em class="xref std std-term">PEM</em></a> certificate.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">M2Crypto</span> <span class="kn">import</span> <span class="n">X509</span>
<span class="kn">import</span> <span class="nn">utils</span>
<span class="k">def</span> <span class="nf">x5t</span><span class="p">(</span><span class="n">cert_string</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; format</span>
<span class="sd">        = 0 (M2Crypto.X509.DER_FORMAT)</span>
<span class="sd">        = 1 (M2Crypto.X509.PEM_FORMAT)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">cert</span> <span class="o">=</span> <span class="n">X509</span><span class="o">.</span><span class="n">load_cert_string</span><span class="p">(</span><span class="n">cert_string</span><span class="p">,</span><span class="n">format</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">to_base64url</span><span class="p">(</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">from_hex_string</span><span class="p">(</span>
                <span class="n">cert</span><span class="o">.</span><span class="n">get_fingerprint</span><span class="p">(</span><span class="n">md</span><span class="o">=</span><span class="s">&#39;sha1&#39;</span><span class="p">))</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="sign-verify-with-rsa-key-and-x-509-certificate">
<h3><a class="toc-backref" href="#id31">Sign/Verify with RSA Key and X.509 Certificate</a><a class="headerlink" href="#sign-verify-with-rsa-key-and-x-509-certificate" title="Permalink to this headline">¶</a></h3>
<div class="section" id="sha-name">
<h4><a class="toc-backref" href="#id32">sha_name()</a><a class="headerlink" href="#sha-name" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>select proper SHA digest function for <strong>alg</strong> .</li>
</ul>
<div class="section" id="id6">
<h5><a class="toc-backref" href="#id33">Python</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">re</span>

<span class="k">def</span> <span class="nf">sha_name</span><span class="p">(</span><span class="n">alg</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :param alg: Algorithms defined in JWA</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="s">&quot;sha</span><span class="si">%(bits)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&#39;[HRE]S(?P&lt;bits&gt;\d+)$&#39;</span><span class="p">,</span><span class="n">alg</span><span class="p">)</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h5><a class="toc-backref" href="#id34">C#</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h5>
<div class="highlight-csharp"><div class="highlight"><pre><span class="c1">// Look at &quot;security/SignerUtilities.cs&quot; of BouncyCastle</span>
<span class="c1">// for RSA signature algorithm.</span>

<span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">SignerName</span><span class="p">(</span><span class="kt">string</span> <span class="n">alg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Regex</span> <span class="n">re</span><span class="p">=</span> <span class="k">new</span> <span class="n">Regex</span><span class="p">(</span><span class="s">&quot;^RS(?&lt;bits&gt;\\d+)$&quot;</span><span class="p">);</span>
    <span class="n">Match</span> <span class="n">m</span> <span class="p">=</span> <span class="n">re</span><span class="p">.</span><span class="n">Match</span><span class="p">(</span><span class="n">alg</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">m</span><span class="p">!=</span> <span class="k">null</span> <span class="p">){</span>
        <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;SHA{0}WITHRSA&quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="s">&quot;bits&quot;</span><span class="p">].</span><span class="n">Value</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="rsa-sign">
<h4><a class="toc-backref" href="#id35">rsa_sign()</a><a class="headerlink" href="#rsa-sign" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id8">
<h5><a class="toc-backref" href="#id36">Python</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">M2Crypto</span> <span class="kn">import</span> <span class="n">RSA</span><span class="p">,</span><span class="n">util</span>
<span class="kn">import</span> <span class="nn">hashlib</span>

<span class="k">def</span> <span class="nf">rsa_sign</span><span class="p">(</span><span class="n">private_key_pem</span><span class="p">,</span> <span class="n">alg</span><span class="p">,</span> <span class="n">secure_input</span> <span class="p">,</span><span class="n">passphrase</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :param private_key_pem: PEM string of private key of signer</span>
<span class="sd">        :param alg: Algorithms defined in JWA</span>
<span class="sd">        :param secure_input: Message for digest input</span>
<span class="sd">        :param passphrase: (optional) pass phrase for private key</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">_passphrase</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">passphrase</span>

    <span class="n">callback</span> <span class="o">=</span> <span class="n">_passphrase</span> <span class="k">if</span> <span class="n">passphrase</span> <span class="k">else</span> <span class="n">util</span><span class="o">.</span><span class="n">passphrase_callback</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">RSA</span><span class="o">.</span><span class="n">load_key_string</span><span class="p">(</span><span class="n">private_key_pem</span><span class="p">,</span><span class="n">callback</span><span class="o">=</span><span class="n">callback</span> <span class="p">)</span>

    <span class="n">sha</span><span class="o">=</span><span class="n">sha_name</span><span class="p">(</span><span class="n">alg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">hashlib</span><span class="p">,</span><span class="n">sha</span><span class="p">)(</span><span class="n">secure_input</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">(),</span><span class="n">sha</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h5><a class="toc-backref" href="#id37">C#</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h5>
<div class="highlight-csharp"><div class="highlight"><pre><span class="k">public</span> <span class="k">static</span> <span class="kt">byte</span><span class="p">[]</span> <span class="nf">RsaSign</span><span class="p">(</span><span class="kt">string</span> <span class="n">key_pem</span><span class="p">,</span> <span class="kt">string</span> <span class="n">alg</span><span class="p">,</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">secure_input</span> <span class="p">,</span><span class="kt">string</span> <span class="n">passphrase</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">signer</span> <span class="p">=</span> <span class="n">SignerUtilities</span><span class="p">.</span><span class="n">GetSigner</span><span class="p">(</span><span class="n">SignerName</span><span class="p">(</span><span class="n">alg</span><span class="p">));</span>
    <span class="n">signer</span><span class="p">.</span><span class="n">Init</span><span class="p">(</span><span class="k">true</span><span class="p">,</span> <span class="n">RsaPrivateKeyFromPem</span><span class="p">(</span><span class="n">key_pem</span><span class="p">));</span>
    <span class="n">signer</span><span class="p">.</span><span class="n">BlockUpdate</span><span class="p">(</span><span class="n">secure_input</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">secure_input</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">signer</span><span class="p">.</span><span class="n">GenerateSignature</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition-todo admonition" id="index-1">
<p class="first admonition-title">Todo</p>
<p class="last">Find to load PEM private key secured with pass phrase.</p>
</div>
</div>
</div>
<div class="section" id="rsa-verify">
<h4><a class="toc-backref" href="#id38">rsa_verify()</a><a class="headerlink" href="#rsa-verify" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id10">
<h5><a class="toc-backref" href="#id39">Python</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">M2Crypto</span> <span class="kn">import</span> <span class="n">X509</span>

<span class="k">def</span> <span class="nf">rsa_verify</span><span class="p">(</span><span class="n">x509_pem</span><span class="p">,</span> <span class="n">alg</span><span class="p">,</span> <span class="n">secure_input</span> <span class="p">,</span><span class="n">signature</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :param x509_pem: PEM string of signer&#39;s X.509 certificate</span>
<span class="sd">        :param alg: Algorithms defined in JWA</span>
<span class="sd">        :param secure_input: Message for digest input</span>
<span class="sd">        :param signature: signature which OP has signed.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">pub</span><span class="o">=</span> <span class="n">X509</span><span class="o">.</span><span class="n">load_cert_string</span><span class="p">(</span><span class="n">x509_pem</span><span class="p">)</span><span class="o">.</span><span class="n">get_pubkey</span><span class="p">()</span>
    <span class="n">sha</span><span class="o">=</span><span class="n">sha_name</span><span class="p">(</span><span class="n">alg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pub</span><span class="o">.</span><span class="n">get_rsa</span><span class="p">()</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">hashlib</span><span class="p">,</span><span class="n">sha</span><span class="p">)(</span><span class="n">secure_input</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">(),</span><span class="n">signature</span><span class="p">,</span><span class="n">sha</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id11">
<h5><a class="toc-backref" href="#id40">C#</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h5>
<div class="highlight-csharp"><div class="highlight"><pre><span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">RsaVerify</span><span class="p">(</span><span class="kt">string</span> <span class="n">x509_pem</span><span class="p">,</span> <span class="kt">string</span> <span class="n">alg</span><span class="p">,</span>
                        <span class="kt">byte</span><span class="p">[]</span> <span class="n">secure_input</span><span class="p">,</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">signature</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">RsaKeyParameters</span> <span class="n">pubkey</span> <span class="p">=</span> <span class="p">(</span><span class="n">RsaKeyParameters</span><span class="p">)</span><span class="n">CertificateFromPem</span><span class="p">(</span><span class="n">x509_pem</span><span class="p">).</span><span class="n">GetPublicKey</span><span class="p">();</span>

    <span class="kt">var</span> <span class="n">signer</span> <span class="p">=</span> <span class="n">SignerUtilities</span><span class="p">.</span><span class="n">GetSigner</span><span class="p">(</span><span class="n">SignerName</span><span class="p">(</span><span class="n">alg</span><span class="p">));</span>
    <span class="n">signer</span><span class="p">.</span><span class="n">Init</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="n">pubkey</span><span class="p">);</span>
    <span class="n">signer</span><span class="p">.</span><span class="n">BlockUpdate</span><span class="p">(</span><span class="n">secure_input</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">secure_input</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">signer</span><span class="p">.</span><span class="n">VerifySignature</span><span class="p">(</span><span class="n">signature</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="pem-in-c">
<h4><a class="toc-backref" href="#id41">PEM in C#</a><a class="headerlink" href="#pem-in-c" title="Permalink to this headline">¶</a></h4>
<p>Because it&#8217;s not easy to read PEM formatted data in Microsoft library,
BouncyCastle can be used to load X.509 certificate and private key.</p>
<div class="section" id="x-509-certificate-im-pem">
<h5><a class="toc-backref" href="#id42">X.509 Certificate im PEM</a><a class="headerlink" href="#x-509-certificate-im-pem" title="Permalink to this headline">¶</a></h5>
<div class="highlight-csharp"><div class="highlight"><pre><span class="k">public</span> <span class="k">static</span> <span class="n">X509Certificate</span> <span class="nf">CertificateFromPem</span><span class="p">(</span><span class="kt">string</span> <span class="n">certificate</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">TextReader</span> <span class="n">c</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StringReader</span><span class="p">(</span><span class="n">certificate</span><span class="p">);</span>
    <span class="n">PemReader</span> <span class="n">pem2</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PemReader</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="n">X509Certificate</span> <span class="n">x509</span> <span class="p">=</span> <span class="p">(</span><span class="n">X509Certificate</span><span class="p">)</span><span class="n">pem2</span><span class="p">.</span><span class="n">ReadObject</span><span class="p">();</span>

    <span class="k">return</span> <span class="n">x509</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="der-private-key-im-pem">
<h5><a class="toc-backref" href="#id43">DER Private Key im PEM</a><a class="headerlink" href="#der-private-key-im-pem" title="Permalink to this headline">¶</a></h5>
<div class="highlight-csharp"><div class="highlight"><pre><span class="k">public</span> <span class="k">static</span> <span class="n">RsaKeyParameters</span> <span class="nf">RsaPrivateKeyFromPem</span><span class="p">(</span><span class="kt">string</span> <span class="n">private_key</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">TextReader</span> <span class="n">r</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StringReader</span><span class="p">(</span><span class="n">private_key</span><span class="p">);</span>
    <span class="n">PemReader</span> <span class="n">pem</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PemReader</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">RsaKeyParameters</span><span class="p">)((</span><span class="n">AsymmetricCipherKeyPair</span> <span class="p">)</span><span class="n">pem</span><span class="p">.</span><span class="n">ReadObject</span><span class="p">()).</span><span class="n">Private</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="libraries">
<h2><a class="toc-backref" href="#id44">Libraries</a><a class="headerlink" href="#libraries" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id12">
<h3><a class="toc-backref" href="#id45">Python</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># standard python</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="c"># M2Crypto</span>
<span class="kn">from</span> <span class="nn">M2Crypto</span> <span class="kn">import</span> <span class="n">RSA</span>
<span class="kn">from</span> <span class="nn">M2Crypto</span> <span class="kn">import</span> <span class="n">X509</span>
<span class="kn">from</span> <span class="nn">M2Crypto</span> <span class="kn">import</span> <span class="n">util</span>
</pre></div>
</div>
</div>
<div class="section" id="id13">
<h3><a class="toc-backref" href="#id46">C#</a><a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<div class="highlight-csharp"><div class="highlight"><pre><span class="c1">// Micsosoft</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text.RegularExpressions</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Security.Cryptography</span><span class="p">;</span>

<span class="c1">// BouncyCastle</span>
<span class="k">using</span> <span class="nn">Org.BouncyCastle.OpenSsl</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Org.BouncyCastle.Crypto</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Org.BouncyCastle.Crypto.Signers</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Org.BouncyCastle.Crypto.Digests</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Org.BouncyCastle.Crypto.Generators</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Org.BouncyCastle.Crypto.Parameters</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Org.BouncyCastle.X509</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Org.BouncyCastle.Security</span><span class="p">;</span>

<span class="c1">// Json.NET</span>
<span class="k">using</span> <span class="nn">Newtonsoft.Json</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Newtonsoft.Json.Linq</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="impl_id_token.html">ID Token:Implementation</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2011, HDKNR.COM.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2pre/3c28de26aac2.
    </div>
  </body>
</html>