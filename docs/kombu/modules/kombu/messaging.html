

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>kombu.messaging &mdash; Kombu Docs 1 documentation</title>
    
    <link rel="stylesheet" href="../../static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../static/jquery.js"></script>
    <script type="text/javascript" src="../../static/underscore.js"></script>
    <script type="text/javascript" src="../../static/doctools.js"></script>
    <script type="text/javascript" src="../../static/theme_extras.js"></script>
    <link rel="top" title="Kombu Docs 1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../../index.html">
          <span>Kombu Docs 1 documentation</span></a></h1>
        <h2 class="heading"><span>kombu.messaging</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a href="/">Home</a>:
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for kombu.messaging</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">kombu.messaging</span>
<span class="sd">===============</span>

<span class="sd">Sending and receiving messages.</span>

<span class="sd">:copyright: (c) 2009 - 2012 by Ask Solem.</span>
<span class="sd">:license: BSD, see LICENSE for more details.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">count</span>

<span class="kn">from</span> <span class="nn">.connection</span> <span class="kn">import</span> <span class="n">maybe_channel</span>
<span class="kn">from</span> <span class="nn">.entity</span> <span class="kn">import</span> <span class="n">Exchange</span><span class="p">,</span> <span class="n">Queue</span>
<span class="kn">from</span> <span class="nn">.compression</span> <span class="kn">import</span> <span class="n">compress</span>
<span class="kn">from</span> <span class="nn">.serialization</span> <span class="kn">import</span> <span class="n">encode</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">maybe_list</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Exchange&#39;</span><span class="p">,</span> <span class="s">&#39;Queue&#39;</span><span class="p">,</span> <span class="s">&#39;Producer&#39;</span><span class="p">,</span> <span class="s">&#39;Consumer&#39;</span><span class="p">]</span>

<span class="c"># XXX compat attribute</span>
<span class="n">entry_to_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">from_dict</span>


<div class="viewcode-block" id="Producer"><a class="viewcode-back" href="../../userguide/producers.html#kombu.messaging.Producer">[docs]</a><span class="k">class</span> <span class="nc">Producer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Message Producer.</span>

<span class="sd">    :param channel: Connection or channel.</span>
<span class="sd">    :keyword exchange: Optional default exchange.</span>
<span class="sd">    :keyword routing_key: Optional default routing key.</span>
<span class="sd">    :keyword serializer: Default serializer. Default is `&quot;json&quot;`.</span>
<span class="sd">    :keyword compression: Default compression method. Default is no</span>
<span class="sd">        compression.</span>
<span class="sd">    :keyword auto_declare: Automatically declare the default exchange</span>
<span class="sd">      at instantiation. Default is :const:`True`.</span>
<span class="sd">    :keyword on_return: Callback to call for undeliverable messages,</span>
<span class="sd">        when the `mandatory` or `immediate` arguments to</span>
<span class="sd">        :meth:`publish` is used. This callback needs the following</span>
<span class="sd">        signature: `(exception, exchange, routing_key, message)`.</span>
<span class="sd">        Note that the producer needs to drain events to use this feature.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#: The connection channel used.</span>
    <span class="n">channel</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: Default exchange.</span>
    <span class="n">exchange</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c"># Default routing key.</span>
    <span class="n">routing_key</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="c">#: Default serializer to use. Default is JSON.</span>
    <span class="n">serializer</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: Default compression method.  Disabled by default.</span>
    <span class="n">compression</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: By default the exchange is declared at instantiation.</span>
    <span class="c">#: If you want to declare manually then you can set this</span>
    <span class="c">#: to :const:`False`.</span>
    <span class="n">auto_declare</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c">#: Basic return callback.</span>
    <span class="n">on_return</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">exchange</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">routing_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">serializer</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">auto_declare</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">on_return</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">Exchange</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routing_key</span> <span class="o">=</span> <span class="n">routing_key</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">routing_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serializer</span> <span class="o">=</span> <span class="n">serializer</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">serializer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">=</span> <span class="n">compression</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_return</span> <span class="o">=</span> <span class="n">on_return</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_return</span>
        <span class="k">if</span> <span class="n">auto_declare</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auto_declare</span> <span class="o">=</span> <span class="n">auto_declare</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">revive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reduce_args__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__reduce_args__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">routing_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serializer</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">auto_declare</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span><span class="p">)</span>

<div class="viewcode-block" id="Producer.declare"><a class="viewcode-back" href="../../userguide/producers.html#kombu.messaging.Producer.declare">[docs]</a>    <span class="k">def</span> <span class="nf">declare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Declare the exchange.</span>

<span class="sd">        This happens automatically at instantiation if</span>
<span class="sd">        :attr:`auto_declare` is enabled.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">declare</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Producer.maybe_declare"><a class="viewcode-back" href="../../userguide/producers.html#kombu.messaging.Producer.maybe_declare">[docs]</a>    <span class="k">def</span> <span class="nf">maybe_declare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">retry_policy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Declare the exchange if it hasn&#39;t already been declared</span>
<span class="sd">        during this session.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">entity</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.common</span> <span class="kn">import</span> <span class="n">maybe_declare</span>
            <span class="k">return</span> <span class="n">maybe_declare</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">retry</span><span class="p">,</span> <span class="o">**</span><span class="n">retry_policy</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Producer.publish"><a class="viewcode-back" href="../../userguide/producers.html#kombu.messaging.Producer.publish">[docs]</a>    <span class="k">def</span> <span class="nf">publish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">routing_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">delivery_mode</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">mandatory</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">immediate</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">content_encoding</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">serializer</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">compression</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exchange</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">retry_policy</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">declare</span><span class="o">=</span><span class="p">[],</span> <span class="o">**</span><span class="n">properties</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Publish message to the specified exchange.</span>

<span class="sd">        :param body: Message body.</span>
<span class="sd">        :keyword routing_key: Message routing key.</span>
<span class="sd">        :keyword delivery_mode: See :attr:`delivery_mode`.</span>
<span class="sd">        :keyword mandatory: Currently not supported.</span>
<span class="sd">        :keyword immediate: Currently not supported.</span>
<span class="sd">        :keyword priority: Message priority. A number between 0 and 9.</span>
<span class="sd">        :keyword content_type: Content type. Default is auto-detect.</span>
<span class="sd">        :keyword content_encoding: Content encoding. Default is auto-detect.</span>
<span class="sd">        :keyword serializer: Serializer to use. Default is auto-detect.</span>
<span class="sd">        :keyword compression: Compression method to use.  Default is none.</span>
<span class="sd">        :keyword headers: Mapping of arbitrary headers to pass along</span>
<span class="sd">          with the message body.</span>
<span class="sd">        :keyword exchange: Override the exchange.  Note that this exchange</span>
<span class="sd">          must have been declared.</span>
<span class="sd">        :keyword declare: Optional list of required entities that must</span>
<span class="sd">            have been declared before publishing the message.  The entities</span>
<span class="sd">            will be declared using :func:`~kombu.common.maybe_declare`.</span>
<span class="sd">        :keyword retry: Retry publishing, or declaring entities if the</span>
<span class="sd">            connection is lost.</span>
<span class="sd">        :keyword retry_policy: Retry configuration, this is the keywords</span>
<span class="sd">            supported by :meth:`~kombu.connection.Connection.ensure`.</span>
<span class="sd">        :keyword \*\*properties: Additional message properties, see AMQP spec.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">headers</span>
        <span class="n">retry_policy</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">retry_policy</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">retry_policy</span>
        <span class="n">routing_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">routing_key</span> <span class="k">if</span> <span class="n">routing_key</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">routing_key</span>
        <span class="n">compression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="k">if</span> <span class="n">compression</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">compression</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="n">Exchange</span><span class="p">):</span>
            <span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">name</span>

        <span class="n">body</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">content_encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare</span><span class="p">(</span>
                <span class="n">body</span><span class="p">,</span> <span class="n">serializer</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">content_encoding</span><span class="p">,</span>
                <span class="n">compression</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">Message</span><span class="p">(</span><span class="n">body</span><span class="p">,</span>
                                        <span class="n">delivery_mode</span><span class="p">,</span>
                                        <span class="n">priority</span><span class="p">,</span>
                                        <span class="n">content_type</span><span class="p">,</span>
                                        <span class="n">content_encoding</span><span class="p">,</span>
                                        <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                                        <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">)</span>
        <span class="n">publish</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish</span>
        <span class="k">if</span> <span class="n">retry</span><span class="p">:</span>
            <span class="n">publish</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ensure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">publish</span><span class="p">,</span> <span class="o">**</span><span class="n">retry_policy</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">publish</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">routing_key</span><span class="p">,</span> <span class="n">mandatory</span><span class="p">,</span>
                       <span class="n">immediate</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">declare</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_publish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">routing_key</span><span class="p">,</span> <span class="n">mandatory</span><span class="p">,</span> <span class="n">immediate</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span>
            <span class="n">declare</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">declare</span><span class="p">:</span>
            <span class="n">maybe_declare</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maybe_declare</span>
            <span class="p">[</span><span class="n">maybe_declare</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span> <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">declare</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">routing_key</span><span class="p">,</span>
                                     <span class="n">mandatory</span><span class="p">,</span> <span class="n">immediate</span><span class="p">,</span> <span class="n">exchange</span><span class="p">)</span>

<div class="viewcode-block" id="Producer.revive"><a class="viewcode-back" href="../../userguide/producers.html#kombu.messaging.Producer.revive">[docs]</a>    <span class="k">def</span> <span class="nf">revive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Revive the producer after connection loss.&quot;&quot;&quot;</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">maybe_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">revive</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_declare</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">declare</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_return</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="s">&#39;basic_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_return</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">exc_info</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="n">close</span> <span class="o">=</span> <span class="n">release</span>

    <span class="k">def</span> <span class="nf">_prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">serializer</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">content_type</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">content_encoding</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="c"># No content_type? Then we&#39;re serializing the data internally.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">content_type</span><span class="p">:</span>
            <span class="n">serializer</span> <span class="o">=</span> <span class="n">serializer</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">serializer</span>
            <span class="p">(</span><span class="n">content_type</span><span class="p">,</span> <span class="n">content_encoding</span><span class="p">,</span>
             <span class="n">body</span><span class="p">)</span> <span class="o">=</span> <span class="n">encode</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">serializer</span><span class="o">=</span><span class="n">serializer</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># If the programmer doesn&#39;t want us to serialize,</span>
            <span class="c"># make sure content_encoding is set.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">content_encoding</span><span class="p">:</span>
                    <span class="n">content_encoding</span> <span class="o">=</span> <span class="s">&#39;utf-8&#39;</span>
                <span class="n">body</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">content_encoding</span><span class="p">)</span>

            <span class="c"># If they passed in a string, we can&#39;t know anything</span>
            <span class="c"># about it. So assume it&#39;s binary data.</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">content_encoding</span><span class="p">:</span>
                <span class="n">content_encoding</span> <span class="o">=</span> <span class="s">&#39;binary&#39;</span>

        <span class="k">if</span> <span class="n">compression</span><span class="p">:</span>
            <span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="p">[</span><span class="s">&#39;compression&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">compress</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">compression</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">body</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">content_encoding</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">client</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>

</div>
<div class="viewcode-block" id="Consumer"><a class="viewcode-back" href="../../userguide/consumers.html#kombu.messaging.Consumer">[docs]</a><span class="k">class</span> <span class="nc">Consumer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Message consumer.</span>

<span class="sd">    :param channel: see :attr:`channel`.</span>
<span class="sd">    :param queues: see :attr:`queues`.</span>
<span class="sd">    :keyword no_ack: see :attr:`no_ack`.</span>
<span class="sd">    :keyword auto_declare: see :attr:`auto_declare`</span>
<span class="sd">    :keyword callbacks: see :attr:`callbacks`.</span>
<span class="sd">    :keyword on_decode_error: see :attr:`on_decode_error`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#: The connection/channel to use for this consumer.</span>
    <span class="n">channel</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: A single :class:`~kombu.entity.Queue`, or a list of queues to</span>
    <span class="c">#: consume from.</span>
    <span class="n">queues</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: Flag for message acknowledgment disabled/enabled.</span>
    <span class="c">#: Enabled by default.</span>
    <span class="n">no_ack</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: By default all entities will be declared at instantiation, if you</span>
    <span class="c">#: want to handle this manually you can set this to :const:`False`.</span>
    <span class="n">auto_declare</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c">#: List of callbacks called in order when a message is received.</span>
    <span class="c">#:</span>
    <span class="c">#: The signature of the callbacks must take two arguments:</span>
    <span class="c">#: `(body, message)`, which is the decoded message body and</span>
    <span class="c">#: the `Message` instance (a subclass of</span>
    <span class="c">#: :class:`~kombu.transport.base.Message`).</span>
    <span class="n">callbacks</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c">#: Callback called when a message can&#39;t be decoded.</span>
    <span class="c">#:</span>
    <span class="c">#: The signature of the callback must take two arguments: `(message,</span>
    <span class="c">#: exc)`, which is the message that can&#39;t be decoded and the exception</span>
    <span class="c">#: that occurred while trying to decode it.</span>
    <span class="n">on_decode_error</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">_next_tag</span> <span class="o">=</span> <span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">next</span>   <span class="c"># global</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">queues</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">no_ack</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">auto_declare</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">callbacks</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">on_decode_error</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queues</span> <span class="ow">or</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">queues</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">queues</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_ack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_ack</span> <span class="k">if</span> <span class="n">no_ack</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">no_ack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="ow">or</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">callbacks</span> <span class="ow">is</span> <span class="bp">None</span>
                                               <span class="k">else</span> <span class="n">callbacks</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">auto_declare</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auto_declare</span> <span class="o">=</span> <span class="n">auto_declare</span>
        <span class="k">if</span> <span class="n">on_decode_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_decode_error</span> <span class="o">=</span> <span class="n">on_decode_error</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">revive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span>

<div class="viewcode-block" id="Consumer.revive"><a class="viewcode-back" href="../../userguide/consumers.html#kombu.messaging.Consumer.revive">[docs]</a>    <span class="k">def</span> <span class="nf">revive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Revive consumer after connection loss.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active_tags</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">maybe_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queues</span> <span class="o">=</span> <span class="p">[</span><span class="n">queue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">queue</span> <span class="ow">in</span> <span class="n">maybe_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">queue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="p">:</span>
            <span class="n">queue</span><span class="o">.</span><span class="n">revive</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_declare</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">declare</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Consumer.declare"><a class="viewcode-back" href="../../userguide/consumers.html#kombu.messaging.Consumer.declare">[docs]</a>    <span class="k">def</span> <span class="nf">declare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Declare queues, exchanges and bindings.</span>

<span class="sd">        This is done automatically at instantiation if :attr:`auto_declare`</span>
<span class="sd">        is set.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">queue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="p">:</span>
            <span class="n">queue</span><span class="o">.</span><span class="n">declare</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Consumer.register_callback"><a class="viewcode-back" href="../../userguide/consumers.html#kombu.messaging.Consumer.register_callback">[docs]</a>    <span class="k">def</span> <span class="nf">register_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a new callback to be called when a message</span>
<span class="sd">        is received.</span>

<span class="sd">        The signature of the callback needs to accept two arguments:</span>
<span class="sd">        `(body, message)`, which is the decoded message body</span>
<span class="sd">        and the `Message` instance (a subclass of</span>
<span class="sd">        :class:`~kombu.transport.base.Message`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consume</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">exc_info</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_declare</span><span class="p">:</span>
            <span class="n">queue</span><span class="o">.</span><span class="n">declare</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">queue</span>

    <span class="k">def</span> <span class="nf">add_queue_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_queue</span><span class="p">(</span><span class="n">Queue</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">))</span>

<div class="viewcode-block" id="Consumer.consume"><a class="viewcode-back" href="../../reference/kombu.messaging.html#kombu.messaging.Consumer.consume">[docs]</a>    <span class="k">def</span> <span class="nf">consume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">no_ack</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="p">:</span>
            <span class="n">no_ack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_ack</span> <span class="k">if</span> <span class="n">no_ack</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">no_ack</span>

            <span class="n">H</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">queue</span> <span class="ow">in</span> <span class="n">H</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_basic_consume</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">no_ack</span><span class="o">=</span><span class="n">no_ack</span><span class="p">,</span> <span class="n">nowait</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_basic_consume</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">no_ack</span><span class="o">=</span><span class="n">no_ack</span><span class="p">,</span> <span class="n">nowait</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Consumer.cancel"><a class="viewcode-back" href="../../userguide/consumers.html#kombu.messaging.Consumer.cancel">[docs]</a>    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;End all active queue consumers.</span>

<span class="sd">        This does not affect already delivered messages, but it does</span>
<span class="sd">        mean the server will not send any more messages for this consumer.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cancel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">basic_cancel</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_tags</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
            <span class="n">cancel</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active_tags</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>
    <span class="n">close</span> <span class="o">=</span> <span class="n">cancel</span>

<div class="viewcode-block" id="Consumer.cancel_by_queue"><a class="viewcode-back" href="../../userguide/consumers.html#kombu.messaging.Consumer.cancel_by_queue">[docs]</a>    <span class="k">def</span> <span class="nf">cancel_by_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cancel consumer by queue name.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_tags</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">queues</span> <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">queue</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">basic_cancel</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">consuming_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">queue</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">Queue</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">name</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="p">)</span>

<div class="viewcode-block" id="Consumer.purge"><a class="viewcode-back" href="../../userguide/consumers.html#kombu.messaging.Consumer.purge">[docs]</a>    <span class="k">def</span> <span class="nf">purge</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Purge messages from all queues.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            This will *delete all ready messages*, there is no</span>
<span class="sd">            undo operation.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">purge</span><span class="p">()</span> <span class="k">for</span> <span class="n">queue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Consumer.flow"><a class="viewcode-back" href="../../userguide/consumers.html#kombu.messaging.Consumer.flow">[docs]</a>    <span class="k">def</span> <span class="nf">flow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">active</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Enable/disable flow from peer.</span>

<span class="sd">        This is a simple flow-control mechanism that a peer can use</span>
<span class="sd">        to avoid overflowing its queues or otherwise finding itself</span>
<span class="sd">        receiving more messages than it can process.</span>

<span class="sd">        The peer that receives a request to stop sending content</span>
<span class="sd">        will finish sending the current content (if any), and then wait</span>
<span class="sd">        until flow is reactivated.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">flow</span><span class="p">(</span><span class="n">active</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Consumer.qos"><a class="viewcode-back" href="../../userguide/consumers.html#kombu.messaging.Consumer.qos">[docs]</a>    <span class="k">def</span> <span class="nf">qos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefetch_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">prefetch_count</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">apply_global</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Specify quality of service.</span>

<span class="sd">        The client can request that messages should be sent in</span>
<span class="sd">        advance so that when the client finishes processing a message,</span>
<span class="sd">        the following message is already held locally, rather than needing</span>
<span class="sd">        to be sent down the channel. Prefetching gives a performance</span>
<span class="sd">        improvement.</span>

<span class="sd">        The prefetch window is Ignored if the :attr:`no_ack` option is set.</span>

<span class="sd">        :param prefetch_size: Specify the prefetch window in octets.</span>
<span class="sd">          The server will send a message in advance if it is equal to</span>
<span class="sd">          or smaller in size than the available prefetch size (and</span>
<span class="sd">          also falls within other prefetch limits). May be set to zero,</span>
<span class="sd">          meaning &quot;no specific limit&quot;, although other prefetch limits</span>
<span class="sd">          may still apply.</span>

<span class="sd">        :param prefetch_count: Specify the prefetch window in terms of</span>
<span class="sd">          whole messages.</span>

<span class="sd">        :param apply_global: Apply new settings globally on all channels.</span>
<span class="sd">          Currently not supported by RabbitMQ.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">basic_qos</span><span class="p">(</span><span class="n">prefetch_size</span><span class="p">,</span>
                                      <span class="n">prefetch_count</span><span class="p">,</span>
                                      <span class="n">apply_global</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Consumer.recover"><a class="viewcode-back" href="../../userguide/consumers.html#kombu.messaging.Consumer.recover">[docs]</a>    <span class="k">def</span> <span class="nf">recover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requeue</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Redeliver unacknowledged messages.</span>

<span class="sd">        Asks the broker to redeliver all unacknowledged messages</span>
<span class="sd">        on the specified channel.</span>

<span class="sd">        :keyword requeue: By default the messages will be redelivered</span>
<span class="sd">          to the original recipient. With `requeue` set to true, the</span>
<span class="sd">          server will attempt to requeue the message, potentially then</span>
<span class="sd">          delivering it to an alternative subscriber.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">basic_recover</span><span class="p">(</span><span class="n">requeue</span><span class="o">=</span><span class="n">requeue</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Consumer.receive"><a class="viewcode-back" href="../../userguide/consumers.html#kombu.messaging.Consumer.receive">[docs]</a>    <span class="k">def</span> <span class="nf">receive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method called when a message is received.</span>

<span class="sd">        This dispatches to the registered :attr:`callbacks`.</span>

<span class="sd">        :param body: The decoded message body.</span>
<span class="sd">        :param message: The `Message` instance.</span>

<span class="sd">        :raises NotImplementedError: If no consumer callbacks have been</span>
<span class="sd">          registered.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">callbacks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callbacks</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Consumer does not have any callback&#39;</span><span class="p">)</span>
        <span class="p">[</span><span class="n">callback</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span> <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">callbacks</span><span class="p">]</span>
</div>
    <span class="k">def</span> <span class="nf">_basic_consume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">consumer_tag</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">no_ack</span><span class="o">=</span><span class="n">no_ack</span><span class="p">,</span> <span class="n">nowait</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_tag</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">consumer_tag</span><span class="p">)</span>
            <span class="n">queue</span><span class="o">.</span><span class="n">consume</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receive_callback</span><span class="p">,</span>
                          <span class="n">no_ack</span><span class="o">=</span><span class="n">no_ack</span><span class="p">,</span> <span class="n">nowait</span><span class="o">=</span><span class="n">nowait</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tag</span>

    <span class="k">def</span> <span class="nf">_add_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">consumer_tag</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="n">consumer_tag</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_next_tag</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active_tags</span><span class="p">[</span><span class="n">queue</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag</span>
        <span class="k">return</span> <span class="n">tag</span>

    <span class="k">def</span> <span class="nf">_receive_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m2p</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="s">&#39;message_to_python&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m2p</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">m2p</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">decoded</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_decode_error</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_decode_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">decoded</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;Consumer: </span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queues</span><span class="p">,</span> <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">client</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span></div>
</pre></div>

      </div>
      <div class="bottomnav">
      
        <p>
        <a href="/">Home</a>:
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2012, HDKNR.COM.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>