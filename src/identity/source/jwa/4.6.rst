.. _jwa.ecdh-es:

4.6.  Key Agreement with Elliptic Curve Diffie-Hellman Ephemeral Static (ECDH-ES)
----------------------------------------------------------------------------------------

This section defines the specifics of key agreement with 
Elliptic Curve Diffie-Hellman Ephemeral Static :term:`[RFC6090]`, 
in combination with the :ref:`Concat KDF`, 
as defined in :ref:`Section 5.8.1 <nist-sp800-56a.5.8.1>` of :term:`[NIST.800-56A]`.  

The key agreement result can be used in one of two ways:

1.  directly as the Content Encryption Key (CEK) for the "enc"
    algorithm, in the Direct Key Agreement mode, or

2.  as a symmetric key used to wrap the CEK with the "A128KW",
    "A192KW", or "A256KW" algorithms, in the Key Agreement with Key
    Wrapping mode.


A new :term:`ephemeral public key` value MUST 
be generated for each key agreement operation.

In Direct Key Agreement mode, 
the output of the Concat KDF MUST be a key of the same length 
as that used by the "enc" algorithm.  

In this case, 
the **empty octet sequence** is used as the JWE Encrypted Key value.  

The "alg" Header Parameter value "ECDH-ES" is used in the Direct Key Agreement mode.

.. note::
    - ダイレクトの場合、 JWE Encrypted Keyは空
    - つまり、PartyV は epk と 自分の static private で派生したキー(agreed upon key)をそのまま使って復号


In Key Agreement with Key Wrapping mode, 
the output of the Concat KDF MUST be a key of the length 
needed for the specified key wrapping algorithm.  

In this case, 
the JWE Encrypted Key is the CEK wrapped with the :term:`agreed upon key`.

.. note::
    - ラッピングの場合、 JWE Encrypted Key は  :term:`agreed upon key` で
      ラップされた CEK
    - つまり、PartyUはランダム作成した暗号化キーを epkのプライベートと PartyVのstatic public で派生したものでラップして
      Jweに添付
    - PartyVはagreed upon keyでラップをほどいてCEKを取り出して復号

The following "alg" (algorithm) Header Parameter values 
are used to indicate that 
the JWE Encrypted Key is the result of encrypting 
the CEK using the result of the key agreement algorithm 
as the key encryption key for the corresponding key wrapping algorithm:


+-------------------+-----------------------------------------------+
| alg Parameter     | Key Management Algorithm                      |
| Value             |                                               |
+-------------------+-----------------------------------------------+
| ECDH-ES+A128KW    | ECDH-ES using Concat KDF and CEK wrapped with |
|                   | "A128KW"                                      |
+-------------------+-----------------------------------------------+
| ECDH-ES+A192KW    | ECDH-ES using Concat KDF and CEK wrapped with |
|                   | "A192KW"                                      |
+-------------------+-----------------------------------------------+
| ECDH-ES+A256KW    | ECDH-ES using Concat KDF and CEK wrapped with |
|                   | "A256KW"                                      |
+-------------------+-----------------------------------------------+

(draft23)
