5.2.2.2. AES_CBC_HMAC_SHA2 Decryption
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The authenticated decryption operation has four inputs: 
K, A, E, and T as defined above.  

It has only a single output, 
either a plaintext value P or a special symbol FAIL that indicates 
that the inputs are not authentic.  

The authenticated decryption algorithm is as follows,
or uses an equivalent set of steps:

    1.  The secondary keys MAC_KEY and ENC_KEY are generated 
        from the input key K as in Step 1 of :ref:`Section 5.2.2.1 <jwa.5.2.21>`.
    
    2.  The integrity and authenticity of A and E are checked by
        computing an HMAC with the inputs as 
        in Step 5 of :ref:`Section 5.2.2.1 <jwa.5.2.2.1>`.  

        The value T, from the previous step, 
        is compared to the first MAC_KEY length bits of the HMAC output.  

        If those values are identical, 
        then A and E are considered valid,
        and processing is continued.  

        Otherwise, 
        all of the data used in the MAC validation are discarded, 
        and the AEAD decryption operation returns an indication 
        that it failed, and the operation halts.  

        (But see :ref:`Section 11.2 <jwe.11.2>` of [JWE] for security
        considerations on thwarting timing attacks.)
    
    3.  The value E is decrypted and the PKCS #7 padding is removed.  

        .. note::
            - PKCS#5 ではなくPKCS#7です

        The value IV is used as the initialization vector.  

        The value ENC_KEY is used as the decryption key.
    
    4.  The plaintext value is returned.
    
(draft28)

