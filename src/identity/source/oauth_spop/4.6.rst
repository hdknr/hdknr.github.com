
4.6.  Server verifies code_verifier before returning the tokens
------------------------------------------------------------------------------------------------

Upon receipt of the request at the Access Token endpoint, 
the server verifies it by calculating the code challenge 
from received "code_verifier" and comparing it 
with the previously associated "code_challenge", 
after first transforming it according to 
the "code_challenge_method" method specified by the client.

If the "code_challenge_method" from Section 4.2 was "S256", 
the received "code_verifier" is first hashed with SHA-256 
then compared to the base64url decoded "code_challenge". i.e.,

::

    SHA256("code_verifier" ) == BASE64URL-DECODE("code_challenge").

If the "code_challenge_method" from Section 4.2 was "plain", 
they are compared directly. i.e.,

::

    "code_challenge" == "code_verifier".

If the values are equal, the Access Token endpoint MUST 
continue processing as normal (as defined by OAuth 2.0 [RFC6749]).  
If the values are not equal, 
an error response indicating "invalid_grant" 
as described in :ref:`section 5.2 <oauth.5.2>` of OAuth 2.0 [RFC6749] MUST be returned.

(draft06)
