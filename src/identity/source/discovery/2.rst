.. _discovery.provider:

2.  OpenID Provider Discovery
==============================

OpenID Provider discovery is OPTIONAL; 
if a :term:`Relying Party` knows the OP information through an out-of-band mechanism, 
they can skip this step and proceed to :ref:`Section 4 <discovery.4>`.

Provider discovery requires the following information to make a discovery request:

.. glossary::

    resource
        Identifier of the target End-User that is the subject of the discovery request.

        .. note::
            対象ユーザーの識別子。 サブジェクト。

    host
        Server where a :doc:`WebFinger <webfinger>` service is hosted.
        

    rel
        URI identifying the type of service whose location is requested.

        .. note::
            クエリ対象のサービス

OpenID Connect uses the following discoverable :term:`rel` value 
in :doc:`WebFinger <webfinger>` [I‑D.ietf‑appsawg‑webfinger]:

.. _discovery.rel:

.. table:: 

    =====================   ============================================= 
    Rel Type                URI
    =====================   ============================================= 
    OpenID Connect Issuer   http://openid.net/specs/connect/1.0/issuer
    =====================   ============================================= 


To start discovery of OpenID endpoints, 
the End-User supplies an **Identifier** to the Relying Party. 

The RP applies :ref:`normalization rules to the Identifier <discover.normalization>` 
to determine the :term:`Resource` and :term:`Host`. 

Then it makes an HTTP GET request 
to the Host's :doc:`WebFinger <webfinger>` :term:`[RFC7033]` endpoint 
with the :term:`resource` and :term:`rel` parameters 
to obtain the location of the requested service. 

.. note::

    1. エンドユーザーが識別子をRPに入力
    2. 識別子を正規化し、そこから「リソース」と「ホスト」を決定 -> WebFinger
    3. ホストからWebFingerエンドポイントがわかるので( /.well-known/webfinger )、
       GETで resoruceとrel( :ref:`OpenID Issuer <discovery.rel>` )で問い合わせる。

All :doc:`WebFinger <webfinger>` communication MUST utilize TLS 
in the manner described in :ref:`Section 7.1 <discovery.7.1>`.


The :term:`Issuer location` MUST be returned in the WebFinger response 
as the value of the :term:`href` member of a links **array** element 
with :term:`rel` member value http://openid.net/specs/connect/1.0/issuer. 
(Per :ref:`Section 7 of WebFinger <webfinger.7>` :term:`[RFC7033]`, 
obtaining the WebFinger response may first involve following some redirects.)

The returned :term:`Issuer location` MUST be a URI RFC 3986 [RFC3986] 
with a :term:`scheme component` that MUST be **https**, 
a **host** component, 
and optionally, **port** and **path** components and **no query or fragment components**. 

Note that 
since the :term:`Host` and :term:`Resource` values determined 
from the user input Identifier, as described in :ref:`Section 2.1 <discovery.2.1>`, 
are used as input to a WebFinger request, 
which can return an Issuer value 
using a completely different scheme, host, port, and path, 
no relationship can be assumed 
between the user input Identifier string and the resulting Issuer location.


.. note::

    - User Input Identifier
    - Issuer Location
    - Issuer Identifier 
    - Authorization Endpoint

.. warning::
    - Provider Meta をキャッシュさせるのであれば、 
      User Iput Identiferを入力してDiscoveryさせるのではなく、
      OPをキャッシュ済のリストから選択させるようにした方がよい。

(draft21)
( http://openid.bitbucket.org/openid-connect-discovery-1_0.html#IssuerDiscovery)
