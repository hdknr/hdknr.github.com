# 2019-02-18

## Node: OAuth2

- [mulesoft/js-client-oauth2: A JavaScript implementation of an oauth2 client, for inclusion in the JavaScript client generator for APIs described with RAML.](https://github.com/mulesoft/js-client-oauth2)
- [serviejs/popsicle: Simple HTTP requests for node and the browser](https://github.com/serviejs/popsicle)

~~~bash
$ npm install client-oauth2 --save
.
~~~

## [ROPC](https://tools.ietf.org/html/rfc6749#section-4.3) サンプル

Playerが自分の情報(/me/)を確認する:

~~~js
var ClientOAuth2 = require('client-oauth2')
var popsicle = require('popsicle')
var username = 'tmpplayer'
var password = 'VahLie5p'
var cid = 'ZCrXi42......'
var csec = 'ARJAk0Y2dvq.....'
var host = 'http://localhost:9900'
var base = `${host}/accounts/oauth2`
var endpoint = `${host}/accounts/api/player/me/`

function me (token) {
  popsicle.request(token.sign({
    method: 'get',
    url: endpoint
  })).then(function (res) {
    console.log(token.accessToken, res.body)
  })
}

var server = new ClientOAuth2({
  clientId: cid,
  clientSecret: csec,
  accessTokenUri: `${base}/token/`,
  authorizationUri: `${base}/authorize/`,
  redirectUri: '',
  scopes: ['read', 'write']
})

// ROPC Flow
server.owner.getToken(username, password)
  .then(function (created) {
    me(created)
    created.refresh().then(function (updatedUser) {
      var refreshed = server.createToken(updatedUser.accessToken)
      me(refreshed)
    })
  })
~~~
