# 2019-02-03

## Django: モデルのディープコピー

models.py:

~~~py
from . import methods

class Order(models.Model, methods.Order):

    ....

class OrderItem(models.Model, methods.OrderItem):
    order = models.ForeignKey(Order)

    ....
~~~

methods.py:

~~~py
class Order(object):

    def clone(self, **params):
        excludes = ['id', '_state', ]
        source = dict((key, value) for key, value in vars(self).items() if key not in excludes)
        source.update(params)
        instance = self._meta.model.objects.create(**source)

        for oi in self.orderitem_set.all():
            oi.clone(order=instance)

        return instance

class OrderItem(object):

    def clone(self, order=None, **params):
        params['order'] = order or self.order   # 新しい親、もしくは既存の親
        excludes = ['id', '_state', 'order_id']
        source = dict((key, value) for key, value in vars(self).items() if key not in excludes)
        source.update(params)
        instance = self._meta.model.objects.create(**source)
        return instance
~~~

例:

~~~py
new_instance = Order.objects.get(id=35).clone()
~~~

## 朝

<iframe height='405' width='590' frameborder='0' allowtransparency='true' scrolling='no' src='https://www.strava.com/activities/2118104514/embed/6dbb6221e2e30cabfa2c35a57408af835b793296'></iframe>