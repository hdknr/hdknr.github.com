# 2019-01-19

## DRF: EndpointField

- [Serializer fields - Django REST framework](https://www.django-rest-framework.org/api-guide/fields/)
- [django-rest-framework/fields.py at master · encode/django-rest-framework](https://github.com/encode/django-rest-framework/blob/master/rest_framework/fields.py#L309)

app/utils/serializers.py:

~~~py
from django.urls import reverse
from rest_framework.fields import Field


def drf_endpoint(instance, url_name=None, pk_name='pk'):
    ''' DRF endpoint '''
    try:
        if hasattr(instance, 'get_endpoint_url'):
            return instance.get_endpoint_url()
        name = url_name or f"{instance._meta.model_name}-detail"
        return reverse(name, kwargs={pk_name: instance.pk})
    except:
        pass
    return ''


class EndpointField(Field):

    def __init__(self, **kwargs):
        kwargs['source'] = '*'
        kwargs['read_only'] = True
        self.url_name = kwargs.get('url_name', None)
        self.attr_name = kwargs.get('attr_name', None)
        super().__init__(**kwargs) 

    def to_representation(self, value):
        instance = self.attr_name and getattr(value, self.attr_name, None) or value
        url = drf_endpoint(instance, url_name=self.url_name)
        request = self.context.get('request', None)
        return request and request.build_absolute_uri(url) or url
~~~

例:

~~~py
from app.utils.serializers import EndpointField
from .. import models


class VideoSerializer(serializers.ModelSerializer):
    endpoint = EndpointField()

    class Meta:
        model = models.Video
        fields = '__all__'
~~~

## 朝散歩

<iframe height='405' width='590' frameborder='0' allowtransparency='true' scrolling='no' src='https://www.strava.com/activities/2087878613/embed/fa4df1bfbe40af19d92f7b40873bccebaadd12ca'></iframe>